<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>å•†ä¸šå¸å›½ï¼šåˆ›ä¸šæŠ½å¡ V2.7</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#111a33; --text:#eaf0ff; --muted:#a9b6dd;
      --good:#58e3a5; --bad:#ff6b6b; --warn:#ffd166; --line:rgba(255,255,255,.10);
      --accent:#7aa2ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:radial-gradient(1200px 600px at 30% 10%, rgba(122,162,255,.18), transparent 60%),
                 radial-gradient(900px 500px at 80% 30%, rgba(88,227,165,.14), transparent 60%),
                 var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Hiragino Sans GB,Microsoft YaHei,sans-serif;
    }
    header{position:sticky; top:0; z-index:10; background:rgba(11,16,32,.86); backdrop-filter: blur(10px); border-bottom:1px solid var(--line);}
    .wrap{max-width:1200px; margin:0 auto; padding:14px 12px;}
    .topbar{display:flex; gap:10px; align-items:center; justify-content:space-between;}
    .brand{display:flex; gap:10px; align-items:center; font-weight:900;}
    .mini{font-size:12px; color:var(--muted); line-height:1.35}
    .badge{font-size:12px; padding:4px 8px; border:1px solid var(--line); border-radius:999px; color:var(--muted);}
    .stats{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;}
    .pill{padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid var(--line); font-size:12px; color:var(--muted);}
    nav{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}
    .tab{padding:9px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.04); font-weight:800; font-size:13px; cursor:pointer; user-select:none;}
    .tab.active{background:rgba(122,162,255,.18); border-color:rgba(122,162,255,.35)}
    main{padding:14px 0 40px}
    .grid{display:grid; grid-template-columns: 1.25fr .75fr; gap:12px;}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{border:1px solid var(--line); background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)); border-radius:16px; padding:12px;}
    .card h3{margin:0 0 10px; font-size:14px; color:#dbe6ff; display:flex; align-items:center; justify-content:space-between;}
    .btn{border:1px solid var(--line); background:linear-gradient(180deg, rgba(122,162,255,.18), rgba(42,58,119,.22)); color:var(--text); padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:900; font-size:13px;}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:rgba(255,255,255,.04); font-weight:700;}
    .btn.good{background:linear-gradient(180deg, rgba(88,227,165,.20), rgba(88,227,165,.08)); border-color:rgba(88,227,165,.28);}
    .btn.warn{background:linear-gradient(180deg, rgba(255,209,102,.18), rgba(255,209,102,.08)); border-color:rgba(255,209,102,.25);}
    .btn.danger{background:linear-gradient(180deg, rgba(255,107,107,.18), rgba(255,107,107,.08)); border-color:rgba(255,107,107,.25);}
    .btn.small{padding:7px 10px; font-size:12px; border-radius:10px}
    .btnrow{display:flex; gap:8px; flex-wrap:wrap}
    input, select, textarea{width:100%; padding:10px 10px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text); outline:none; font-size:13px;}
    label{font-size:12px; color:var(--muted)}
    .formgrid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:600px){.formgrid{grid-template-columns:1fr}}
    .hr{height:1px; background:var(--line); margin:10px 0}
    .hint{font-size:12px; color:var(--muted); line-height:1.35; white-space:pre-wrap;}
    .list{display:flex; flex-direction:column; gap:10px}
    .person{border:1px solid var(--line); background:rgba(255,255,255,.03); border-radius:14px; padding:10px; display:grid; grid-template-columns: 60px 1fr; gap:10px; cursor:pointer;}
    .person:active{transform:translateY(1px)}
    .avatar{width:60px; height:60px; border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:24px; font-weight:900; background:rgba(122,162,255,.14); border:1px solid rgba(122,162,255,.20); overflow:hidden;}
    .avatar img{width:100%; height:100%; object-fit:cover; display:block;}
    .phead{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between;}
    .pname{font-weight:950; font-size:14px}
    .ptags{display:flex; gap:6px; flex-wrap:wrap}
    .tag{font-size:11px; padding:3px 7px; border-radius:999px; border:1px solid var(--line); color:var(--muted); background:rgba(255,255,255,.02);}
    .tag.good{color:var(--good); border-color:rgba(88,227,165,.25)}
    .tag.bad{color:var(--bad); border-color:rgba(255,107,107,.25)}
    .tag.warn{color:var(--warn); border-color:rgba(255,209,102,.25)}
    .bars{display:grid; grid-template-columns:1fr 1fr; gap:6px 10px; margin-top:8px;}
    @media (max-width:620px){.bars{grid-template-columns:1fr}}
    .bar{display:flex; align-items:center; justify-content:space-between; gap:8px; font-size:12px; color:var(--muted);}
    .meter{flex:1; height:8px; border-radius:999px; border:1px solid var(--line); background:rgba(255,255,255,.03); overflow:hidden;}
    .fill{height:100%; background:linear-gradient(90deg, rgba(122,162,255,.85), rgba(88,227,165,.85)); width:50%;}
    .log{max-height:460px; overflow:auto; padding-right:6px;}
    .logitem{border-left:3px solid rgba(122,162,255,.45); padding:8px 10px; border-radius:10px; background:rgba(255,255,255,.03); border:1px solid var(--line); margin-bottom:8px; font-size:13px; line-height:1.35; color:#dbe6ff;}
    .logitem.good{border-left-color:rgba(88,227,165,.55)}
    .logitem.bad{border-left-color:rgba(255,107,107,.55)}
    .logitem.warn{border-left-color:rgba(255,209,102,.55)}
    .kpi{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    @media (max-width:620px){.kpi{grid-template-columns:1fr}}
    .k{padding:10px; border-radius:14px; border:1px solid var(--line); background:rgba(255,255,255,.03);}
    .k .t{font-size:12px; color:var(--muted)}
    .k .v{font-size:18px; font-weight:950; margin-top:4px}
    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.70); z-index:9998; display:flex; align-items:center; justify-content:center; padding:14px;}
    .overbox{width:min(680px,100%); border-radius:18px; border:1px solid rgba(255,255,255,.18); background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03)); padding:14px;}
  
    .quick{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .qbtn{display:flex; align-items:center; gap:6px; padding:8px 10px; border-radius:999px;
          border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.05);
          color:var(--text); font-weight:800; font-size:13px}
    .qbtn:active{transform:translateY(1px)}
    .qbtn .ic{width:18px; text-align:center}
    .list{max-height:56vh; overflow:auto; border:1px solid rgba(255,255,255,.12); border-radius:14px; padding:8px; background:rgba(0,0,0,.18)}
    .item{padding:10px 10px; border-radius:12px; border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.04); margin:8px 0}
    .item .meta{display:flex; justify-content:space-between; gap:10px; color:var(--muted); font-size:12px}
    .item pre{white-space:pre-wrap; margin:8px 0 0 0; font-family:ui-sans-serif, system-ui; color:var(--text)}
    .chip{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px;
          border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.04); font-size:12px; color:var(--muted)}
    .field{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .input{flex:1; min-width:160px; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.14);
           background:rgba(0,0,0,.22); color:var(--text)}

  
    /* V2.7 UIå¢å¼º */
    .qbtn{display:flex;align-items:center;gap:8px}
    .qbtn .ic{width:22px;height:22px;display:flex;align-items:center;justify-content:center;border-radius:8px;background:rgba(255,255,255,.06);border:1px solid var(--line)}
    .person.ssr{border:1px solid rgba(255,209,102,.55); box-shadow:0 0 0 2px rgba(255,209,102,.18), 0 0 28px rgba(255,209,102,.20)}
    .rar-SSR{color:#ffe8a3;border-color:rgba(255,209,102,.45);background:rgba(255,209,102,.10)}
    .tag.player{color:#7aa2ff;border-color:rgba(122,162,255,.45);background:rgba(122,162,255,.10)}
    .avatarFrame{position:relative}
    .avatarFrame .spark{position:absolute;inset:-6px;pointer-events:none;opacity:0;transition:.2s}
    .person.ssr .avatarFrame .spark{opacity:1}
    .spark:before{content:"";position:absolute;inset:0;border-radius:18px;
      background:radial-gradient(circle at 20% 20%, rgba(255,209,102,.35), transparent 55%),
                 radial-gradient(circle at 80% 30%, rgba(122,162,255,.25), transparent 55%),
                 radial-gradient(circle at 30% 80%, rgba(88,227,165,.22), transparent 55%);
      filter:blur(2px)}
    .kpiGrid{display:grid;grid-template-columns:repeat(3, minmax(0,1fr));gap:10px}
    .kpi{padding:10px 12px;border-radius:14px;border:1px solid var(--line);background:rgba(255,255,255,.04)}
    .kpi .k{font-size:12px;color:var(--muted)}
    .kpi .v{font-size:16px;font-weight:900;margin-top:2px}
    .kpi .s{font-size:11px;color:var(--muted);margin-top:4px}

  
    /* V2.7ï¼šå¤´åƒå›¾åº“ / SSRä»ªå¼æ„Ÿ / è¯„åˆ†å¯è§†åŒ– / ç«äº‰å¯¹æ‰‹ */
    .modalFull{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.66);z-index:80}
    .modalFull.show{display:flex}
    .ceremony{width:min(520px,92vw);border-radius:24px;border:1px solid rgba(255,255,255,.10);background:rgba(12,18,34,.92);
      box-shadow:0 18px 60px rgba(0,0,0,.55);overflow:hidden;position:relative}
    .ceremony .top{padding:16px 16px 10px;display:flex;justify-content:space-between;align-items:center}
    .ceremony .name{font-weight:950;font-size:18px}
    .ceremony .rar{font-weight:950}
    .burst{position:absolute;inset:-40px;pointer-events:none;opacity:0;transform:scale(.85);transition:.28s}
    .burst.on{opacity:1;transform:scale(1)}
    .burst:before{content:"";position:absolute;inset:0;background:
      radial-gradient(circle at 50% 35%, rgba(255,209,102,.55), transparent 55%),
      radial-gradient(circle at 20% 70%, rgba(122,162,255,.35), transparent 55%),
      radial-gradient(circle at 80% 70%, rgba(88,227,165,.28), transparent 55%);}
    .ceremony .body{padding:10px 16px 18px}
    .bigAvatar{width:132px;height:132px;border-radius:22px;overflow:hidden;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);display:flex;align-items:center;justify-content:center;margin:10px auto 12px}
    .bigAvatar img{width:100%;height:100%;object-fit:cover;display:block}
    .bigAvatar .svg{width:100%;height:100%}
    .confetti{position:absolute;inset:0;pointer-events:none;opacity:0}
    .confetti.on{opacity:1;animation:fall 900ms ease-out forwards}
    @keyframes fall{0%{transform:translateY(-12px);opacity:0}20%{opacity:1}100%{transform:translateY(40px);opacity:0}}
    .scoreBars{display:grid;gap:10px;margin-top:10px}
    .bar{border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,.04);padding:10px 12px}
    .bar .row{display:flex;justify-content:space-between;align-items:center}
    .bar .lbl{font-size:12px;color:var(--muted)}
    .bar .val{font-weight:900}
    .bar .track{height:8px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);margin-top:8px;overflow:hidden}
    .bar .fill{height:100%;width:0%;background:linear-gradient(90deg, rgba(88,227,165,.85), rgba(122,162,255,.75));}
    .gallery{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    .avItem{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:rgba(255,255,255,.04);aspect-ratio:1/1;display:flex;align-items:center;justify-content:center}
    .avItem img{width:100%;height:100%;object-fit:cover}
    .avItem .svg{width:100%;height:100%}
    .rivalBadge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,106,106,.32);background:rgba(255,106,106,.10);font-weight:900}
    .rivalCard{border:1px solid rgba(255,106,106,.22);background:rgba(255,255,255,.03)}

  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div style="width:36px;height:36px;border-radius:12px;background:rgba(122,162,255,.18);display:flex;align-items:center;justify-content:center;border:1px solid rgba(122,162,255,.25)">ğŸ™ï¸</div>
        <div>
          å•†ä¸šå¸å›½ï¼šåˆ›ä¸šæŠ½å¡ <span class="badge">V2.7</span>
          <div class="mini">ç»è¥ï½œæŠ½å¡ï½œå†³ç­–ï½œè¡Œæƒ…ï½œå¯¹æ‰‹</div>
        </div>
      </div>
      <div class="stats" id="topStats"></div>
    </div>
    <nav id="tabs"></nav>
    <div class="quick" id="quickActions"></div>
  </div>
</header>

<main>
  <div class="wrap">
    <div id="view"></div>
  </div>
</main>

<script>
(() => {
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const rnd=(a,b)=>a+Math.random()*(b-a);
  const pick=(arr)=>arr[Math.floor(Math.random()*arr.length)];
  const roundHalf=(x)=>Math.round(x*2)/2;
  const todayStr=()=>{const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;}
  const fmtMoney=(n)=>{
    const sign=n<0?"-":"";
    n=Math.abs(n);
    if(n>=1e9)return sign+(n/1e9).toFixed(2)+"B";
    if(n>=1e6)return sign+(n/1e6).toFixed(2)+"M";
    if(n>=1e3)return sign+(n/1e3).toFixed(2)+"K";
    return sign+n.toFixed(0);
  };
  // V2.7ï¼šè§„æ¨¡/è¯„åˆ†/æœªæ¥ç»“ç®—å¯è§†åŒ–
  const activeStaff=()=>state.people.filter(p=>p.active&&!p.dead);
  const staffCount=()=>activeStaff().length; // ä¸å«ä¸»è§’
  const scaleLevel=()=>{
    const n=staffCount();
    return n>=26?5:n>=13?4:n>=7?3:n>=3?2:1;
  };
  const scaleName=(lvl)=>["","å¾®å‹","å°å‹","ä¸­å‹","å¤§å‹","å·¨å‹"][lvl]||"";
  const computeScore=()=>{
    // äººæ•°æƒé‡æ›´é«˜ï¼Œå…¶æ¬¡è§„æ¨¡ä¸èµ„äº§ï¼›èµ„äº§é‡‡ç”¨å¯¹æ•°é¿å…çˆ†è¡¨
    const n=staffCount();
    const lvl=scaleLevel();
    const assets=Math.max(-5_000_000, Math.min(50_000_000, state.company.assets||0));
    const aPos=Math.max(0, assets);
    const aNeg=Math.max(0, -assets);
    const head = n*18;               // äººæ•°ä¸»æƒé‡
    const scale = lvl*120;           // è§„æ¨¡
    const asset = Math.log10(1+aPos)*220 - Math.log10(1+aNeg)*180; // èµ„äº§æ­£è´Ÿéƒ½è®¡å…¥
    const stability = Math.max(0, (3-state.company.negativeStreak))*35; // è´Ÿèµ„äº§è¿æœˆæƒ©ç½š
    const raw = head + scale + asset + stability;
    return Math.max(0, Math.round(raw));
  };

  const computeScoreBreakdown=()=>{
    const n=staffCount();
    const lvl=scaleLevel();
    const assets=Math.max(-5_000_000, Math.min(50_000_000, state.company.assets||0));
    const aPos=Math.max(0, assets);
    const aNeg=Math.max(0, -assets);
    const head = n*18;
    const scale = lvl*120;
    const asset = Math.log10(1+aPos)*220 - Math.log10(1+aNeg)*180;
    const stability = Math.max(0, (3-state.company.negativeStreak))*35;
    const total = Math.max(0, Math.round(head+scale+asset+stability));
    return {total, head, scale, asset, stability, n, lvl, assets};
  };
  const sumAssetsEffect=(effects)=>{
    let s=0;
    for(const e of (effects||[])){
      if(e.kind==="assets") s += (e.amt ?? e.amount ?? 0);
    }
    return s;
  };
  const upcomingFlowBuckets=(monthsAhead=6)=>{
    const out=[];
    for(let i=0;i<monthsAhead;i++){
      const due = addMonths({y:state.company.year,m:state.company.month}, i+1);
      const items = (state.company.delayedEffects||[]).filter(d=>d.dueY===due.y && d.dueM===due.m);
      const amt = items.reduce((s,it)=>s+sumAssetsEffect(it.effects||[]),0);
      out.push({y:due.y,m:due.m,amt,items});
    }
    return out;
  };
  const upcomingFlowMini=()=>{
    const buckets=upcomingFlowBuckets(3);
    const plus=buckets.filter(b=>b.amt>0).reduce((s,b)=>s+b.amt,0);
    const minus=buckets.filter(b=>b.amt<0).reduce((s,b)=>s+b.amt,0);
    if(plus===0 && minus===0) return "æœªæ¥3æœˆ æ— å¾…ç»“ç®—";
    return `æœªæ¥3æœˆ å¾…ç»“ç®— ${plus>0?("+"+fmtMoney(plus)):"+0"} / ${minus<0?("-"+fmtMoney(-minus)):"-0"}`;
  };

  const addMonthsAbs=(y,m,add)=>{
    let yy=y, mm=m+add;
    while(mm>12){ mm-=12; yy++; }
    while(mm<1){ mm+=12; yy--; }
    return {y:yy, m:mm};
  };
  const isDue=(dueY,dueM,curY,curM)=> (dueY<curY) || (dueY===curY && dueM<=curM);

  const toast=(msg)=>{
    const t=el("div",{style:"position:fixed;left:50%;bottom:18px;transform:translateX(-50%);z-index:9999;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:rgba(0,0,0,.65);color:var(--text);font-weight:800;font-size:13px"},[msg]);
    document.body.appendChild(t);
    setTimeout(()=>{t.style.opacity="0"; t.style.transition="opacity .25s";},1200);
    setTimeout(()=>t.remove(),1600);
  };

  const showCeremony=(p)=>{
    const modal=document.getElementById("ceremonyModal");
    const burst=document.getElementById("burst");
    const conf=document.getElementById("confetti");
    const name=document.getElementById("cerName");
    const sub=document.getElementById("cerSub");
    const av=document.getElementById("cerAvatar");
    const text=document.getElementById("cerText");
    name.textContent = "SSR æ‹›å‹ŸæˆåŠŸï¼";
    sub.textContent = `${p.name} Â· ${positionName(p.position)} Â· ${p.gender==="M"?"ç”·":"å¥³"}`;
    av.innerHTML="";
    // render avatar
    const node = renderAvatar(p);
    if(node instanceof HTMLElement){
      if(node.tagName.toLowerCase()==="img") av.appendChild(node);
      else av.appendChild(node);
    } else {
      av.textContent="â­";
    }
    text.textContent = "ç¨€æœ‰è§’è‰²åŠ å…¥ï¼å»ºè®®å°½å¿«å®‰æ’å²—ä½ä¸ç›´å±å…³ç³»ï¼Œä»¥å‘æŒ¥æœ€å¤§æ”¶ç›Šã€‚";
    modal.classList.add("show");
    burst.classList.add("on");
    conf.classList.add("on");
    setTimeout(()=>conf.classList.remove("on"), 950);
  };
  const hideCeremony=()=>{
    const modal=document.getElementById("ceremonyModal");
    const burst=document.getElementById("burst");
    modal.classList.remove("show");
    burst.classList.remove("on");
  };
  window.addEventListener("DOMContentLoaded", ()=>{
    const btn=document.getElementById("cerClose");
    if(btn) btn.onclick=hideCeremony;
    const modal=document.getElementById("ceremonyModal");
    if(modal) modal.addEventListener("click",(e)=>{ if(e.target===modal) hideCeremony(); });
  });

  // äº‹ä»¶æ–‡æ¡ˆæ¨¡æ¿ï¼ˆV2.7ï¼šæ›´ä¸°å¯Œçš„å™äº‹ä¸ç»†èŠ‚ï¼‰
  const EVENT_TONE = {
    good: ["âœ¨","ğŸŒ¿","ğŸš€","ğŸŸ¢","ğŸ‰","ğŸ’¡"],
    warn: ["ğŸŸ ","ğŸ“°","ğŸŒ§ï¸","âš ï¸","ğŸ§©","ğŸ”"],
    bad:  ["ğŸ”»","â›ˆï¸","ğŸ§¨","ğŸŸ¥","ğŸ’¥","ğŸ•³ï¸"]
  };
  const emojiOf = (type)=>pick(EVENT_TONE[type]||["â€¢"]);
  const story = (type, title, lines)=>{
    const icon=emojiOf(type);
    return `${icon} ${title}\n` + lines.map(s=>"â€¢ "+s).join("\n");
  };
  const pickLine = (arr)=>arr[Math.floor(Math.random()*arr.length)];
  const descMarket = (m)=>{
    if(m>=1.25) return "èµ„é‡‘æ¶Œå…¥ï¼Œå®¢æˆ·é¢„ç®—æ”¾å¤§ï¼Œç«äº‰æ›´æ¿€çƒˆä½†æœºä¼šä¹Ÿæ›´å¤šã€‚";
    if(m>=1.05) return "éœ€æ±‚åæ—ºï¼Œå¢é•¿ç©ºé—´æ‰“å¼€ï¼ŒæŠ•æ”¾/æ‰©å¼ æ›´å®¹æ˜“è§æ•ˆã€‚";
    if(m>=0.95) return "æ•´ä½“å¹³ç¨³ï¼Œæ•ˆç‡ä¸ç»„ç»‡æ‰§è¡ŒåŠ›æ›´å…³é”®ã€‚";
    if(m>=0.80) return "éœ€æ±‚åå¼±ï¼Œå®¢æˆ·æ›´è°¨æ…ï¼Œå›æ¬¾å‘¨æœŸå¯èƒ½æ‹‰é•¿ã€‚";
    return "è¡Œä¸šå¯’å†¬ï¼Œç°é‡‘ä¸ºç‹ï¼Œè£æ’¤ä¸è½¬å‹çš„å‹åŠ›æ˜¾è‘—ä¸Šå‡ã€‚";
  };
  const randomNews = ()=>{
    const headlines=[
      "ç›‘ç®¡å£å¾„æ›´æ–°ï¼Œè¡Œä¸šåˆè§„æˆæœ¬ä¸Šå‡ã€‚",
      "å¤´éƒ¨ç«å“å‘å¸ƒæ–°åŠŸèƒ½ï¼Œå¸‚åœºå…³æ³¨åº¦è¢«å¸èµ°ä¸€éƒ¨åˆ†ã€‚",
      "æ¸ é“å¹³å°è°ƒæ•´æ¨èæœºåˆ¶ï¼Œè·å®¢æ–¹å¼éœ€è¦é‡æ–°é€‚é…ã€‚",
      "ä¸Šæ¸¸åŸææ–™ä»·æ ¼æ³¢åŠ¨ï¼Œä¾›åº”é“¾å¼€å§‹é‡æ–°è®®ä»·ã€‚",
      "èèµ„ç¯å¢ƒè½¬å†·ï¼ŒæŠ•èµ„äººæ›´çœ‹é‡ç°é‡‘æµã€‚",
      "æ¶ˆè´¹è€…åå¥½å˜åŒ–ï¼Œæ–°å“ç±»å†’å¤´ã€‚",
      "å‡ºæµ·æ”¿ç­–åˆ©å¥½ï¼Œæµ·å¤–è®¢å•è¯¢ç›˜å¢å¤šã€‚"
    ];
    return pickLine(headlines);
  };
  const opBuffFlavors = [
    "ä½ åœ¨å¤ç›˜ä¼šä¸ŠæŠŠå…³é”®æŒ‡æ ‡æ‹†åˆ°äº†æœ€å°ç²’åº¦ï¼Œå›¢é˜Ÿç»ˆäºçœ‹æ‡‚äº†å¢é•¿æ æ†ã€‚",
    "ä½ æŠŠä¸€å †â€œæ„Ÿè§‰â€å˜æˆäº†å¯éªŒè¯çš„å‡è®¾ï¼Œè¯•éªŒè¿›åº¦æ˜æ˜¾åŠ å¿«ã€‚",
    "ä½ æŠŠå®¢æˆ·åé¦ˆæŒ‰ç—›ç‚¹èšç±»ï¼Œäº§å“è·¯çº¿ç¬é—´æ¸…æ™°äº†ã€‚",
    "ä½ äº²è‡ªä¸Šé˜µè·Ÿè¿›é”€å”®æ¼æ–—ï¼Œæˆäº¤èŠ‚å¥å˜å¾—æ›´ç¨³å®šã€‚",
    "ä½ ç”¨ä¸€ä¸ªå°å·¥å…·è‡ªåŠ¨åŒ–äº†é‡å¤å·¥ä½œï¼Œå¤§å®¶éƒ½æ¾äº†ä¸€å£æ°”ã€‚"
  ];
  const opDebuffFlavors = [
    "ä½ è¢«å„ç§æ‚äº‹æ‰“æ–­ï¼Œé‡è¦çš„å†³ç­–è¿Ÿè¿Ÿæ²¡æœ‰è½åœ°ã€‚",
    "ä¸€æ¬¡æ²Ÿé€šè¯¯ä¼šè®©å›¢é˜Ÿè¿”å·¥ï¼Œå¤§å®¶çš„è€å¿ƒè¢«ç£¨æ‰äº†ä¸€äº›ã€‚",
    "ä½ ä½ä¼°äº†æ‰§è¡Œéš¾åº¦ï¼Œç›®æ ‡å®šå¾—å¤ªæ»¡ï¼Œç„¦è™‘å¼€å§‹è”“å»¶ã€‚",
    "ä½ åœ¨å…³é”®èŠ‚ç‚¹çŠ¹è±«ï¼Œé”™è¿‡äº†ä¸€ä¸ªçª—å£æœŸã€‚",
    "ä½ è¢«å¤–ç•Œå™ªéŸ³ç‰µç€èµ°ï¼Œè·¯çº¿å¼€å§‹æ‘‡æ‘†ã€‚"
  ];
  const loveGoodFlavors = [
    "ä»–ä»¬åœ¨åŠ ç­åä¸€èµ·åƒäº†å¤œå®µï¼Œå›ç¨‹è·¯ä¸ŠæŠŠå¾ˆå¤šå¿ƒç»“èŠå¼€äº†ã€‚",
    "ä¸€æ¬¡è·¨éƒ¨é—¨åä½œæ„å¤–é¡ºç•…ï¼Œé»˜å¥‘è®©ä»–ä»¬é å¾—æ›´è¿‘ã€‚",
    "ä»–ä»¬ä¸»åŠ¨æŠŠå·¥ä½œè¾¹ç•Œè°ˆæ¸…æ¥šï¼Œå…³ç³»å˜å¾—æ›´æˆç†Ÿã€‚"
  ];
  const loveBadFlavors = [
    "é¡¹ç›®å‹åŠ›æŠŠæƒ…ç»ªæ”¾å¤§ï¼Œå°çŸ›ç›¾å‡çº§æˆäº‰åµã€‚",
    "åŠå…¬å®¤æµè¨€èœšè¯­è®©åŒæ–¹éƒ½ä¸èˆ’æœï¼Œæ²Ÿé€šå˜å¾—å°å¿ƒç¿¼ç¿¼ã€‚",
    "ä¸€æ¬¡è¯¯ä¼šæ²¡åŠæ—¶è§£é‡Šï¼Œå†·æˆ˜å¼€å§‹æ‹–é•¿ã€‚"
  ];
  const layoffFlavors = [
    "ç¤¾äº¤å¹³å°å‡ºç°äº†å‡ æ¡è´Ÿé¢è®¨è®ºï¼Œæ½œåœ¨å€™é€‰äººå¼€å§‹è§‚æœ›ã€‚",
    "å®¢æˆ·å¬åˆ°è£å‘˜æ¶ˆæ¯åæ›´è°¨æ…ï¼Œéƒ¨åˆ†è®¢å•å»¶æœŸç¡®è®¤ã€‚",
    "å†…éƒ¨å£«æ°”å—åˆ°å½±å“ï¼Œå…³é”®å²—ä½çš„ç¦»èŒé£é™©ä¸Šå‡ã€‚"
  ];
  const crisisFlavors = {
    stock: ["æŒ‡æ•°è·³æ°´ï¼Œé£é™©åå¥½éª¤é™ã€‚","èèµ„çª—å£æ”¶çª„ï¼Œç°é‡‘æµè¢«æ”¾åˆ°æ˜¾å¾®é•œä¸‹ã€‚","å®¢æˆ·é¢„ç®—å†»ç»“ï¼Œé‡‡è´­å®¡æ‰¹å˜æ…¢ã€‚"],
    geo:   ["å¤–éƒ¨æ‘©æ“¦å‡çº§ï¼Œè·¨å¢ƒä¸šåŠ¡å—é™ã€‚","æ±‡ç‡æ³¢åŠ¨åŠ å‰§ï¼Œç»“ç®—æˆæœ¬ä¸Šå‡ã€‚","ä¾›åº”é“¾ä¸ç¡®å®šæ€§æå‡ï¼Œäº¤ä»˜å‘¨æœŸæ‹‰é•¿ã€‚"],
    family:["æƒ…ç»ªè¢«ç‰µåŠ¨ï¼Œæ³¨æ„åŠ›å¾ˆéš¾é›†ä¸­ã€‚","è¯·å‡ä¸ä¸´æ—¶äº¤æ¥è®©è¿›åº¦è¢«æ‰“æ–­ã€‚","å›¢é˜Ÿè‡ªå‘åˆ†æ‹…å·¥ä½œï¼Œç»„ç»‡å‡èšåŠ›è¢«è€ƒéªŒã€‚"],
    sick:  ["åŒ»ç–—ä¸è¯·å‡æˆæœ¬å åŠ ï¼ŒèŠ‚å¥è¢«è¿«æ”¾æ…¢ã€‚","å…³é”®ä»»åŠ¡éœ€è¦é‡æ–°åˆ†é…ï¼Œåä½œæˆæœ¬ä¸Šå‡ã€‚","åŒäº‹ä»¬æƒ…ç»ªä½è½ï¼Œæ²Ÿé€šæ›´æ•æ„Ÿã€‚"],
    death: ["å›¢é˜Ÿå—åˆ°å¼ºçƒˆå†²å‡»ï¼Œæƒ…ç»ªéœ€è¦æ—¶é—´æ¶ˆåŒ–ã€‚","å…³é”®çŸ¥è¯†ä¸äº¤æ¥ç¼ºå£éœ€è¦ç«‹åˆ»å¡«è¡¥ã€‚","ä½ ä¸å¾—ä¸é‡æ–°è°ƒæ•´ç»„ç»‡ä¸ç›®æ ‡ã€‚"]
  };

  // å†³ç­–äº‹ä»¶ï¼ˆV2.7ï¼‰ï¼šA/B/C å¤šé€‰é¡¹ï¼Œä¸åŒæˆæœ¬/æ¦‚ç‡/åæœï¼›å«è¡Œä¸šä¸“å±äº‹ä»¶åŒ…
  const EFFECT = {
    assets:(amt)=>({kind:"assets", amt}),
    playerAb:(k,delta)=>({kind:"playerAb", k, delta}),
    worldMarket:(indKey,delta)=>({kind:"worldMarket", indKey, delta}),
    moraleBuff:(months)=>({kind:"moraleBuff", months}),
    // å»¶è¿Ÿç»“ç®—ï¼šdelayMä¸ªæœˆåæ‰§è¡Œeffectsï¼Œå¹¶è®°å½•ä¸€æ¡æ¡£æ¡ˆ
    delayed:(delayM,label,effects)=>({kind:"delayed", delayM, label, effects}),
    // äº‹ä»¶é“¾ï¼šdelayMä¸ªæœˆåè§¦å‘æŒ‡å®šå†³ç­–äº‹ä»¶
    scheduleEvent:(delayM,eventId)=>({kind:"scheduleEvent", delayM, eventId}),
  };

  // FXï¼šç»™äº‹ä»¶é“¾/å¡«å……äº‹ä»¶ä½¿ç”¨çš„ç®€å†™ï¼ˆä¸EFFECTä¿æŒä¸€è‡´ï¼‰
  const FX = {
    assets:(amt)=>EFFECT.assets(amt),
    playerAb:(k,delta)=>EFFECT.playerAb(k,delta),
    worldMarket:(indKey,delta)=>EFFECT.worldMarket(indKey,delta),
    moraleBuff:(months)=>EFFECT.moraleBuff(months),
    delayed:(delayM,label,effects)=>EFFECT.delayed(delayM,label,effects),
    scheduleEvent:(delayM,eventId)=>EFFECT.scheduleEvent(delayM,eventId),
  };

  const applyEffects=(effects, meta={})=>{
    for(const e of (effects||[])){
      if(e.kind==="assets") state.company.assets = Math.round(state.company.assets + e.amt);
      else if(e.kind==="playerAb"){
        const before=state.player.abilities[e.k];
        state.player.abilities[e.k]=roundHalf(clamp(before+e.delta,1,10));
      }else if(e.kind==="worldMarket"){
        const before=industryMarket(e.indKey);
        state.company.worldMarkets[e.indKey]=clamp(roundHalf(before+e.delta),0.6,1.4);
      }else if(e.kind==="moraleBuff"){
        state.company.moraleBuffMonths = Math.max(state.company.moraleBuffMonths||0, e.months);
      }else if(e.kind==="delayed"){
        const due = addMonthsAbs(state.company.year, state.company.month, e.delayM);
        state.company.delayedEffects.push({
          dueY: due.y, dueM: due.m,
          label: e.label||"å»¶è¿Ÿç»“ç®—",
          effects: e.effects||[],
          from: meta.from||""
        });
      }else if(e.kind==="scheduleEvent"){
        const due = addMonthsAbs(state.company.year, state.company.month, e.delayM);
        state.company.scheduledEvents.push({
          dueY: due.y, dueM: due.m,
          eventId: e.eventId,
          from: meta.from||""
        });
      }
    }
  };
  const roll=(p)=>Math.random()<p;

  // äº‹ä»¶é“¾èŠ‚ç‚¹æ˜ å°„ï¼ˆid -> nodeï¼‰
  const DECISION_EVENT_MAP = {};

  const DECISION_EVENTS = {
    generic: [
      {
        id:"pr_pitch",
        title:"èèµ„è·¯æ¼”ï¼šä¸€å°æ—¶æ”¹å˜å‘½è¿",
        desc:[
          "æŠ•èµ„äººè¯´ä»–ä»¬å–œæ¬¢ä½ çš„æ–¹å‘ï¼Œä½†æƒ³çœ‹æ›´ç¡¬çš„å¢é•¿è¯æ®ã€‚",
          "ä½ å¯ä»¥é€‰æ‹©æ›´æ¿€è¿›çš„æ‰“æ³•ï¼Œä¹Ÿå¯ä»¥æ›´ç¨³åœ°åšäº§å“ä¸ç°é‡‘æµã€‚"
        ],
        options:[
          {key:"A", label:"åŠ å¤§æŠ•æ”¾+è¡¥è´´ï¼Œå†²ä¸€æ³¢å¢é•¿ï¼ˆæˆæœ¬é«˜ï¼Œå¯èƒ½çˆ†ï¼‰", cost:9000, p:0.55,
           suc:[EFFECT.assets(+22000), EFFECT.playerAb("è¡ŒåŠ¨åŠ›",+0.5), EFFECT.moraleBuff(2)],
           fail:[EFFECT.assets(-14000), EFFECT.playerAb("æ´å¯ŸåŠ›",-0.5)]},
          {key:"B", label:"æŠŠæŒ‡æ ‡åšæ‰å®ï¼Œå…ˆè·‘é€šç•™å­˜ï¼ˆç¨³å¥ï¼‰", cost:4000, p:0.75,
           suc:[EFFECT.assets(+9000), EFFECT.playerAb("ç®¡ç†èƒ½åŠ›",+0.5)],
           fail:[EFFECT.assets(-3000)]},
          {key:"C", label:"æ‹’ç»è¿™è½®ï¼Œä¸“æ³¨ç°é‡‘æµï¼ˆçŸ­ç—›æ¢é•¿æœŸï¼‰", cost:0, p:0.85,
           suc:[EFFECT.assets(+4000), EFFECT.playerAb("æ´å¯ŸåŠ›",+0.5)],
           fail:[EFFECT.playerAb("è¡ŒåŠ¨åŠ›",-0.5)]},
        ]
      },
      {
        id:"pr_crisis",
        title:"å…¬å…³é£æ³¢ï¼šä¸€å¥è¯å¼•å‘è¯¯è§£",
        desc:[
          "ç¤¾äº¤åª’ä½“å‡ºç°äº†å…³äºä½ ä»¬çš„è¯¯è¯»ï¼Œè®¨è®ºæ­£åœ¨æ‰©æ•£ã€‚",
          "ä½ è¦é€‰ï¼šå¼ºåŠ¿åå‡»ã€æ¸©å’Œæ¾„æ¸…ã€è¿˜æ˜¯æš‚æ—¶æ²‰é»˜ã€‚"
        ],
        options:[
          {key:"A", label:"å¼ºåŠ¿å›åº”+å¾‹å¸ˆå‡½ï¼ˆæœ‰éœ‡æ…‘ä½†æ˜“åå™¬ï¼‰", cost:6000, p:0.58,
           suc:[EFFECT.assets(+6000), EFFECT.playerAb("é¢†å¯¼èƒ½åŠ›",+0.5)],
           fail:[EFFECT.assets(-12000), EFFECT.playerAb("æƒ…å•†",-0.5)]},
          {key:"B", label:"æ¸©å’Œæ¾„æ¸…+å¼€æ”¾é‡‡è®¿ï¼ˆæ›´å¯ä¿¡ï¼‰", cost:3500, p:0.78,
           suc:[EFFECT.assets(+4500), EFFECT.playerAb("æƒ…å•†",+0.5), EFFECT.moraleBuff(2)],
           fail:[EFFECT.assets(-3000)]},
          {key:"C", label:"æš‚æ—¶æ²‰é»˜ï¼Œä¸“æ³¨äº¤ä»˜ï¼ˆçœé’±ä½†ä¼šè¢«è§£è¯»ï¼‰", cost:0, p:0.62,
           suc:[EFFECT.playerAb("ä¸“ä¸šèƒ½åŠ›",+0.5)],
           fail:[EFFECT.assets(-6000)]},
        ]
      }
    ],
    byIndustry: {
      food:[
        { id:"fd_supplier", title:"ä¾›åº”å•†æ¶¨ä»·ï¼šåŸææ–™è¦ä¸è¦æ¢ï¼Ÿ",
          desc:["ä¸Šæ¸¸çªç„¶æ¶¨ä»·ï¼Œæ¯›åˆ©è¢«å‹ç¼©ã€‚","ä½ å¯ä»¥æ¢ä¾›åº”å•†ã€æä»·ã€æˆ–ä¼˜åŒ–èœå•ã€‚"],
          options:[
            {key:"A", label:"ç´§æ€¥æ›´æ¢ä¾›åº”å•†ï¼ˆé£é™©ï¼šå“è´¨æ³¢åŠ¨ï¼‰", cost:3000, p:0.62,
             suc:[EFFECT.assets(+8000), EFFECT.playerAb("è¡ŒåŠ¨åŠ›",+0.5)],
             fail:[EFFECT.assets(-7000), EFFECT.playerAb("ç®¡ç†èƒ½åŠ›",-0.5)]},
            {key:"B", label:"å°å¹…æä»·+è®²å¥½æ•…äº‹ï¼ˆæ›´ç¨³ï¼‰", cost:1200, p:0.76,
             suc:[EFFECT.assets(+5000), EFFECT.playerAb("æƒ…å•†",+0.5)],
             fail:[EFFECT.assets(-2000)]},
            {key:"C", label:"ä¼˜åŒ–èœå•/å‡å°‘æŸè€—ï¼ˆæ…¢çƒ­ä½†æ‰å®ï¼‰", cost:800, p:0.82,
             suc:[EFFECT.assets(+4500), EFFECT.playerAb("ç®¡ç†èƒ½åŠ›",+0.5)],
             fail:[EFFECT.playerAb("è¡ŒåŠ¨åŠ›",-0.5)]},
          ]
        }
      ],
      tech:[
        { id:"tc_outage", title:"çº¿ä¸Šæ•…éšœï¼šå®•æœº 30 åˆ†é’Ÿ",
          desc:["ç›‘æ§æŠ¥è­¦çˆ†ç‚¸ï¼Œç”¨æˆ·åœ¨è¯„è®ºåŒºå¼€å–·ã€‚","ä½ è¦é€‰ï¼šç«‹åˆ»èµ”ä»˜ã€æŠ€æœ¯æ”»åšã€è¿˜æ˜¯å…ˆå‹çƒ­æœã€‚"],
          options:[
            {key:"A", label:"å…¨é‡è¡¥å¿ï¼ˆæˆæœ¬é«˜ï¼Œå£ç¢‘å›å‡ï¼‰", cost:7000, p:0.75,
             suc:[EFFECT.assets(+6000), EFFECT.playerAb("é¢†å¯¼èƒ½åŠ›",+0.5), EFFECT.moraleBuff(2)],
             fail:[EFFECT.assets(-6000)]},
            {key:"B", label:"é›†ä¸­æ”»åš+å¤ç›˜æœºåˆ¶ï¼ˆæå‡ç»„ç»‡ï¼‰", cost:2500, p:0.80,
             suc:[EFFECT.assets(+4500), EFFECT.playerAb("ç®¡ç†èƒ½åŠ›",+0.5)],
             fail:[EFFECT.assets(-3000)]},
            {key:"C", label:"å…ˆå…¬å…³é™æ¸©ï¼ˆçœé’±ä½†å¯èƒ½åå™¬ï¼‰", cost:800, p:0.60,
             suc:[EFFECT.playerAb("æ´å¯ŸåŠ›",+0.5)],
             fail:[EFFECT.assets(-8000), EFFECT.playerAb("æƒ…å•†",-0.5)]},
          ]
        }
      ],
      edu:[
        { id:"ed_policy", title:"æ”¿ç­–é£å‘ï¼šåˆè§„è¦æ±‚åŠ ä¸¥",
          desc:["ç›‘ç®¡å£å¾„æ›´æ–°ï¼Œå®£ä¼ ä¸æ”¶è´¹æ–¹å¼éƒ½è¦æ›´è°¨æ…ã€‚","ä½ è¦é€‰ï¼šå…¨é¢æ•´æ”¹ã€å±€éƒ¨è°ƒæ•´ã€æˆ–è§‚æœ›ã€‚"],
          options:[
            {key:"A", label:"å…¨é¢æ•´æ”¹ï¼ˆçŸ­æœŸç—›ï¼Œé•¿æœŸç¨³ï¼‰", cost:5000, p:0.82,
             suc:[EFFECT.assets(+6000), EFFECT.playerAb("æ´å¯ŸåŠ›",+0.5)],
             fail:[EFFECT.assets(-3000)]},
            {key:"B", label:"å±€éƒ¨è°ƒæ•´ï¼ˆå¹³è¡¡æˆæœ¬ï¼‰", cost:2500, p:0.72,
             suc:[EFFECT.assets(+4000), EFFECT.playerAb("ç®¡ç†èƒ½åŠ›",+0.5)],
             fail:[EFFECT.assets(-3500)]},
            {key:"C", label:"è§‚æœ›ï¼ˆçœé’±ä½†é£é™©ï¼‰", cost:0, p:0.58,
             suc:[EFFECT.assets(+2000)],
             fail:[EFFECT.assets(-9000)]},
          ]
        }
      ],
      manu:[
        { id:"mn_quality", title:"è´¨é‡æŠ½æ£€ï¼šä¸€æ‰¹è´§è¢«é€€å›",
          desc:["å®¢æˆ·åé¦ˆç‘•ç–µï¼Œå¯èƒ½è¦è¿”å·¥ã€‚","ä½ è¦é€‰ï¼šå¬å›è¿”å·¥ã€æŠ˜ä»·å¤„ç†ã€æˆ–å¼ºç¡¬æ²Ÿé€šã€‚"],
          options:[
            {key:"A", label:"å¬å›è¿”å·¥ï¼ˆæˆæœ¬é«˜ï¼Œä¿¡èª‰æ›´ç¨³ï¼‰", cost:8000, p:0.74,
             suc:[EFFECT.assets(+9000), EFFECT.playerAb("ä¸“ä¸šèƒ½åŠ›",+0.5)],
             fail:[EFFECT.assets(-7000)]},
            {key:"B", label:"æŠ˜ä»·å¤„ç†ï¼ˆæ­¢è¡€ï¼‰", cost:2500, p:0.70,
             suc:[EFFECT.assets(+5000), EFFECT.playerAb("ç®¡ç†èƒ½åŠ›",+0.5)],
             fail:[EFFECT.assets(-4500)]},
            {key:"C", label:"å¼ºç¡¬æ²Ÿé€šï¼ˆçœé’±ä½†é£é™©ï¼‰", cost:600, p:0.55,
             suc:[EFFECT.assets(+3000), EFFECT.playerAb("é¢†å¯¼èƒ½åŠ›",+0.5)],
             fail:[EFFECT.assets(-11000), EFFECT.playerAb("æƒ…å•†",-0.5)]},
          ]
        }
      ],
      ret:[
        {
          id:"ret_flashsale",
          title:"å¤§ä¿ƒèŠ‚ç‚¹ï¼šè¦ä¸è¦æ‰“â€œé—ªä¿ƒâ€",
          desc:[
            "å¹³å°ç»™äº†ä½ ä¸€ä¸ªé»„é‡‘å‘ä½ï¼Œä½†éœ€è¦é…åˆæ›´æ¿€è¿›çš„æŠ˜æ‰£ä¸æŠ•æ”¾ã€‚",
            "è¿™å¯èƒ½å¸¦æ¥çˆ†é‡ï¼Œä¹Ÿå¯èƒ½æŠŠåˆ©æ¶¦æ‰“è–„ç”šè‡³å¼•å‘å·®è¯„ã€‚"
          ],
          options:[
            {key:"A", label:"å†²é¡¶æµé‡ï¼šé‡è¡¥è´´+å¼ºæŠ•æ”¾ï¼ˆå›æŠ¥å»¶è¿Ÿï¼Œæ³¢åŠ¨å¤§ï¼‰", cost:12000, p:0.60,
             suc:[EFFECT.delayed(2,"å¤§ä¿ƒå›æµè®¢å•", [EFFECT.assets(+38000)]), EFFECT.playerAb("æ´å¯ŸåŠ›",+0.5)],
             fail:[EFFECT.assets(-9000), EFFECT.playerAb("æƒ…å•†",-0.5)]},
            {key:"B", label:"ç¨³å¥ä¿ƒé”€ï¼šæ§æŠ˜æ‰£ã€åšä¼šå‘˜å¤è´­", cost:5000, p:0.75,
             suc:[EFFECT.assets(+11000), EFFECT.playerAb("ç®¡ç†èƒ½åŠ›",+0.5)],
             fail:[EFFECT.assets(-2500)]},
            {key:"C", label:"æ”¾å¼ƒå‘ä½ï¼šä¿åˆ©æ¶¦ä¸å£ç¢‘", cost:0, p:0.85,
             suc:[EFFECT.assets(+2500), EFFECT.playerAb("æ´å¯ŸåŠ›",+0.5)],
             fail:[EFFECT.worldMarket("ret",-0.5)]},
          ],
        },
        {
          id:"ret_supply",
          title:"ä¾›è´§å±æœºï¼šçˆ†å•è¿˜æ˜¯æ–­è´§",
          desc:["çˆ†æ¬¾çªç„¶çˆ†å•ï¼Œä¸Šæ¸¸è¯´æœ€å¿«ä¹Ÿè¦ä¸¤å‘¨è¡¥è´§ã€‚","ä½ éœ€è¦åœ¨ç°é‡‘ã€å£ç¢‘ä¸äº¤ä»˜ä¹‹é—´åšé€‰æ‹©ã€‚"],
          options:[
            {key:"A", label:"é«˜ä»·ç©ºè¿è¡¥è´§ï¼ˆè´µä½†ä¿å£ç¢‘ï¼‰", cost:8000, p:0.75,
             suc:[EFFECT.assets(+16000), EFFECT.playerAb("è¡ŒåŠ¨åŠ›",+0.5)],
             fail:[EFFECT.assets(-6000)]},
            {key:"B", label:"é¢„å”®æ’é˜Ÿï¼ˆè§£é‡Šæ¸…æ¥šï¼Œæ¥å—å»¶è¿Ÿï¼‰", cost:1200, p:0.70,
             suc:[EFFECT.delayed(1,"é¢„å”®å°¾æ¬¾åˆ°è´¦", [EFFECT.assets(+9000)]), EFFECT.playerAb("æƒ…å•†",+0.5)],
             fail:[EFFECT.assets(-4000), EFFECT.playerAb("é¢†å¯¼èƒ½åŠ›",-0.5)]},
            {key:"C", label:"ç æ‰æ´»åŠ¨ï¼ˆæ­¢æŸï¼‰", cost:0, p:0.80,
             suc:[EFFECT.assets(+1500), EFFECT.playerAb("ç®¡ç†èƒ½åŠ›",+0.5)],
             fail:[EFFECT.assets(-2500)]},
          ],
        }
      ],
      bio:[
        {
          id:"bio_trial",
          title:"ä¸´åºŠè¯•éªŒï¼šä¼¦ç†ä¸é€Ÿåº¦çš„æ‹‰æ‰¯",
          desc:["åˆä½œåŒ»é™¢æ„¿æ„ç»™ä½ ç»¿è‰²é€šé“ï¼Œä½†è¦æ±‚æ›´ä¸¥æ ¼çš„æ•°æ®ä¸æµç¨‹ã€‚","ä½ å¯ä»¥æŠ•å…¥æ›´å¤šèµ„æºåŠ é€Ÿï¼Œä¹Ÿå¯ä»¥ç¨³æ‰ç¨³æ‰“ã€‚"],
          options:[
            {key:"A", label:"åŠ ç æŠ•å…¥ï¼šè¯·CRO+åŠ ç­æ¨è¿›ï¼ˆå›æŠ¥å»¶è¿Ÿï¼‰", cost:15000, p:0.60,
             suc:[EFFECT.delayed(3,"è¯•éªŒé˜¶æ®µæ€§é‡Œç¨‹ç¢‘æ¬¾", [EFFECT.assets(+52000)]), EFFECT.playerAb("ä¸“ä¸šèƒ½åŠ›",+0.5)],
             fail:[EFFECT.assets(-12000), EFFECT.playerAb("ç®¡ç†èƒ½åŠ›",-0.5)]},
            {key:"B", label:"ç¨³å¥æ¨è¿›ï¼šæŠŠæµç¨‹è¡¥é½", cost:6000, p:0.78,
             suc:[EFFECT.delayed(2,"é‡Œç¨‹ç¢‘æ¬¾ï¼ˆè¾ƒå°ï¼‰", [EFFECT.assets(+22000)]), EFFECT.playerAb("æ´å¯ŸåŠ›",+0.5)],
             fail:[EFFECT.assets(-4500)]},
            {key:"C", label:"æš‚ç¼“è¯•éªŒï¼šå…ˆåšå•†ä¸šéªŒè¯", cost:0, p:0.82,
             suc:[EFFECT.assets(+4000), EFFECT.playerAb("å­¦ä¹ èƒ½åŠ›",+0.5)],
             fail:[EFFECT.worldMarket("bio",-0.5)]},
          ],
        },
        {
          id:"bio_patent",
          title:"ä¸“åˆ©çª—å£ï¼šè¦ä¸è¦ç°åœ¨æäº¤",
          desc:["ç«äº‰å¯¹æ‰‹çš„åŠ¨å‘ä¸æ˜ï¼Œä½ æ‹…å¿ƒè¢«æŠ¢å…ˆã€‚","ä½†æäº¤ä¸“åˆ©ä¼šæ¶ˆè€—ç°é‡‘ä¸ç²¾åŠ›ã€‚"],
          options:[
            {key:"A", label:"é©¬ä¸Šæäº¤ï¼ˆæŠ¢æ—¶é—´ï¼‰", cost:9000, p:0.70,
             suc:[EFFECT.playerAb("æ´å¯ŸåŠ›",+0.5), EFFECT.scheduleEvent(2,"bio_licensing")],
             fail:[EFFECT.assets(-5000)]},
            {key:"B", label:"å…ˆåšæ›´å®Œæ•´çš„å®éªŒæ•°æ®", cost:3500, p:0.75,
             suc:[EFFECT.playerAb("ä¸“ä¸šèƒ½åŠ›",+0.5), EFFECT.delayed(2,"ä¸“åˆ©ç”³è¯·å¸¦æ¥çš„BDæœºä¼š", [EFFECT.assets(+14000)])],
             fail:[EFFECT.playerAb("è¡ŒåŠ¨åŠ›",-0.5)]},
            {key:"C", label:"æŒ‰å…µä¸åŠ¨ï¼ˆçœé’±ä½†æœ‰é£é™©ï¼‰", cost:0, p:0.80,
             suc:[EFFECT.assets(+1500)],
             fail:[EFFECT.worldMarket("bio",-0.5)]},
          ],
        },
        {
          id:"bio_licensing",
          title:"æˆæƒè°ˆåˆ¤ï¼šå¤§å…¬å¸æƒ³è¦æ›´ä½åˆ†æˆ",
          desc:["å¯¹æ–¹æ„¿æ„ç»™ä½ æ¸ é“ä¸èƒŒä¹¦ï¼Œä½†å‹ä»·å¾ˆç‹ ã€‚","ä½ è¦åœ¨ç°é‡‘æµä¸é•¿æœŸåˆ©ç›Šä¹‹é—´é€‰æ‹©ã€‚"],
          options:[
            {key:"A", label:"æ¥å—ï¼šæ‹¿ç°é‡‘ï¼Œæ¢èµ„æº", cost:0, p:0.80,
             suc:[EFFECT.assets(+26000), EFFECT.playerAb("æƒ…å•†",+0.5)],
             fail:[EFFECT.assets(-4000)]},
            {key:"B", label:"åšæŒï¼šæé«˜åˆ†æˆï¼ˆå¯èƒ½è°ˆå´©ï¼‰", cost:1200, p:0.55,
             suc:[EFFECT.delayed(2,"æ›´é«˜åˆ†æˆå›æ¬¾", [EFFECT.assets(+34000)]), EFFECT.playerAb("é¢†å¯¼èƒ½åŠ›",+0.5)],
             fail:[EFFECT.assets(-8000)]},
            {key:"C", label:"æ¢ä¼™ä¼´ï¼šæ‰¾ç¬¬äºŒå®¶è°ˆ", cost:2500, p:0.65,
             suc:[EFFECT.scheduleEvent(1,"bio_licensing"), EFFECT.assets(+2000)],
             fail:[EFFECT.assets(-6000)]},
          ],
        }
      ],
      media:[
        {
          id:"media_algo",
          title:"ç®—æ³•æ”¹ç‰ˆï¼šæ¨èæœºåˆ¶çªç„¶å˜äº†",
          desc:["å¹³å°æµé‡ç»“æ„è°ƒæ•´ï¼Œä½ çš„æ›å…‰æ˜æ˜¾ä¸‹é™ã€‚","ä½ å¯ä»¥è¿½çƒ­ç‚¹ï¼Œä¹Ÿå¯ä»¥åšå†…å®¹å‡çº§ã€‚"],
          options:[
            {key:"A", label:"è¿½çƒ­ç‚¹ï¼šé«˜é¢‘æ›´æ–°ï¼ˆçŸ­æœŸçˆ†å‘ï¼‰", cost:3500, p:0.65,
             suc:[EFFECT.assets(+12000), EFFECT.playerAb("è¡ŒåŠ¨åŠ›",+0.5)],
             fail:[EFFECT.assets(-2800), EFFECT.playerAb("ç®¡ç†èƒ½åŠ›",-0.5)]},
            {key:"B", label:"åšç³»åˆ—ï¼šæå‡å†…å®¹è´¨é‡ï¼ˆå›æŠ¥å»¶è¿Ÿï¼‰", cost:5000, p:0.75,
             suc:[EFFECT.delayed(2,"ç³»åˆ—å†…å®¹é•¿å°¾å›æµ", [EFFECT.assets(+18000)]), EFFECT.playerAb("æ´å¯ŸåŠ›",+0.5)],
             fail:[EFFECT.assets(-3200)]},
            {key:"C", label:"ç¨³ä½ç¤¾åŒºï¼šåšç§åŸŸä¸ä¼šå‘˜", cost:2200, p:0.78,
             suc:[EFFECT.assets(+7000), EFFECT.playerAb("æƒ…å•†",+0.5)],
             fail:[EFFECT.assets(-2000)]},
          ],
        },
      ],
      fin:[
        {
          id:"fin_compliance",
          title:"åˆè§„å®¡æŸ¥ï¼šä¸€çº¸è¦æ±‚",
          desc:["ç›‘ç®¡æŠ½æŸ¥åˆ°ä½ ä»¬çš„ä¸šåŠ¡æµç¨‹ï¼Œå¯¹é£æ§å’ŒKYCæå‡ºæ›´é«˜è¦æ±‚ã€‚","ä½ å¯ä»¥ç¡¬æ‰›æˆæœ¬ï¼Œä¹Ÿå¯ä»¥ç¼©ä¸šåŠ¡ä¿å®‰å…¨ã€‚"],
          options:[
            {key:"A", label:"å…¨é¢æ•´æ”¹ï¼šè¯·å¾‹å¸ˆ+ä¸Šç³»ç»Ÿï¼ˆè´µä½†ç¨³ï¼‰", cost:11000, p:0.80,
             suc:[EFFECT.assets(+9000), EFFECT.playerAb("ç®¡ç†èƒ½åŠ›",+0.5)],
             fail:[EFFECT.assets(-7000)]},
            {key:"B", label:"å±€éƒ¨æ•´æ”¹ï¼šå…ˆè¿‡å…³å†è¿­ä»£ï¼ˆæŠ˜ä¸­ï¼‰", cost:6000, p:0.70,
             suc:[EFFECT.delayed(1,"åˆè§„é€šè¿‡åçš„å®¢æˆ·å›æµ", [EFFECT.assets(+15000)]), EFFECT.playerAb("æ´å¯ŸåŠ›",+0.5)],
             fail:[EFFECT.assets(-5000)]},
            {key:"C", label:"ç¼©ä¸šåŠ¡ï¼šä¿ç°é‡‘ï¼ˆå¯èƒ½æŸå¤±æœºä¼šï¼‰", cost:0, p:0.78,
             suc:[EFFECT.assets(+3500), EFFECT.playerAb("æ´å¯ŸåŠ›",+0.5)],
             fail:[EFFECT.worldMarket("fin",-0.5)]},
          ],
        }
      ],
      game:[
        {
          id:"game_launch",
          title:"ç‰ˆæœ¬ä¸Šçº¿ï¼šè¦ä¸è¦ç¡¬ä¸Š",
          desc:["ç‰ˆæœ¬å¿«åˆ°èŠ‚ç‚¹ï¼Œä½†è¿˜æœ‰å‡ ä¸ªbugæ²¡ä¿®å®Œã€‚","ä½ å¯ä»¥å»¶æœŸï¼Œæˆ–é€‰æ‹©ä¸Šçº¿åçƒ­ä¿®ã€‚"],
          options:[
            {key:"A", label:"æŒ‰æœŸä¸Šçº¿+çƒ­ä¿®ï¼ˆé£é™©é«˜ï¼Œå¯èƒ½çˆ†ï¼‰", cost:7000, p:0.60,
             suc:[EFFECT.assets(+26000), EFFECT.playerAb("è¡ŒåŠ¨åŠ›",+0.5), EFFECT.scheduleEvent(1,"game_liveops")],
             fail:[EFFECT.assets(-9000), EFFECT.playerAb("æƒ…å•†",-0.5)]},
            {key:"B", label:"å»¶æœŸä¸¤å‘¨ï¼šæŠŠä½“éªŒæ‰“ç£¨å¥½ï¼ˆå›æŠ¥å»¶è¿Ÿï¼‰", cost:3000, p:0.78,
             suc:[EFFECT.delayed(1,"å£ç¢‘å‘é…µå¸¦æ¥ä»˜è´¹", [EFFECT.assets(+16000)]), EFFECT.playerAb("ä¸“ä¸šèƒ½åŠ›",+0.5)],
             fail:[EFFECT.assets(-2500)]},
            {key:"C", label:"ç æ‰åŠŸèƒ½ï¼šå…ˆä¿ç¨³å®š", cost:0, p:0.82,
             suc:[EFFECT.assets(+3000), EFFECT.playerAb("ç®¡ç†èƒ½åŠ›",+0.5)],
             fail:[EFFECT.playerAb("åˆ›æ–°åŠ›",-0.5)]},
          ],
        },
        {
          id:"game_liveops",
          title:"LiveOpsï¼šèŠ‚æ—¥æ´»åŠ¨æ€ä¹ˆåš",
          desc:["ç¤¾åŒºæœŸå¾…å€¼å¾ˆé«˜ï¼Œä½†ä½ ä»¬äº§èƒ½æœ‰é™ã€‚","æ˜¯åšå¤§æ´»åŠ¨ï¼Œè¿˜æ˜¯åšå°è€Œç¾ï¼Ÿ"],
          options:[
            {key:"A", label:"å¤§æ´»åŠ¨ï¼šå¤§å¥–æ± +è”åŠ¨ï¼ˆå›æŠ¥å»¶è¿Ÿï¼‰", cost:9000, p:0.65,
             suc:[EFFECT.delayed(2,"æ´»åŠ¨å›æµ+å¤è´­", [EFFECT.assets(+30000)]), EFFECT.playerAb("é¢†å¯¼èƒ½åŠ›",+0.5)],
             fail:[EFFECT.assets(-6000)]},
            {key:"B", label:"å°è€Œç¾ï¼šè½»é‡æ´»åŠ¨+ä½“éªŒä¼˜åŒ–", cost:3500, p:0.78,
             suc:[EFFECT.assets(+10000), EFFECT.playerAb("æ´å¯ŸåŠ›",+0.5)],
             fail:[EFFECT.assets(-2500)]},
            {key:"C", label:"ä¸åšæ´»åŠ¨ï¼šä¸“æ³¨ä¿®bug", cost:0, p:0.80,
             suc:[EFFECT.assets(+2000), EFFECT.playerAb("ç®¡ç†èƒ½åŠ›",+0.5)],
             fail:[EFFECT.worldMarket("game",-0.5)]},
          ],
        },
      ],
      newenergy:[
        {
          id:"ne_policy",
          title:"æ”¿ç­–çª—å£ï¼šè¡¥è´´ä¸å¤‡æ¡ˆ",
          desc:["åœ°æ–¹å‡ºå°æ–°è¡¥è´´ï¼Œä½†å¤‡æ¡ˆææ–™å¤æ‚ï¼Œä¸”å¯èƒ½æŠ½æŸ¥ã€‚","ä½ å¯ä»¥å†²çª—å£ï¼Œä¹Ÿå¯ä»¥å…ˆå®Œå–„ä½“ç³»ã€‚"],
          options:[
            {key:"A", label:"å†²çª—å£ï¼šå…¨åŠ›å¤‡æ¡ˆæ‹¿è¡¥è´´ï¼ˆå›æŠ¥å»¶è¿Ÿï¼‰", cost:9000, p:0.65,
             suc:[EFFECT.delayed(2,"è¡¥è´´åˆ°è´¦", [EFFECT.assets(+42000)]), EFFECT.playerAb("è¡ŒåŠ¨åŠ›",+0.5)],
             fail:[EFFECT.assets(-8000)]},
            {key:"B", label:"ç¨³å¥ï¼šå…ˆæŠŠè´¨é‡ä½“ç³»åšé½", cost:5000, p:0.78,
             suc:[EFFECT.assets(+12000), EFFECT.playerAb("ç®¡ç†èƒ½åŠ›",+0.5)],
             fail:[EFFECT.assets(-4000)]},
            {key:"C", label:"è§‚æœ›ï¼šçœé’±ä½†å¯èƒ½é”™è¿‡", cost:0, p:0.80,
             suc:[EFFECT.assets(+1500)],
             fail:[EFFECT.worldMarket("newenergy",-0.5)]},
          ],
        }
      ],
      infra:[
        {
          id:"infra_bid",
          title:"å·¥ç¨‹æŠ•æ ‡ï¼šä½ä»·æ‹¿æ ‡è¿˜æ˜¯ä¿åˆ©æ¶¦",
          desc:["ç”²æ–¹å‹ä»·ï¼Œå¸Œæœ›ä½ ç»™å‡ºæ›´ä½æŠ¥ä»·ã€‚","ä½ä»·èƒ½æ‹¿åˆ°æ ‡ï¼Œä½†ç°é‡‘æµå‹åŠ›ä¼šæ›´å¤§ã€‚"],
          options:[
            {key:"A", label:"ä½ä»·æŠ¢æ ‡ï¼ˆå›æŠ¥å»¶è¿Ÿï¼‰", cost:4000, p:0.65,
             suc:[EFFECT.delayed(3,"å·¥ç¨‹è¿›åº¦æ¬¾", [EFFECT.assets(+50000)]), EFFECT.playerAb("é¢†å¯¼èƒ½åŠ›",+0.5)],
             fail:[EFFECT.assets(-6000)]},
            {key:"B", label:"åˆç†æŠ¥ä»·ï¼šå¼ºè°ƒè´¨é‡ä¸äº¤ä»˜", cost:1800, p:0.70,
             suc:[EFFECT.delayed(2,"è¿›åº¦æ¬¾ï¼ˆè¾ƒå°ï¼‰", [EFFECT.assets(+24000)]), EFFECT.playerAb("æƒ…å•†",+0.5)],
             fail:[EFFECT.assets(-3500)]},
            {key:"C", label:"æ”¾å¼ƒï¼šä¸åšäºé’±é¡¹ç›®", cost:0, p:0.82,
             suc:[EFFECT.assets(+2500), EFFECT.playerAb("æ´å¯ŸåŠ›",+0.5)],
             fail:[EFFECT.worldMarket("infra",-0.5)]},
          ],
        }
      ],
      agri:[
        {
          id:"agri_weather",
          title:"æç«¯å¤©æ°”ï¼šä¾›åº”ä¸ç¨³",
          desc:["åŸæ–™å—å¤©æ°”å½±å“æ³¢åŠ¨ï¼Œæˆæœ¬ä¸Šæ¶¨ä¸”äº¤ä»˜ä¸ç¡®å®šã€‚","ä½ å¯ä»¥é”ä»·ï¼Œä¹Ÿå¯ä»¥æ”¹é…æ–¹ã€‚"],
          options:[
            {key:"A", label:"é”ä»·å›¤è´§ï¼ˆè´µä½†ç¨³ï¼‰", cost:7000, p:0.75,
             suc:[EFFECT.assets(+14000), EFFECT.playerAb("æ´å¯ŸåŠ›",+0.5)],
             fail:[EFFECT.assets(-6000)]},
            {key:"B", label:"æ”¹é…æ–¹ï¼šåšæ›¿ä»£åŸæ–™ï¼ˆå›æŠ¥å»¶è¿Ÿï¼‰", cost:4500, p:0.70,
             suc:[EFFECT.delayed(2,"æ›¿ä»£æ–¹æ¡ˆå¸¦æ¥åˆ©æ¶¦å›å‡", [EFFECT.assets(+18000)]), EFFECT.playerAb("åˆ›æ–°åŠ›",+0.5)],
             fail:[EFFECT.assets(-3500), EFFECT.playerAb("ä¸“ä¸šèƒ½åŠ›",-0.5)]},
            {key:"C", label:"ç¡¬æ‰›ï¼šä¸è°ƒæ•´", cost:0, p:0.78,
             suc:[EFFECT.assets(+1200)],
             fail:[EFFECT.worldMarket("agri",-0.5)]},
          ],
        }
      ]
    }
  };
  // V2.7ï¼šè¡Œä¸šäº‹ä»¶é‡ç¿»å€ï¼ˆæ¯è¡Œä¸š10~20ä¸ªï¼‰ï¼Œæ›´å¼ºè¡Œä¸šé£å‘³ï¼ˆç”¨ç”Ÿæˆå™¨è¡¥é½ï¼‰
  const ensureIndustryEvents=()=>{
    const indKeys = INDUSTRIES.map(i=>i.key);
    for(const k of indKeys){
      if(!DECISION_EVENTS[k]) DECISION_EVENTS[k]=[];
      const arr=DECISION_EVENTS[k];
      const need = k==="generic"?12:16;
      if(arr.length>=need) continue;
      const theme = industryMeta(k).name;
      const fillers = [];
      const mk=(idSuffix,title,desc,opts)=>({id:`${k}_f_${idSuffix}_${Math.floor(Math.random()*1e6)}`, title, desc, options:opts});
      for(let i=0;i<need-arr.length;i++){
        const t = [
          `${theme}ï¼šæ¸ é“åˆä½œè°ˆåˆ¤`,
          `${theme}ï¼šäº§å“å°è¿­ä»£ä¸Šçº¿`,
          `${theme}ï¼šå…³é”®å®¢æˆ·è¯•ç”¨`,
          `${theme}ï¼šä¾›åº”é“¾/äº¤ä»˜æŒ‘æˆ˜`,
          `${theme}ï¼šå£ç¢‘ä¸èˆ†æƒ…æ³¢åŠ¨`,
          `${theme}ï¼šäººæ‰äº‰å¤ºæˆ˜`
        ][i%6];
        const d = `è¡Œä¸šé£å‘ï¼š${randomNews()}\\n${descMarket(industryMarket(k))}\\nä½ éœ€è¦åœ¨æˆæœ¬ã€é€Ÿåº¦ä¸é£é™©ä¹‹é—´åšé€‰æ‹©ã€‚`;
        const baseCost = Math.round(8000 + i*1200);
        fillers.push(mk(i, t, d, [
          {label:"A. ä¿å®ˆæ¨è¿›", hint:`æˆæœ¬-${fmtMoney(Math.round(baseCost*0.6))}ï½œæˆåŠŸç‡80%ï½œæ”¶ç›Šè¾ƒå°`, cost:Math.round(baseCost*0.6),
            successP:0.80,
            onSuccess:[FX.delayed(2, `${t}ï¼ˆç¨³å¥å›æ¬¾ï¼‰`, [FX.assets(Math.round(baseCost*1.2))])],
            onFail:[FX.assets(-Math.round(baseCost*0.3))]
          },
          {label:"B. å¹³è¡¡ç­–ç•¥", hint:`æˆæœ¬-${fmtMoney(baseCost)}ï½œæˆåŠŸç‡60%ï½œæ”¶ç›Šä¸­ç­‰`, cost:baseCost,
            successP:0.60,
            onSuccess:[FX.delayed(2, `${t}ï¼ˆæ­£å¸¸å›æ¬¾ï¼‰`, [FX.assets(Math.round(baseCost*1.8))])],
            onFail:[FX.assets(-Math.round(baseCost*0.5))]
          },
          {label:"C. æ¿€è¿›å†²åˆº", hint:`æˆæœ¬-${fmtMoney(Math.round(baseCost*1.6))}ï½œæˆåŠŸç‡40%ï½œæ”¶ç›Šæ›´é«˜ï¼ˆå¯èƒ½è¿é”ï¼‰`, cost:Math.round(baseCost*1.6),
            successP:0.40,
            onSuccess:[FX.delayed(3, `${t}ï¼ˆçˆ†å‘å›æ¬¾ï¼‰`, [FX.assets(Math.round(baseCost*3.2))]),
                       FX.scheduleEvent(1, `${k}_chain_seed`)],
            onFail:[FX.assets(-Math.round(baseCost*1.0))]
          }
        ]));
      }
      DECISION_EVENTS[k].push(...fillers);
    }
  };

  // V2.7ï¼šäº‹ä»¶é“¾åˆ†æ”¯æ ‘ï¼ˆ3~5èŠ‚ç‚¹ï¼‰
  const registerChainTrees=()=>{
    const mkNode=(id,title,desc,options)=>({id,title,desc,options});
    const makeChain=(k)=>{
      const theme=industryMeta(k).name;
      const seedId = `${k}_chain_seed`;
      const n2a = `${k}_chain_2a`; const n2b=`${k}_chain_2b`; const n2c=`${k}_chain_2c`;
      const n3a = `${k}_chain_3a`; const n3b=`${k}_chain_3b`; const n3c=`${k}_chain_3c`;
      const n4a = `${k}_chain_4a`; const n4b=`${k}_chain_4b`; const n4c=`${k}_chain_4c`;

      // Seedï¼šé€‰æ–¹å‘
      DECISION_EVENT_MAP[seedId]=mkNode(seedId,
        `${theme}äº‹ä»¶é“¾ï¼šå…³é”®è½¬æŠ˜ç‚¹`,
        `ä¸€æ¡æ›´é•¿çš„æ•…äº‹çº¿å¼€å§‹äº†ã€‚\\nè¡Œä¸šç¯å¢ƒï¼š${descMarket(industryMarket(k))}\\nä½ è¦æŠ¼æ³¨å“ªæ¡è·¯å¾„ï¼Ÿ`,
        [
          {label:"A. æŠ¼æ³¨å¢é•¿ï¼ˆè¥é”€/æ¸ é“ï¼‰", hint:"æˆæœ¬ä¸­ï½œæˆåŠŸç‡55%ï½œåç»­3-4æ­¥é“¾", cost:12000, successP:0.55,
            onSuccess:[FX.delayed(2, "å¢é•¿è·¯å¾„ï¼šé¦–è½®å›æ¬¾", [FX.assets(22000)]), FX.scheduleEvent(1,n2a)],
            onFail:[FX.assets(-7000), FX.scheduleEvent(1,n2b)]
          },
          {label:"B. æŠ¼æ³¨äº§å“ï¼ˆè¿­ä»£/ä½“éªŒï¼‰", hint:"æˆæœ¬ä¸­ï½œæˆåŠŸç‡60%ï½œåç»­3-5æ­¥é“¾", cost:11000, successP:0.60,
            onSuccess:[FX.delayed(2, "äº§å“è·¯å¾„ï¼šå£ç¢‘å‘é…µ", [FX.assets(20000)]), FX.scheduleEvent(1,n2c)],
            onFail:[FX.assets(-6000), FX.scheduleEvent(1,n2b)]
          },
          {label:"C. æŠ¼æ³¨æ•ˆç‡ï¼ˆæµç¨‹/äº¤ä»˜ï¼‰", hint:"æˆæœ¬ä½ï½œæˆåŠŸç‡75%ï½œæ”¶ç›Šè¾ƒç¨³", cost:7000, successP:0.75,
            onSuccess:[FX.delayed(1, "æ•ˆç‡è·¯å¾„ï¼šæˆæœ¬ä¸‹é™", [FX.assets(12000)]), FX.scheduleEvent(1,n2b)],
            onFail:[FX.assets(-5000)]
          },
        ]
      );

      // Node2aï¼šå¢é•¿ç»§ç»­
      DECISION_EVENT_MAP[n2a]=mkNode(n2a, `${theme}äº‹ä»¶é“¾â‘¡ï¼šæ¸ é“è°ˆåˆ¤`, "å¯¹æ–¹ç»™å‡ºæ›´è‹›åˆ»çš„æ¡ä»¶ï¼Œä½ è¦æ€ä¹ˆè°ˆï¼Ÿ",
        [
          {label:"A. è®©åˆ©æ¢è§„æ¨¡", hint:"æˆåŠŸç‡55%ï½œå›æ¬¾å¤§ä½†åˆ©æ¶¦è–„", cost:9000, successP:0.55,
            onSuccess:[FX.delayed(2,"æ¸ é“æ”¾é‡å›æ¬¾",[FX.assets(35000)]), FX.scheduleEvent(1,n3a)],
            onFail:[FX.assets(-9000), FX.scheduleEvent(1,n3b)]
          },
          {label:"B. åšæŒå®šä»·", hint:"æˆåŠŸç‡45%ï½œå›æ¬¾ä¸­ä½†åˆ©æ¶¦å¥½", cost:6000, successP:0.45,
            onSuccess:[FX.delayed(2,"é«˜æ¯›åˆ©å›æ¬¾",[FX.assets(26000)]), FX.scheduleEvent(1,n3a)],
            onFail:[FX.assets(-6000), FX.scheduleEvent(1,n3b)]
          },
          {label:"C. åˆ†é˜¶æ®µåˆä½œ", hint:"æˆåŠŸç‡65%ï½œå›æ¬¾è¾ƒç¨³", cost:7000, successP:0.65,
            onSuccess:[FX.delayed(1,"é˜¶æ®µæ€§å›æ¬¾",[FX.assets(18000)]), FX.scheduleEvent(1,n3c)],
            onFail:[FX.assets(-6500)]
          },
        ]);

      // Node2bï¼šå±æœºä¿®å¤/æ•ˆç‡
      DECISION_EVENT_MAP[n2b]=mkNode(n2b, `${theme}äº‹ä»¶é“¾â‘¡ï¼šå†…éƒ¨ä¿®å¤`, "ç»„ç»‡å¼€å§‹å‡ºç°æ‘©æ“¦ï¼Œä½ éœ€è¦å…ˆç¨³ä½å“ªä¸€å—ï¼Ÿ",
        [
          {label:"A. åŠ è–ªç•™äºº", hint:"æˆæœ¬é«˜ï½œæˆåŠŸç‡70%ï½œé™ä½ç¦»èŒé£é™©", cost:15000, successP:0.70,
            onSuccess:[FX.delayed(1,"å›¢é˜Ÿç¨³å®šå¸¦æ¥å›æ¬¾",[FX.assets(18000)])],
            onFail:[FX.assets(-12000), FX.scheduleEvent(1,n3b)]
          },
          {label:"B. é‡æ„æµç¨‹", hint:"æˆæœ¬ä¸­ï½œæˆåŠŸç‡60%ï½œåç»­æ”¶ç›Š", cost:10000, successP:0.60,
            onSuccess:[FX.delayed(2,"æ•ˆç‡æå‡å›æ¬¾",[FX.assets(24000)]), FX.scheduleEvent(1,n3c)],
            onFail:[FX.assets(-9000), FX.scheduleEvent(1,n3b)]
          },
          {label:"C. ç æ‰è¾¹ç¼˜çº¿", hint:"æˆæœ¬ä½ï½œæˆåŠŸç‡75%ï½œä½†æœ‰èˆ†è®ºé£é™©", cost:5000, successP:0.75,
            onSuccess:[FX.delayed(1,"èšç„¦å¸¦æ¥å›æ¬¾",[FX.assets(14000)]), FX.scheduleEvent(1,n3c)],
            onFail:[FX.assets(-7000)]
          },
        ]);

      // Node2cï¼šäº§å“å£ç¢‘
      DECISION_EVENT_MAP[n2c]=mkNode(n2c, `${theme}äº‹ä»¶é“¾â‘¡ï¼šäº§å“æ‹ç‚¹`, "ä¸€ä¸ªå…³é”®åŠŸèƒ½è¦ä¸è¦ç°åœ¨ä¸Šçº¿ï¼Ÿ",
        [
          {label:"A. ç°åœ¨ä¸Šçº¿", hint:"æˆåŠŸç‡50%ï½œæ”¶ç›Šé«˜ï½œé£é™©é«˜", cost:14000, successP:0.50,
            onSuccess:[FX.delayed(2,"å£ç¢‘çˆ†å‘å›æ¬¾",[FX.assets(42000)]), FX.scheduleEvent(1,n3a)],
            onFail:[FX.assets(-14000), FX.scheduleEvent(1,n3b)]
          },
          {label:"B. å†æ‰“ç£¨ä¸€ä¸ªæœˆ", hint:"æˆåŠŸç‡70%ï½œæ”¶ç›Šä¸­", cost:8000, successP:0.70,
            onSuccess:[FX.delayed(2,"å£ç¢‘ç¨³æ­¥å›æ¬¾",[FX.assets(28000)]), FX.scheduleEvent(1,n3c)],
            onFail:[FX.assets(-8000)]
          },
          {label:"C. ç°åº¦å‘å¸ƒ", hint:"æˆåŠŸç‡65%ï½œæ”¶ç›Šç¨³", cost:9000, successP:0.65,
            onSuccess:[FX.delayed(1,"ç°åº¦å›æ¬¾",[FX.assets(20000)]), FX.scheduleEvent(1,n3c)],
            onFail:[FX.assets(-9000)]
          },
        ]);

      // Node3*ï¼šåˆ†æ”¯æ”¶æŸåˆ°ç»ˆç« 
      DECISION_EVENT_MAP[n3a]=mkNode(n3a, `${theme}äº‹ä»¶é“¾â‘¢ï¼šæ‰©å¤§è§„æ¨¡`, "ä¸šåŠ¡å¢é•¿åï¼Œä½ è¦æ€ä¹ˆæ‰©å¼ ï¼Ÿ",
        [
          {label:"A. æ‰©æ‹›å†²åˆº", hint:"æˆåŠŸç‡55%ï½œæœªæ¥å›æ¬¾æ›´é«˜", cost:18000, successP:0.55,
            onSuccess:[FX.delayed(3,"æ‰©å¼ å›æ¬¾",[FX.assets(65000)]), FX.scheduleEvent(1,n4a)],
            onFail:[FX.assets(-15000), FX.scheduleEvent(1,n4b)]
          },
          {label:"B. åˆä½œå¤–åŒ…", hint:"æˆåŠŸç‡65%ï½œå›æ¬¾ä¸­", cost:12000, successP:0.65,
            onSuccess:[FX.delayed(2,"å¤–åŒ…äº¤ä»˜å›æ¬¾",[FX.assets(42000)]), FX.scheduleEvent(1,n4c)],
            onFail:[FX.assets(-12000)]
          },
          {label:"C. æ…¢ä¸€ç‚¹æ›´ç¨³", hint:"æˆåŠŸç‡80%ï½œå›æ¬¾ç¨³", cost:8000, successP:0.80,
            onSuccess:[FX.delayed(2,"ç¨³å¥å›æ¬¾",[FX.assets(32000)]), FX.scheduleEvent(1,n4c)],
            onFail:[FX.assets(-8000)]
          },
        ]);

      DECISION_EVENT_MAP[n3b]=mkNode(n3b, `${theme}äº‹ä»¶é“¾â‘¢ï¼šé£æ³¢ä¸å…¬å…³`, "å¤–éƒ¨è´¨ç–‘å‡ºç°ï¼Œä½ å¦‚ä½•å¤„ç†ï¼Ÿ",
        [
          {label:"A. å…¬å¼€å›åº”", hint:"æˆåŠŸç‡60%ï½œæˆæœ¬ä¸­", cost:9000, successP:0.60,
            onSuccess:[FX.delayed(2,"å…¬å…³æˆåŠŸå›æ¬¾",[FX.assets(26000)]), FX.scheduleEvent(1,n4c)],
            onFail:[FX.assets(-12000)]
          },
          {label:"B. ç§ä¸‹è§£å†³", hint:"æˆåŠŸç‡55%ï½œæˆæœ¬ä½", cost:5000, successP:0.55,
            onSuccess:[FX.delayed(2,"ç§äº†å›æ¬¾",[FX.assets(20000)]), FX.scheduleEvent(1,n4b)],
            onFail:[FX.assets(-9000)]
          },
          {label:"C. å…ˆæ²‰é»˜", hint:"æˆåŠŸç‡40%ï½œå¯èƒ½æ›´ç³Ÿ", cost:2000, successP:0.40,
            onSuccess:[FX.delayed(1,"ä¾¥å¹¸èº²è¿‡å›æ¬¾",[FX.assets(12000)])],
            onFail:[FX.assets(-15000), FX.scheduleEvent(1,n4b)]
          },
        ]);

      DECISION_EVENT_MAP[n3c]=mkNode(n3c, `${theme}äº‹ä»¶é“¾â‘¢ï¼šå›¢é˜Ÿé‡ç»„`, "ç»„ç»‡è¾¹ç•Œéœ€è¦æ˜ç¡®ï¼Œä½ æ€ä¹ˆåšï¼Ÿ",
        [
          {label:"A. æ˜ç¡®æ±‡æŠ¥çº¿", hint:"æˆåŠŸç‡70%ï½œå›æ¬¾ç¨³", cost:6000, successP:0.70,
            onSuccess:[FX.delayed(2,"ç»„ç»‡ç¨³å®šå›æ¬¾",[FX.assets(24000)]), FX.scheduleEvent(1,n4c)],
            onFail:[FX.assets(-6000)]
          },
          {label:"B. èµ‹æƒç»™å¹²éƒ¨", hint:"æˆåŠŸç‡55%ï½œå›æ¬¾ä¸­", cost:8000, successP:0.55,
            onSuccess:[FX.delayed(2,"å¹²éƒ¨å¸¦é˜Ÿå›æ¬¾",[FX.assets(30000)]), FX.scheduleEvent(1,n4a)],
            onFail:[FX.assets(-9000)]
          },
          {label:"C. ä¸´æ—¶é¡¹ç›®åˆ¶", hint:"æˆåŠŸç‡60%ï½œå›æ¬¾ä¸­", cost:7000, successP:0.60,
            onSuccess:[FX.delayed(2,"é¡¹ç›®åˆ¶å›æ¬¾",[FX.assets(26000)]), FX.scheduleEvent(1,n4c)],
            onFail:[FX.assets(-7000)]
          },
        ]);

      // Node4*ï¼šç»ˆç« 
      DECISION_EVENT_MAP[n4a]=mkNode(n4a, `${theme}äº‹ä»¶é“¾ç»ˆç« ï¼šå·…å³°ä¸€æ`, "æœ€åä¸€æ­¥ï¼šä½ è¦å†²åˆºä¸Šå¸‚/å¤§å®¢æˆ·/å¹¶è´­ï¼Ÿ",
        [
          {label:"A. å†²åˆºå¤§å®¢æˆ·", hint:"æˆåŠŸç‡45%ï½œå›æ¬¾æé«˜", cost:22000, successP:0.45,
            onSuccess:[FX.delayed(3,"ç»ˆç« å›æ¬¾ï¼šå¤§å®¢æˆ·",[FX.assets(120000)])],
            onFail:[FX.assets(-26000)]
          },
          {label:"B. å†²åˆºå¹¶è´­", hint:"æˆåŠŸç‡35%ï½œå›æ¬¾æé«˜", cost:26000, successP:0.35,
            onSuccess:[FX.delayed(4,"ç»ˆç« å›æ¬¾ï¼šå¹¶è´­",[FX.assets(150000)])],
            onFail:[FX.assets(-32000)]
          },
          {label:"C. ä¸èµŒäº†ç¨³ä½", hint:"æˆåŠŸç‡80%ï½œå›æ¬¾ä¸­", cost:12000, successP:0.80,
            onSuccess:[FX.delayed(2,"ç»ˆç« å›æ¬¾ï¼šç¨³å¥",[FX.assets(60000)])],
            onFail:[FX.assets(-12000)]
          },
        ]);

      DECISION_EVENT_MAP[n4b]=mkNode(n4b, `${theme}äº‹ä»¶é“¾ç»ˆç« ï¼šæ­¢æŸä¸è½¬å‘`, "ä½ å†³å®šæŠŠæŸå¤±æ§åˆ¶åœ¨å¯æ‰¿å—èŒƒå›´ï¼š",
        [
          {label:"A. æ”¶ç¼©ä¿å‘½", hint:"æˆåŠŸç‡85%ï½œå›æ¬¾è¾ƒå°", cost:6000, successP:0.85,
            onSuccess:[FX.delayed(1,"æ­¢æŸå›æ¬¾",[FX.assets(16000)])],
            onFail:[FX.assets(-8000)]
          },
          {label:"B. è½¬æŠ•æ–°æ¸ é“", hint:"æˆåŠŸç‡60%ï½œå›æ¬¾ä¸­", cost:9000, successP:0.60,
            onSuccess:[FX.delayed(2,"æ–°æ¸ é“å›æ¬¾",[FX.assets(28000)])],
            onFail:[FX.assets(-12000)]
          },
          {label:"C. é€€å‡ºé¡¹ç›®", hint:"æˆåŠŸç‡95%ï½œæŸå¤±å°", cost:2000, successP:0.95,
            onSuccess:[FX.assets(-2000)], onFail:[FX.assets(-5000)]
          },
        ]);

      DECISION_EVENT_MAP[n4c]=mkNode(n4c, `${theme}äº‹ä»¶é“¾ç»ˆç« ï¼šç¨³æ­¥å¢é•¿`, "ä½ æŠŠç³»ç»Ÿæ‰“ç£¨åˆ°èƒ½æŒç»­èµšé’±ï¼š",
        [
          {label:"A. æ ‡å‡†åŒ–å¤åˆ¶", hint:"æˆåŠŸç‡70%ï½œå›æ¬¾ä¸­é«˜", cost:12000, successP:0.70,
            onSuccess:[FX.delayed(3,"å¤åˆ¶å›æ¬¾",[FX.assets(70000)])],
            onFail:[FX.assets(-12000)]
          },
          {label:"B. æ·±è€•å¤è´­", hint:"æˆåŠŸç‡80%ï½œå›æ¬¾ä¸­", cost:9000, successP:0.80,
            onSuccess:[FX.delayed(2,"å¤è´­å›æ¬¾",[FX.assets(42000)])],
            onFail:[FX.assets(-9000)]
          },
          {label:"C. ç»´æŠ¤ç°é‡‘æµ", hint:"æˆåŠŸç‡90%ï½œå›æ¬¾ç¨³", cost:6000, successP:0.90,
            onSuccess:[FX.delayed(1,"ç°é‡‘æµå›æ¬¾",[FX.assets(24000)])],
            onFail:[FX.assets(-6000)]
          },
        ]);
    };

    // å…ˆä¸ºæ¯ä¸ªè¡Œä¸šæ³¨å†Œ
    for(const ind of INDUSTRIES){
      if(ind.key==="generic") continue;
      makeChain(ind.key);
    }
  };


  const pickDecisionEvent=()=>{
    const ind=state.company.industry;
    const pool=[...(DECISION_EVENTS.byIndustry[ind]||[]), ...DECISION_EVENTS.generic];
    return pool.length? pick(pool): null;
  };

  const openDecision=(ev)=>{
    state.ui.pendingDecision = {
      id: ev.id,
      title: ev.title,
      desc: ev.desc,
      options: ev.options
    };
  };

  const resolveDecision=(optKey)=>{
    const ev=state.ui.pendingDecision;
    if(!ev) return;
    const opt = ev.options.find(o=>o.key===optKey);
    if(!opt) return;
    // pay cost
    if(opt.cost) state.company.assets = Math.round(state.company.assets - opt.cost);
    const ok = roll(opt.p);
    const title = ok ? `${ev.title} Â· ç»“æœï¼šæˆåŠŸ` : `${ev.title} Â· ç»“æœï¼šå¤±åˆ©`;
    const lines = [
      ...(ev.desc||[]),
      `é€‰æ‹©ï¼š${opt.key}. ${opt.label}`,
      `æˆæœ¬ï¼š${fmtMoney(opt.cost||0)}ï½œæˆåŠŸç‡ï¼š${Math.round(opt.p*100)}%ï½œç»“æœï¼š${ok?"æˆåŠŸ":"å¤±åˆ©"}`
    ];
    if(ok) applyEffects(opt.suc); else applyEffects(opt.fail);
    // add a short outcome line
    lines.push(ok ? "å±€é¢æœä½ å¸Œæœ›çš„æ–¹å‘æ¨è¿›äº†ä¸€æ­¥ã€‚" : "è¿™æ¬¡ä»£ä»·ä¸å°ï¼Œä½†ä½ ä¹Ÿè·å¾—äº†ç»éªŒã€‚");
    log(ok?"good":"bad", story(ok?"good":"bad", title, lines));
    const ov=document.getElementById("decisionOverlay"); if(ov) ov.remove();
    state.ui.pendingDecision=null;
    state.ui.decisionOverlayOpen=false;
    save(); render();
  };


  const el=(tag,attrs={},kids=[])=>{
    const e=document.createElement(tag);
    for(const [k,v] of Object.entries(attrs)){
      if(k==="class")e.className=v;
      else if(k==="html")e.innerHTML=v;
      else if(k==="style")e.setAttribute("style",v);
      else if(k.startsWith("on")&&typeof v==="function")e.addEventListener(k.slice(2),v);
      else if(v!=null)e.setAttribute(k,v);
    }
    for(const c of kids){ if(c==null)continue; if(typeof c==="string")e.appendChild(document.createTextNode(c)); else e.appendChild(c); }
    return e;
  };
  const meter=(val)=>el("div",{class:"meter"},[el("div",{class:"fill",style:`width:${clamp(val/10*100,0,100)}%`})]);

  const ABILS=[["innov","åˆ›æ–°åŠ›"],["act","è¡ŒåŠ¨åŠ›"],["insight","æ´å¯ŸåŠ›"],["manage","ç®¡ç†èƒ½åŠ›"],["lead","é¢†å¯¼èƒ½åŠ›"],["prof","ä¸“ä¸šèƒ½åŠ›"],["eq","æƒ…å•†"],["learn","å­¦ä¹ èƒ½åŠ›"]];
  const ROLES=["äº§å“","è¿è¥","é”€å”®","å¸‚åœº","ç ”å‘","è´¢åŠ¡","HR","æ³•åŠ¡","è®¾è®¡","æ•°æ®","ä¾›åº”é“¾","å®¢æœ"];
  const POSITIONS=[
    {key:"intern",name:"å®ä¹ ç”Ÿ",minSize:1, baseSalary:1200, minManage:0},
    {key:"staff", name:"å‘˜å·¥",minSize:1, baseSalary:2200, minManage:0},
    {key:"senior",name:"é«˜çº§å‘˜å·¥",minSize:3, baseSalary:3500, minManage:2.5},
    {key:"mgr",   name:"ä¸»ç®¡",minSize:6, baseSalary:5200, minManage:4.0},
    {key:"dir",   name:"ç»ç†",minSize:10,baseSalary:7600, minManage:5.5},
    {key:"vp",    name:"æ€»ç›‘",minSize:16,baseSalary:10500,minManage:6.5},
    {key:"cxo",   name:"å‰¯æ€»è£",minSize:25,baseSalary:14500,minManage:7.5},
    {key:"owner", name:"å…¬å¸æ‰€æœ‰äºº",minSize:1,baseSalary:0, minManage:0},
  ];
  const INDUSTRIES=[
    { key:"tech",  name:"ç§‘æŠ€/è½¯ä»¶", baseRev:52000 },
    { key:"edu",   name:"æ•™è‚²/åŸ¹è®­", baseRev:36000 },
    { key:"ret",   name:"é›¶å”®/ç”µå•†", baseRev:42000 },
    { key:"food",  name:"é¤é¥®/é£Ÿå“", baseRev:30000 },
    { key:"bio",   name:"ç”Ÿç‰©/åŒ»ç–—", baseRev:48000 },
    { key:"manu",  name:"åˆ¶é€ /ä¾›åº”é“¾", baseRev:45000 },
    { key:"media", name:"åª’ä½“/å†…å®¹", baseRev:34000 },
    { key:"fin",   name:"é‡‘è/å’¨è¯¢", baseRev:56000 },
    { key:"game",  name:"æ¸¸æˆ/æ–‡å¨±", baseRev:41000 },
    { key:"newenergy", name:"æ–°èƒ½æº/ç¯ä¿", baseRev:47000 },
    { key:"infra", name:"åŸºå»º/å·¥ç¨‹", baseRev:43000 },
    { key:"agri",  name:"å†œä¸š/é£Ÿå“ç§‘æŠ€", baseRev:32000 },
  ];

  // V2.7ï¼šç«äº‰å¯¹æ‰‹ç³»ç»Ÿï¼ˆè§„æ¨¡è¾¾åˆ°é˜ˆå€¼è§£é”ï¼‰
  const RIVAL_NAMES = ["æ˜ŸèŠ’é›†å›¢","åŒ—è¾°èµ„æœ¬ç³»","é»‘æ›œç§‘æŠ€","ä¸‡è±¡å®ä¸š","é£æš´è¿é”","æµ·å²šæ•™è‚²","æå…‰ä¼ åª’","æ¾„æ˜å’¨è¯¢","ä¸°ç©—å†œä¸š","è¿œèˆªåˆ¶é€ "];
  const ensureRival=()=>{
    const r = state.company.rivals || (state.company.rivals={unlocked:false,heat:0,lastAttack:0,shields:0,name:"",industry:""});
    if(!r.name) r.name = pick(RIVAL_NAMES);
    if(!r.industry) r.industry = pick(INDUSTRIES.filter(x=>x.key!=="generic")).key;
  };
  const rivalUnlocked=()=> (scaleLevel()>=3); // ä¸­å‹è§„æ¨¡å¼€å§‹é­é‡å¯¹æ‰‹
  const unlockRivalIfNeeded=()=>{
    ensureRival();
    const r=state.company.rivals;
    if(!r.unlocked && rivalUnlocked()){
      r.unlocked=true;
      r.heat=10;
      log("warn", story("warn", "ç«äº‰å¯¹æ‰‹ç™»åœº", [
        `${r.name} å¼€å§‹åœ¨ä½ æ‰€åœ¨çš„èµ›é“å‘¨è¾¹æ´»åŠ¨ï¼ˆå¯¹æ‰‹è¡Œä¸šï¼š${industryMeta(r.industry).name}ï¼‰ã€‚`,
        "ä»ç°åœ¨èµ·ï¼Œä½ ä¼šé­é‡å¯¹æ‰‹çš„å¹²æ‰°ï¼šæŒ–äººã€ä»·æ ¼æˆ˜ã€èˆ†è®ºæˆ˜ã€æ¸ é“å°é”ç­‰ã€‚"
      ]));
    }
  };
  const rivalAttack=()=>{
    ensureRival();
    const r=state.company.rivals;
    if(!r.unlocked) return;
    // heat grows with size
    const grow = 2 + scaleLevel()*2 + Math.max(0, staffCount()-10)*0.2;
    r.heat = Math.min(100, r.heat + grow);
    // shield reduces chance
    const baseP = clamp(0.10 + r.heat/250, 0.10, 0.55);
    const shield = (r.shields||0);
    const p = clamp(baseP - shield*0.06, 0.05, 0.45);
    if(Math.random() > p) return;
    const ctx = computeContext();
    const attacks = [
      {k:"price", title:"ä»·æ ¼æˆ˜ï¼šå¯¹æ‰‹é™ä»·æŠ¢å•", apply:()=>{
        const loss = Math.round(Math.max(4000, state.company.assets*0.01));
        state.company.assets -= loss;
        log("bad", story("bad", "ç«äº‰å¯¹æ‰‹ï¼šä»·æ ¼æˆ˜", [
          `${r.name} å‘èµ·é™ä»·ï¼Œéƒ¨åˆ†å®¢æˆ·æ‘‡æ‘†ã€‚`,
          `çŸ­æœŸæŸå¤±ï¼š-${fmtMoney(loss)}`
        ]));
      }},
      {k:"poach", title:"æŒ–äººï¼šå¯¹æ‰‹é«˜è–ªæŒ–è§’", apply:()=>{
        const cand = activeStaff().filter(e=>e.position!=="Owner");
        if(!cand.length){ return; }
        const who = pick(cand);
        const chance = clamp(0.25 + (r.heat/200) - (who.abilities.eq-5)*0.03, 0.10, 0.65);
        if(Math.random()<chance){
          who.active=false; who.left=true;
          log("bad", story("bad", "ç«äº‰å¯¹æ‰‹ï¼šæŒ–äººæˆåŠŸ", [
            `${r.name} ç»™å‡ºæ›´é«˜è–ªä¸æ›´å¥½å¤´è¡”ï¼Œ${who.name} é€‰æ‹©ç¦»èŒã€‚`,
            "æç¤ºï¼šæé«˜å…³é”®å²—ä½è–ªèµ„/æ™‹å‡ã€å»ºç«‹ç›´å±å…³ç³»ä¸ç¾ç»Šå¯é™ä½é£é™©ã€‚"
          ]));
        }else{
          log("warn", story("warn", "ç«äº‰å¯¹æ‰‹ï¼šæŒ–äººæœªé‚", [
            `${r.name} è¯•å›¾æŒ–èµ°éª¨å¹²ï¼Œä½†è¢«ä½ åŠæ—¶ç¨³ä½ã€‚`
          ]));
        }
      }},
      {k:"pr", title:"èˆ†è®ºæˆ˜ï¼šè´Ÿé¢è¯é¢˜å‘é…µ", apply:()=>{
        const mult = 1.06 + r.heat/220;
        state.company.rivalDebuff = {months:2, rev:0.92, resign:mult};
        log("bad", story("bad", "ç«äº‰å¯¹æ‰‹ï¼šèˆ†è®ºæˆ˜", [
          `å¤–ç•Œå‡ºç°é’ˆå¯¹ä½ çš„è´Ÿé¢è¯é¢˜ï¼Œå›¢é˜Ÿæƒ…ç»ªæ›´æ•æ„Ÿã€‚`,
          "æ•ˆæœï¼š2ä¸ªæœˆå†… è¥æ”¶Ã—0.92ï¼›ç¦»èŒå€¾å‘ä¸Šå‡ã€‚"
        ]));
      }},
      {k:"channel", title:"æ¸ é“å°é”ï¼šåˆä½œé—¨æ§›æŠ¬é«˜", apply:()=>{
        const fee = 6000 + scaleLevel()*2500;
        state.company.assets -= fee;
        state.company.rivalDebuff = {months:1, rev:0.90, resign:1.05};
        log("bad", story("bad", "ç«äº‰å¯¹æ‰‹ï¼šæ¸ é“å°é”", [
          `${r.name} å½±å“æ¸ é“è§„åˆ™ï¼Œä½ ä¸å¾—ä¸æ”¯ä»˜é¢å¤–æˆæœ¬å¹¶å»¶è¿Ÿè®¢å•ã€‚`,
          `é¢å¤–æˆæœ¬ï¼š-${fmtMoney(fee)}ï¼›1ä¸ªæœˆè¥æ”¶Ã—0.90`
        ]));
      }},
    ];
    pick(attacks).apply();
    r.lastAttack = (r.lastAttack||0)+1;
  };
  const RARITIES=[{key:"R",p:0.70,mult:0.95,cls:""},{key:"SR",p:0.25,mult:1.05,cls:"warn"},{key:"SSR",p:0.05,mult:1.18,cls:"good"}];
  const GENDERS=["å¥³","ç”·","éäºŒå…ƒ"];
  const randAge=()=>Math.floor(rnd(22,55));
  const pickRarity=()=>{const x=Math.random();let a=0;for(const r of RARITIES){a+=r.p;if(x<=a)return r.key;}return "R";}
  const rarityMeta=(k)=>RARITIES.find(r=>r.key===k)||RARITIES[0];
  const rankOf=(k)=>POSITIONS.findIndex(p=>p.key===k);
  const posByKey=(k)=>POSITIONS.find(p=>p.key===k)||POSITIONS[1];
  const positionName=(k)=>posByKey(k).name;

  // AIé£é»˜è®¤å¤´åƒï¼ˆSVG data URIï¼‰
  const svgToData=(svg)=>"data:image/svg+xml;charset=utf-8,"+encodeURIComponent(svg);
  const AI_PORTRAITS=[
    svgToData(`<svg xmlns="http://www.w3.org/2000/svg" width="256" height="256">
      <defs><linearGradient id="g" x1="0" x2="1"><stop stop-color="#7aa2ff"/><stop offset="1" stop-color="#58e3a5"/></linearGradient></defs>
      <rect width="256" height="256" rx="36" fill="#0b1020"/>
      <circle cx="140" cy="92" r="64" fill="url(#g)" opacity="0.35"/>
      <circle cx="96" cy="156" r="72" fill="url(#g)" opacity="0.22"/>
      <path d="M62 190c18-46 116-46 134 0" fill="none" stroke="url(#g)" stroke-width="10" stroke-linecap="round"/>
      <circle cx="112" cy="122" r="10" fill="#eaf0ff"/><circle cx="154" cy="122" r="10" fill="#eaf0ff"/>
      <path d="M118 150c10 10 22 10 32 0" fill="none" stroke="#eaf0ff" stroke-width="8" stroke-linecap="round"/>
    </svg>`),
    svgToData(`<svg xmlns="http://www.w3.org/2000/svg" width="256" height="256">
      <defs><radialGradient id="r" cx="35%" cy="25%" r="70%"><stop stop-color="#ffd166"/><stop offset="1" stop-color="#7aa2ff"/></radialGradient></defs>
      <rect width="256" height="256" rx="36" fill="#0b1020"/>
      <circle cx="128" cy="132" r="84" fill="url(#r)" opacity="0.32"/>
      <path d="M70 210c20-60 96-60 116 0" fill="none" stroke="#a9b6dd" stroke-width="10" stroke-linecap="round" opacity="0.8"/>
      <path d="M94 108c18-26 50-26 68 0" fill="none" stroke="#eaf0ff" stroke-width="10" stroke-linecap="round"/>
      <circle cx="110" cy="134" r="9" fill="#eaf0ff"/><circle cx="146" cy="134" r="9" fill="#eaf0ff"/>
      <path d="M116 164c14 10 26 10 40 0" fill="none" stroke="#eaf0ff" stroke-width="7" stroke-linecap="round"/>
    </svg>`),
    svgToData(`<svg xmlns="http://www.w3.org/2000/svg" width="256" height="256">
      <defs><linearGradient id="g2" x1="0" x2="1"><stop stop-color="#ff6b6b"/><stop offset="1" stop-color="#7aa2ff"/></linearGradient></defs>
      <rect width="256" height="256" rx="36" fill="#0b1020"/>
      <path d="M28 170c40-120 160-120 200 0" fill="none" stroke="url(#g2)" stroke-width="22" stroke-linecap="round" opacity="0.35"/>
      <circle cx="128" cy="120" r="64" fill="url(#g2)" opacity="0.20"/>
      <circle cx="104" cy="118" r="9" fill="#eaf0ff"/><circle cx="152" cy="118" r="9" fill="#eaf0ff"/>
      <path d="M112 148c10 14 22 14 32 0" fill="none" stroke="#eaf0ff" stroke-width="8" stroke-linecap="round"/>
      <path d="M70 88c16-18 34-26 58-26s42 8 58 26" fill="none" stroke="#a9b6dd" stroke-width="8" stroke-linecap="round" opacity="0.7"/>
    </svg>`),
  ];
  const randomPortrait=()=>pick(AI_PORTRAITS);

  // Skills 70/30
  const SKILLS_POS=[
    {key:"sales_genius",name:"é”€å”®å¤©æ‰",type:"pos",desc:"å…¬å¸è¥æ”¶ x1.04ï¼ˆå¸¸é©»ï¼‰",apply:(ctx,p)=>ctx.revMult*=1.04},
    {key:"ops_saver",name:"æˆæœ¬ç®¡å®¶",type:"pos",desc:"å‘˜å·¥è–ªé…¬æˆæœ¬ x0.94",apply:(ctx,p)=>ctx.payrollMult*=0.94},
    {key:"hr_stable",name:"ç•™æ‰ä¸“å®¶",type:"pos",desc:"å…¨å‘˜ç¦»èŒæ¦‚ç‡ x0.80",apply:(ctx,p)=>ctx.resignMult*=0.80},
    {key:"rd_engine",name:"ç ”å‘å¼•æ“",type:"pos",desc:"ç ”å‘ç‚¹è·å– x1.30ï¼ˆé¢„ç•™ï¼‰",apply:(ctx,p)=>ctx.rdMult*=1.30},
    {key:"crisis_shield",name:"å±æœºå…¬å…³",type:"pos",desc:"å¹´åº¦å˜æ•…æŸå¤± x0.75",apply:(ctx,p)=>ctx.crisisMult*=0.75},
    {key:"market_eye",name:"å¸‚åœºå—…è§‰",type:"pos",desc:"ä¸–ç•Œè¡Œæƒ…æ³¢åŠ¨ç•¥ååˆ©å¥½ï¼ˆå°ä¼˜åŠ¿ï¼‰",apply:(ctx,p)=>ctx.marketLuck+=0.12},
    {key:"leader_aura",name:"é¢†è¢–å…‰ç¯",type:"pos",desc:"ç¾ç»Šå¢é•¿ x1.40ï¼›å›¢é˜Ÿæ›´ç¨³å®š",apply:(ctx,p)=>{ctx.bondMult*=1.40;ctx.resignMult*=0.92;}},
    {key:"love_maker",name:"æ‹çˆ±å¹¸è¿æ˜Ÿ",type:"pos",desc:"æ‹çˆ±äº‹ä»¶æ›´åå‘æ­£å‘ç»“æœ",apply:(ctx,p)=>{ctx.loveLuck+=0.16;}},
  ];
  const SKILLS_NEG=[
    {key:"mood_swing",name:"æƒ…ç»ªä¸ç¨³",type:"neg",desc:"è¡Œæƒ…<0.90æ—¶è‡ªèº«ç¦»èŒæ¦‚ç‡ç¿»å€ï¼ˆ+ä¸Šé™ï¼‰",apply:(ctx,p)=>{}},
    {key:"procrastinate",name:"æ‹–å»¶ç—‡",type:"neg",desc:"è¡ŒåŠ¨åŠ› -1.0ï¼ˆæ°¸ä¹…ï¼‰",apply:(ctx,p)=>{}},
    {key:"conflict",name:"äººé™…å†²çª",type:"neg",desc:"æ›´å®¹æ˜“å¼•å‘å†²çª/åˆ†æ‰‹äº‹ä»¶",apply:(ctx,p)=>{ctx.loveLuck-=0.14;}},
    {key:"high_cost",name:"é«˜æ¶ˆè´¹æ¬²",type:"neg",desc:"è–ªèµ„éœ€æ±‚ +20%ï¼Œä½è–ªæ›´æ˜“ç¦»èŒ",apply:(ctx,p)=>{}},
    {key:"fragile_heart",name:"æƒ…æ„Ÿè„†å¼±",type:"neg",desc:"æ‹çˆ±è´Ÿé¢äº‹ä»¶ä¼šé¢å¤–æ‰å±æ€§",apply:(ctx,p)=>{ctx.loveFragile+=0.22;}},
  ];
  const pickSkill=(role,rar)=>{
    const isNeg=Math.random()<0.30;
    const pool=isNeg?SKILLS_NEG:SKILLS_POS;
    const bias={
      "é”€å”®":["sales_genius","market_eye"],
      "è¿è¥":["ops_saver","market_eye"],
      "HR":["hr_stable","leader_aura","love_maker"],
      "ç ”å‘":["rd_engine","crisis_shield"],
      "å¸‚åœº":["market_eye","sales_genius"],
      "è´¢åŠ¡":["ops_saver","crisis_shield"],
      "æ³•åŠ¡":["crisis_shield","ops_saver"],
      "æ•°æ®":["market_eye","rd_engine"],
      "äº§å“":["rd_engine","leader_aura"],
      "ä¾›åº”é“¾":["ops_saver","crisis_shield"],
      "å®¢æœ":["hr_stable","leader_aura","love_maker"],
      "è®¾è®¡":["market_eye","sales_genius"],
    };
    const prefer=(bias[role]||[]);
    const preferPool=pool.filter(s=>prefer.includes(s.key));
    const chance=(rar==="SSR"?0.65:rar==="SR"?0.45:0.25);
    if(preferPool.length && Math.random()<chance) return pick(preferPool);
    return pick(pool);
  };

  // Save
  const SAVE_KEY="empire_game_save_v2_7_full";
  const defaultWorldMarkets=()=>{
    const m={};
    for(const ind of INDUSTRIES) m[ind.key]=roundHalf(rnd(0.85,1.15));
    return m;
  };
  const defaultState=()=>({
    ver:"2.7",
    createdAt: todayStr(),
    company:{
      name:"æœªå‘½åå…¬å¸",
      industry:"tech",
      month:1, year:1,
      assets:140000,
      revenueLast:0,
      layoffsThisYear:0,
      layoffsLast6M:0,
      teamActivityUsedMonth:-1,
      annualMeetingUsedYear:0,
      crisesPlan:[],
      scheduledEvents:[],
      delayedEffects:[],
      worldMarkets: defaultWorldMarkets(),
      negativeStreak: 0,
      rescueBuffMonths: 0,
      negativeSwitchCount: 0,
      moraleBuffMonths: 0,
      gameOver:false,
      gameOverReason:"",
    },
    player:null,
    people:[],
    relations:{},
    bonds:{},
    love:{},
    log:[],
    archive:[],
    gacha:{ pulls:0, pitySSR:0 },
    ui:{ tab:"dashboard", pendingDecision:null, decisionOverlayOpen:false, showArchive:false, showChangelog:false }
  });
  // V2.7 hotfixï¼šiOSæŸäº›æ–‡ä»¶æµè§ˆå™¨ WebView ç¦ç”¨ localStorageï¼ˆä¼šæŠ› SecurityErrorï¼‰
  const SafeStore = {
    ok: true,
    get(key){
      try{ return SafeStore.get(key); }catch(e){ this.ok=false; return null; }
    },
    set(key,val){
      try{ SafeStore.set(key,val); }catch(e){ this.ok=false; }
    }
  };

  const load=()=>{try{const raw=SafeStore.get(SAVE_KEY);if(!raw)return null;const st=JSON.parse(raw);if(!st||!st.company)return null;return st;}catch(e){return null;}}
  const save=()=>SafeStore.set(SAVE_KEY, JSON.stringify(state));
  let state=load()||defaultState();

  const log=(type,text)=>{const entry={t:todayStr(),type,text,month:state.company.month,year:state.company.year,industry:state.company.industry};state.log.unshift(entry);state.log=state.log.slice(0,260);state.archive.unshift(entry);state.archive=state.archive.slice(0,800);};

  // Character
  const newAbilities=(base=5,spread=2.2)=>{const o={};for(const [k] of ABILS)o[k]=roundHalf(clamp(rnd(base-spread,base+spread),1,10));return o;}
  const abilityTotal=(ab)=>ABILS.reduce((s,[k])=>s+ab[k],0);
  const genAbilitiesByRarity=(rar)=>{const r=rarityMeta(rar);const base=5.0*r.mult;const ab=newAbilities(base,2.3);for(const [k] of ABILS)ab[k]=roundHalf(clamp(ab[k]+(rar==="SSR"?0.5:rar==="SR"?0.2:0),1,10));return ab;}
  const calcBaseSalary=(posKey,ab)=>{const p=posByKey(posKey);const factor=0.75+(ab.prof+ab.lead+ab.act)/30*0.7;return p.baseSalary*factor;}
  const mkPerson=(opts={})=>{
    const id=opts.id || ("P"+Math.random().toString(16).slice(2)+Date.now().toString(16));
    const kind=opts.kind ?? "employee";
    const role=opts.role ?? pick(ROLES);
    const rarity=opts.rarity ?? pickRarity();
    const name=opts.name ?? ("æˆå‘˜"+Math.floor(rnd(10,99)));
    const portrait=opts.portrait ?? (opts.useAiPortrait!==false ? randomPortrait() : null);
    const abilities=opts.abilities ?? genAbilitiesByRarity(rarity);
    const skill=opts.skill ?? pickSkill(role,rarity);
    if(skill?.key==="procrastinate") abilities.act = roundHalf(clamp(abilities.act-1.0,1,10));
    const posKey=opts.position ?? (kind==="partner"?"dir":"staff");
    const salary=opts.salary ?? Math.round(calcBaseSalary(posKey, abilities));
    const equity=opts.equity ?? (kind==="partner"? roundHalf(clamp(rnd(1,8),1,30)) : 0);
    return {id,name,portrait,role,kind,rarity,gender:opts.gender??pick(GENDERS),age:opts.age??Math.floor(rnd(22,55)),abilities,skill,position:posKey,salary:Math.round(salary),equity,tenureM:0,active:true,resigned:false,dead:false};
  };

  const scheduleYearCrises=()=>{
    const months=new Set();
    while(months.size<2) months.add(Math.floor(rnd(1,13)));
    state.company.crisesPlan=[...months].sort((a,b)=>a-b);
  };

  if(!state.player){
    state.player=mkPerson({kind:"player",rarity:"SR",name:"åˆ›ä¸šè€…",role:"äº§å“"});
    state.player.id="player";
    state.player.position="owner";
    state.player.salary=0;
    scheduleYearCrises();
    log("good","æ¬¢è¿æ¥åˆ° V2.7ï¼ä¸»è§’æ˜¯ã€å…¬å¸æ‰€æœ‰äººã€ä¸”ä¸ä¼šç¦»èŒã€‚èµ„äº§å…è®¸ä¸ºè´Ÿï¼Œä½†è¿ç»­3ä¸ªæœˆè´Ÿèµ„äº§ä¼šå¤±è´¥ã€‚");
    save();
  } else {
    state.player.id="player";
    state.player.kind="player";
    state.player.position="owner";
    state.player.salary=0;
    if(!state.company.worldMarkets) state.company.worldMarkets=defaultWorldMarkets();
    if(state.company.negativeStreak==null) state.company.negativeStreak=0;
    if(state.company.rescueBuffMonths==null) state.company.rescueBuffMonths=0;
    if(state.company.negativeSwitchCount==null) state.company.negativeSwitchCount=0;
    if(state.company.gameOver==null){state.company.gameOver=false; state.company.gameOverReason="";}
    if(!state.love) state.love={};
    save();
  }

  const findPerson=(id)=>state.people.find(p=>p.id===id);
  const companySize=()=>state.people.filter(p=>p.active&&!p.dead).length+1;
  const activeEmployees=()=>state.people.filter(p=>p.active&&!p.dead&&p.kind==="employee");
  const activePartners=()=>state.people.filter(p=>p.active&&!p.dead&&p.kind==="partner");
  const marketLabel=(m)=>m>=1.25?"ç‰›å¸‚":m>=1.05?"åå¥½":m>=0.95?"å¹³ç¨³":m>=0.80?"åå¼±":"å¯’å†¬";
  const industryMeta=(k)=>INDUSTRIES.find(i=>i.key===k)||INDUSTRIES[0];
  const industryMarket=(k)=>state.company.worldMarkets?.[k] ?? 1.0;
  const currentIndustry=()=>industryMeta(state.company.industry);

  // Org/bonds
  const getSubs=(lid)=>state.relations[lid]||[];
  const setSubs=(lid,subs)=>state.relations[lid]=subs;
  const bondKey=(l,s)=>`${l}|${s}`;
  const getBond=(l,s)=>state.bonds[bondKey(l,s)]??0;
  const setBond=(l,s,v)=>state.bonds[bondKey(l,s)]=v;
  const removeFromRelations=(pid)=>{
    delete state.relations[pid];
    for(const lid of Object.keys(state.relations)){
      state.relations[lid]=state.relations[lid].filter(x=>x!==pid);
      if(state.relations[lid].length===0) delete state.relations[lid];
    }
    for(const k of Object.keys(state.bonds)){
      if(k.startsWith(pid+"|")||k.endsWith("|"+pid)) delete state.bonds[k];
    }
  };

  // Love helpers
  const loveKey=(a,b)=>[a,b].sort().join("|");
  const loveStageText=(s)=>s==="dating"?"æ‹çˆ±ä¸­":s==="conflict"?"å†²çªä¸­":"æœªçŸ¥";
  const getLove=(a,b)=>state.love[loveKey(a,b)]||null;
  const setLove=(a,b,obj)=>state.love[loveKey(a,b)]=obj;
  const delLove=(a,b)=>delete state.love[loveKey(a,b)];

  const computeContext=()=>{
    const ctx={revMult:1.0,payrollMult:1.0,resignMult:1.0,rdMult:1.0,crisisMult:1.0,marketLuck:0.0,bondMult:1.0,loveLuck:0.0,loveFragile:0.0};
    const staffCount=state.people.filter(p=>p.active&&!p.dead).length; // ä¸å«ä¸»è§’
    const scaleLevel = staffCount>=26?5:staffCount>=13?4:staffCount>=7?3:staffCount>=3?2:1;

    // è§„æ¨¡è¶Šå¤§ï¼šç®¡ç†æˆæœ¬è¶Šé«˜ã€ç¦»èŒå‹åŠ›è¶Šé«˜ï¼ˆæ¸¸æˆæ›´å›°éš¾ï¼‰
    const mgmtCost = 1 + Math.max(0,staffCount-3)*0.015 + (scaleLevel-1)*0.06;
    const mgmtResign = 1 + Math.max(0,staffCount-6)*0.010 + (scaleLevel-1)*0.05;

    ctx.payrollMult *= mgmtCost;
    ctx.resignMult  *= mgmtResign;

    const team=[state.player,...state.people.filter(p=>p.active&&!p.dead)];
    for(const p of team){ if(p.skill?.apply) p.skill.apply(ctx,p); }

    if(state.company.rescueBuffMonths>0){
      ctx.revMult *= 1.10;
      ctx.resignMult *= 0.85;
    }
    // ç«äº‰å¯¹æ‰‹ä¸´æ—¶debuff
    const rd=state.company.rivalDebuff;
    if(rd && rd.months>0){
      ctx.revMult *= (rd.rev||1);
      ctx.resignMult *= (rd.resign||1);
    }
    return ctx;
  };

  // PCS + contribution
  const calcPCS=(p)=>{
    const a=p.abilities;
    const pcs=0.25*a.prof+0.20*a.act+0.15*a.innov+0.15*a.insight+0.15*a.learn+0.10*a.eq;
    return Math.round(pcs*100)/100;
  };
  const pcsToMult=(pcs)=>Math.round((0.70 + pcs/35)*100)/100;
  const contributionTable=()=>{
    const team=[state.player,...state.people.filter(p=>p.active&&!p.dead)];
    const items=team.map(p=>{const pcs=calcPCS(p);const mult=pcsToMult(pcs);return {id:p.id,name:p.name,pcs,mult,role:p.role,rarity:p.rarity};});
    const sum=items.reduce((s,x)=>s+x.mult,0)||1;
    for(const it of items) it.share=it.mult/sum;
    return items.sort((a,b)=>b.mult-a.mult);
  };

  const teamBonusMultiplier=()=>{
    const team=[state.player,...state.people.filter(p=>p.active&&!p.dead)];
    const avgTotal=team.reduce((s,p)=>s+abilityTotal(p.abilities),0)/(team.length*80);
    const abilityMult=0.80 + avgTotal*0.75;

    let pairs=0,bondBonus=0;
    for(const lid of Object.keys(state.relations)) pairs += getSubs(lid).filter(id=>{const q=findPerson(id);return q&&q.active&&!q.dead;}).length;
    for(const k of Object.keys(state.bonds)) bondBonus += (state.bonds[k]||0)*0.003;
    const structureMult=1 + Math.min(0.35, pairs*0.015) + Math.min(0.25, bondBonus);

    let loveMult=1.0;
    for(const k of Object.keys(state.love)){
      const rel=state.love[k];
      if(!rel) continue;
      if(rel.stage==="dating") loveMult*=1.01;
      if(rel.stage==="conflict") loveMult*=0.99;
    }
    loveMult=clamp(loveMult,0.92,1.12);

    return abilityMult*structureMult*loveMult;
  };

  const revenueBreakdown=()=>{
    const base=currentIndustry().baseRev;
    const m=industryMarket(state.company.industry);
    const ctx=computeContext();
    const teamMult=teamBonusMultiplier();
    const marketPart=0.5+0.5*m;
    const randMult=Math.round((0.96+Math.random()*0.08)*1000)/1000;
    const revenue=Math.round(base*teamMult*marketPart*ctx.revMult*randMult);
    return {base,market:m,marketPart,teamMult,skillMult:ctx.revMult,randMult,revenue,industry:currentIndustry().name};
  };

  const totalPayroll=()=>{
    const ctx=computeContext();
    const em=activeEmployees().reduce((s,p)=>s+p.salary,0);
    const rev=state.company.revenueLast || revenueBreakdown().revenue;
    const partnerPay=activePartners().reduce((s,p)=>s+Math.round(rev*(p.equity/100)*0.35),0);
    return {employeePayroll:Math.round(em*ctx.payrollMult), partnerPay, total:Math.round(em*ctx.payrollMult + partnerPay)};
  };

  const enforceSalaryOrder=()=>{
    const all=activeEmployees();
    all.sort((a,b)=>rankOf(a.position)-rankOf(b.position));
    let maxLower=0;
    for(const pos of POSITIONS){
      if(pos.key==="owner") continue;
      const group=all.filter(x=>x.position===pos.key);
      if(!group.length) continue;
      for(const g of group) if(g.salary<=maxLower) g.salary=maxLower+100;
      maxLower=Math.max(maxLower, ...group.map(g=>g.salary));
    }
  };

  const resignProbability=(p)=>{
    const ctx=computeContext();
    let prob=0.015 + p.tenureM*0.002;
    if(p.abilities.eq<4) prob += (4-p.abilities.eq)*0.012;

    let base=calcBaseSalary(p.position,p.abilities);
    if(p.skill?.key==="high_cost") base*=1.20;
    if(p.salary<base*0.85) prob+=0.02;
    prob += Math.min(0.04, state.company.layoffsLast6M*0.006);

    let bondReduce=0;
    for(const lid of Object.keys(state.relations)){
      if(getSubs(lid).includes(p.id)) bondReduce += getBond(lid,p.id)*0.006;
    }
    prob = clamp(prob-bondReduce,0,0.35);
    prob *= ctx.resignMult;
    if(state.company.moraleBuffMonths>0) prob *= 0.85;

    if(p.skill?.key==="mood_swing" && industryMarket(state.company.industry)<0.90) prob = clamp(prob*2+0.12,0,0.35);

    for(const k of Object.keys(state.love)){
      const rel=state.love[k];
      if(rel && (rel.a===p.id||rel.b===p.id) && rel.stage==="conflict") prob=clamp(prob+0.03,0,0.35);
    }

    return clamp(prob,0,0.35);
  };

  const applyMonthlyResignations=()=>{
    for(const e of activeEmployees()){
      const prob=resignProbability(e);
      if(Math.random()<prob){
        e.active=false; e.resigned=true;
        log("warn", story("warn", `ç¦»èŒï¼š${e.name} é€’äº¤äº†è¾å‘ˆ`, [
          `å²—ä½ï¼š${positionName(e.position)} Â· ä»»æœŸï¼š${e.tenureM}ä¸ªæœˆ`,
          "ç¦»èŒé£é™©æç¤ºï¼šæƒ…å•†/è–ªèµ„/ä»»æœŸ/è£å‘˜/æ‹çˆ±å†²çªéƒ½ä¼šå½±å“ç¨³å®šæ€§ã€‚",
          "å»ºè®®ï¼šæ™‹å‡æˆ–åŠ è–ªã€ç»™æ›´æ¸…æ™°çš„æˆé•¿è·¯å¾„ã€å»ºç«‹ç›´å±å…³ç³»ä¸ç¾ç»Šã€‚"
        ]));
        removeFromRelations(e.id);
        for(const k of Object.keys(state.love)){
          const rel=state.love[k];
          if(rel && (rel.a===e.id||rel.b===e.id)){ delLove(rel.a,rel.b); log("warn",`ã€æ‹çˆ±ã€‘ç”±äºç¦»èŒï¼Œ${rel.aName} ä¸ ${rel.bName} çš„å…³ç³»ç»“æŸã€‚`); }
        }
      }
    }
  };

  const monthlyPlayerOpsEvent=()=>{
    const isBuff=Math.random()<0.70;
    const delta=roundHalf(rnd(0.5,1.5));
    const [k,cn]=pick(ABILS);
    const before=state.player.abilities[k];
    state.player.abilities[k]=roundHalf(clamp(before+(isBuff?delta:-delta),1,10));
    const flavor = isBuff ? pickLine(opBuffFlavors) : pickLine(opDebuffFlavors);
    const title = isBuff ? "è¿è¥æˆé•¿ï¼šä½ æŠŠå±€é¢ç¨³ä½äº†" : "è¿è¥æŒ«æŠ˜ï¼šèŠ‚å¥è¢«æ‰“ä¹±";
    log(isBuff?"good":"bad", story(isBuff?"good":"bad", title, [
      flavor,
      `ä¸»è§’èƒ½åŠ›å˜åŒ–ï¼š${cn} ${isBuff?"+":"-"}${delta}ï¼ˆ${before}â†’${state.player.abilities[k]}ï¼‰`
    ]));
  };

  const worldMarketNews=()=>{
    const ctx=computeContext();
    for(const ind of INDUSTRIES){
      const before=industryMarket(ind.key);
      const drift=rnd(-0.10,0.10) + (Math.random()<0.5? ctx.marketLuck*0.03 : ctx.marketLuck*0.01);
      state.company.worldMarkets[ind.key]=clamp(roundHalf(before+drift),0.6,1.4);
    }
    const cur=state.company.industry;
    const m=industryMarket(cur);
    log("warn", story("warn", `ä¸–ç•Œè¡Œæƒ…æ’­æŠ¥ï¼š${industryMeta(cur).name} Â· ${marketLabel(m)}`, [
      `è¡Œä¸šæŒ‡æ•°ï¼š${m.toFixed(2)}ã€‚${descMarket(m)}`,
      `å¸‚åœºä¼ é—»ï¼š${randomNews()}`
    ]));
  };

  const runCrisisIfDue=()=>{
    const m=state.company.month;
    if(!state.company.crisesPlan.includes(m)) return;
    const ctx=computeContext();
    const t=pick(["è‚¡å¸‚å¤§è·Œ","å›½é™…æ”¿æ²»å†²å‡»","å‘˜å·¥å®¶å±ç”Ÿç—…","å‘˜å·¥çªå‘é‡ç—…","å‘˜å·¥ç¦»ä¸–"]);
    if(t==="è‚¡å¸‚å¤§è·Œ"){
      const drop=roundHalf(rnd(0.1,0.35));
      for(const ind of INDUSTRIES){
        const before=industryMarket(ind.key);
        state.company.worldMarkets[ind.key]=clamp(roundHalf(before-drop*rnd(0.6,1.0)),0.6,1.4);
      }
      const loss=Math.round(Math.abs(state.company.assets)*rnd(0.02,0.06)*ctx.crisisMult);
      state.company.assets-=loss;
      log("bad", story("bad", "å¹´åº¦å˜æ•…ï¼šè‚¡å¸‚å¤§è·Œ", [
      pickLine(crisisFlavors.stock),
      `èµ„äº§æŸå¤±ï¼š-${fmtMoney(loss)}ï¼ˆå·²å—å±æœºå…¬å…³æŠ€èƒ½å½±å“ï¼‰`,
      "å»ºè®®ï¼šç¼©çŸ­å›æ¬¾å‘¨æœŸã€æ§åˆ¶å›ºå®šæˆæœ¬ã€ä¿ç•™ç°é‡‘å®‰å…¨å«ã€‚"
    ]));
    }else if(t==="å›½é™…æ”¿æ²»å†²å‡»"){
      for(const ind of INDUSTRIES){
        const before=industryMarket(ind.key);
        state.company.worldMarkets[ind.key]=clamp(roundHalf(before-rnd(0.05,0.25)),0.6,1.4);
      }
      log("warn", story("warn", "å¹´åº¦å˜æ•…ï¼šå›½é™…æ”¿æ²»å†²å‡»", [
      pickLine(crisisFlavors.geo),
      "æ•ˆæœï¼šä¸–ç•Œè¡Œæƒ…æ•´ä½“åå¼±ï¼ˆçŸ­æœŸä¸ç¡®å®šæ€§ä¸Šå‡ï¼‰ã€‚"
    ]));
    }else if(t==="å‘˜å·¥å®¶å±ç”Ÿç—…"){
      const pool=[...activeEmployees(),...activePartners()];
      const emp=pool.length?pick(pool):null;
      if(!emp){log("warn","ã€å¹´åº¦å˜æ•…ã€‘å®¶åº­äº‹ä»¶å‡ºç°ï¼Œä½†å…¬å¸è§„æ¨¡å¤ªå°ï¼Œå½±å“æœ‰é™ã€‚");return;}
      const cost=Math.round(rnd(5000,25000)*(companySize()/5)*ctx.crisisMult);
      state.company.assets-=cost;
      const [k,cn]=pick(ABILS);
      const d=roundHalf(rnd(0.5,1.5));
      emp.abilities[k]=roundHalf(clamp(emp.abilities[k]-d,1,10));
      log("bad", story("bad", "å¹´åº¦å˜æ•…ï¼šå®¶åº­çªå‘äº‹ä»¶", [
      `${emp.name} å®¶å±ç”Ÿç—…ï¼š${pickLine(crisisFlavors.family)}`,
      `é¢å¤–æ”¯å‡ºï¼š${fmtMoney(cost)}`,
      `èƒ½åŠ›æ³¢åŠ¨ï¼š${cn}-${d}`
    ]));
    }else if(t==="å‘˜å·¥çªå‘é‡ç—…"){
      const emp=activeEmployees().length?pick(activeEmployees()):null;
      if(!emp){log("warn","ã€å¹´åº¦å˜æ•…ã€‘ç–¾ç—…äº‹ä»¶å‡ºç°ï¼Œä½†å½“å‰æ— å‘˜å·¥ï¼Œå½±å“æœ‰é™ã€‚");return;}
      const cost=Math.round(rnd(8000,40000)*ctx.crisisMult);
      state.company.assets-=cost;
      const [k,cn]=pick(ABILS);
      const d=roundHalf(rnd(1.0,2.0));
      emp.abilities[k]=roundHalf(clamp(emp.abilities[k]-d,1,10));
      if(Math.random()<0.35){ emp.active=false; emp.resigned=true; removeFromRelations(emp.id); log("bad", story("bad", "å¹´åº¦å˜æ•…ï¼šå‘˜å·¥çªå‘é‡ç—…ï¼ˆç¦»èŒä¼‘å…»ï¼‰", [
      `${emp.name} çªå‘é‡ç—…ï¼š${pickLine(crisisFlavors.sick)}`,
      `æ”¯å‡ºï¼š${fmtMoney(cost)}ï¼›èƒ½åŠ›ï¼š${cn}-${d}`,
      "ç»“æœï¼šç¦»èŒä¼‘å…»ï¼ˆæœªæ¥æŠ½å¡å¯èƒ½å›å½’ï¼Œä¿ç•™ç¦»èŒå‰æ•°æ®ï¼‰ã€‚"
    ])); }
      else log("bad", story("bad", "å¹´åº¦å˜æ•…ï¼šå‘˜å·¥çªå‘é‡ç—…", [
      `${emp.name} çªå‘é‡ç—…ï¼š${pickLine(crisisFlavors.sick)}`,
      `æ”¯å‡ºï¼š${fmtMoney(cost)}ï¼›èƒ½åŠ›ï¼š${cn}-${d}`
    ]));
    }else{
      const pool=[...activeEmployees(),...activePartners()];
      const emp=pool.length?pick(pool):null;
      if(!emp){log("warn","ã€å¹´åº¦å˜æ•…ã€‘ç¦»ä¸–äº‹ä»¶å‡ºç°ï¼Œä½†å…¬å¸è§„æ¨¡å¤ªå°ï¼Œå½±å“æœ‰é™ã€‚");return;}
      emp.dead=true; emp.active=false; emp.resigned=false; removeFromRelations(emp.id);
      log("bad", story("bad", "å¹´åº¦å˜æ•…ï¼šä¸å¹¸ç¦»ä¸–", [
      `${emp.name} ç¦»ä¸–ï¼š${pickLine(crisisFlavors.death)}`,
      "ç»“æœï¼šæ°¸ä¹…æ¶ˆå¤±ï¼ˆæ— æ³•å†æŠ½åˆ°ï¼‰ã€‚"
    ]));
      for(const k of Object.keys(state.love)){
        const rel=state.love[k];
        if(rel && (rel.a===emp.id||rel.b===emp.id)){ delLove(rel.a,rel.b); log("bad",`ã€æ‹çˆ±ã€‘å› ç¦»ä¸–ï¼Œ${rel.aName} ä¸ ${rel.bName} çš„å…³ç³»æ°¸ä¹…ç»“æŸã€‚`); }
      }
    }
  };

  const teamActivityCost=()=>Math.round(4000 + companySize()*1600);
  const doTeamActivity=()=>{
    if(state.company.teamActivityUsedMonth===state.company.month){log("warn","æœ¬æœˆå›¢å»ºå·²ä½¿ç”¨ï¼ˆæ¯æœˆæœ€å¤šä¸€æ¬¡ï¼‰ã€‚");return;}
    const cost=teamActivityCost();
    state.company.assets-=cost;
    const all=[state.player,...state.people.filter(p=>p.active&&!p.dead)];
    for(const p of all){const [k,cn]=pick(ABILS);const d=roundHalf(rnd(0.5,1.5));p.abilities[k]=roundHalf(clamp(p.abilities[k]+d,1,10));}
    state.company.teamActivityUsedMonth=state.company.month;
    log("good", story("good", "å›¢å»ºï¼šå›¢é˜Ÿæ°”æ°›å›æš–", [
      `æŠ•å…¥ï¼š${fmtMoney(cost)}ï¼ˆéšäººæ•°å¢é•¿ï¼‰`,
      "æ•ˆæœï¼šå…¨å‘˜éšæœºèƒ½åŠ› +0.5~1.5ï¼ˆå½“æœˆæœ€å¤šä¸€æ¬¡ï¼‰",
      "å°è´´å£«ï¼šå›¢å»ºå¯¹ç¨³å®šå›¢é˜Ÿæœ‰æ•ˆï¼Œä½†åˆ«åœ¨ç°é‡‘æåº¦ç´§å¼ æ—¶ç¡¬ä¸Šã€‚"
    ]));
    save(); render();
  };
  const doAnnualMeeting=(choice)=>{
    if(state.company.annualMeetingUsedYear===state.company.year){log("warn","æœ¬å¹´åº¦å¹´ä¼šå·²ä½¿ç”¨ã€‚");return;}
    if(choice==="cash"){const gain=Math.round(Math.abs(state.company.assets)*0.10);state.company.assets+=gain;log("good", story("good", "å¹´ä¼šï¼šé€‰æ‹©ç°é‡‘çº¢åˆ©", [
        `å…¬å¸æ”¶åˆ°ä¸€ç¬”â€œå¹´ç»ˆå¥–é‡‘æ± â€ï¼š+${fmtMoney(gain)}ï¼ˆå½“å‰èµ„äº§çš„10%ï¼‰`,
        "é€‚ç”¨ï¼šç°é‡‘å‹åŠ›å¤§ã€å‡†å¤‡è½¬è¡Œæˆ–å¯¹å†²é£é™©æ—¶ã€‚"
      ]));}
    else{const all=[state.player,...state.people.filter(p=>p.active&&!p.dead)];for(const p of all){const [k,cn]=pick(ABILS);p.abilities[k]=roundHalf(clamp(p.abilities[k]+0.5,1,10));}log("good", story("good", "å¹´ä¼šï¼šé€‰æ‹©èƒ½åŠ›æˆé•¿", [
        "å…¨å‘˜éšæœºèƒ½åŠ› +0.5ï¼ˆå…è´¹ï¼Œæ¯å¹´ä¸€æ¬¡ï¼‰",
        "é€‚ç”¨ï¼šæƒ³æ‹‰å¼€é•¿æœŸå·®è·ã€åŸ¹å…»éª¨å¹²ã€æå‡ç»„ç»‡ä¸Šé™æ—¶ã€‚"
      ]));}
    state.company.annualMeetingUsedYear=state.company.year;
    save(); render();
  };

  // Gacha + name
  const N1=["æ—","è‹","èµµ","å‘¨","å´","éƒ‘","ç‹","æ","é™ˆ","å¼ ","åˆ˜","é»„","ä½•","å®‹","å”","è®¸","é«˜","å­”","è¢","å†¯","å½­","é­","è°¢","é‚“","å§œ"];
  const N2=["æ™¨","é›¨","ç„¶","æ³½","å®‡","å®","å˜‰","æ¬£","æ¶µ","æ˜Š","è‹¥","ç‘¶","åš","ç³","éª","å¦","æ¸…","å“²","ç†™","ç‘¾","å½¤","é“­","èˆª","é€¸","çª","éœ–"];
  const genName=()=>pick(N1)+pick(N2);

  const pullOne=(paid=true)=>{
    const cost=paid?5000:0;
    state.company.assets-=cost;
    state.gacha.pulls++;
    state.gacha.pitySSR++;
    let rar=pickRarity();
    if(state.gacha.pitySSR>=20 && Math.random()<0.35) rar="SSR";
    if(state.gacha.pitySSR>=40) rar="SSR";
    if(rar==="SSR") state.gacha.pitySSR=0;

    const upRole=state.company.upRole || "é”€å”®";
    const isUp = (Math.random()<0.35);
    const role = isUp ? upRole : pick(ROLES);

    const p=mkPerson({rarity:rar, role, name:genName(), useAiPortrait:true});
    state.people.push(p);
    log(rar==="SSR"?"good":rar==="SR"?"warn":"warn",`ã€æŠ½å¡ã€‘è·å¾— ${rar} Â· ${p.role} Â· ${p.name}ï¼ˆ${p.skill.type==="neg"?"è´Ÿé¢":"æ­£é¢"}ï¼š${p.skill.name}ï¼‰ã€‚`);
    save(); render();
    return p;
  };

  // Position rules
  const canHoldPosition=(person,posKey)=>{
    const p=posByKey(posKey);
    if(posKey==="owner") return {ok:false,why:"åªæœ‰ä¸»è§’å¯ä»¥æ˜¯å…¬å¸æ‰€æœ‰äººã€‚"};
    if(person.abilities.manage < p.minManage) return {ok:false,why:`ç®¡ç†èƒ½åŠ›ä¸è¶³ï¼ˆéœ€â‰¥${p.minManage}ï¼‰`};
    if(companySize() < p.minSize) return {ok:false,why:`å…¬å¸è§„æ¨¡ä¸è¶³ï¼ˆéœ€â‰¥${p.minSize}äººï¼‰`};
    return {ok:true};
  };

  const promote=(pid,newPos)=>{
    const p=findPerson(pid); if(!p||!p.active||p.dead) return;
    const r=canHoldPosition(p,newPos);
    if(!r.ok){log("bad",`æ— æ³•ä»»å‘½ï¼š${p.name}â†’${positionName(newPos)}ï¼š${r.why}ã€‚`);return;}
    p.position=newPos;
    const base=calcBaseSalary(newPos,p.abilities);
    p.salary=Math.round(Math.max(p.salary, base*1.02));
    enforceSalaryOrder();
    log("good",`ã€ä»»å‘½ã€‘${p.name} æ™‹å‡ä¸º ${positionName(newPos)}ï¼Œæ–°æœˆè–ªçº¦ ${fmtMoney(p.salary)}ã€‚`);
    save(); render();
  };
  const raise=(pid,amount)=>{
    const p=findPerson(pid); if(!p||!p.active||p.dead) return;
    amount=Math.max(100,Math.round(amount||0));
    p.salary+=amount;
    enforceSalaryOrder();
    log("good",`ã€åŠ è–ªã€‘${p.name} æœˆè–ª +${fmtMoney(amount)} â†’ ${fmtMoney(p.salary)}ã€‚`);
    save(); render();
  };
  const fire=(pid)=>{
    const p=findPerson(pid); if(!p||!p.active||p.dead) return;
    p.active=false; p.resigned=true;
    state.company.layoffsThisYear++; state.company.layoffsLast6M++;
    removeFromRelations(pid);
    log("warn",`ã€è£å‘˜ã€‘ä½ è§£é›‡äº† ${p.name}ã€‚è£å‘˜è¿‡é¢‘å¯èƒ½è§¦å‘è´Ÿé¢äº‹ä»¶ã€‚`);
    if(state.company.layoffsLast6M>=3 && Math.random()<0.35){
      const loss=Math.round(rnd(8000,35000)*state.company.layoffsLast6M/2);
      state.company.assets-=loss;
      for(const ind of INDUSTRIES){
        const before=industryMarket(ind.key);
        state.company.worldMarkets[ind.key]=clamp(roundHalf(before-rnd(0.02,0.10)),0.6,1.4);
      }
      log("bad", story("bad", "è´Ÿé¢èˆ†è®ºï¼šé¢‘ç¹è£å‘˜å‘é…µ", [
        pickLine(layoffFlavors),
        `èµ„äº§æŸå¤±ï¼š-${fmtMoney(loss)}ï¼›å¤–éƒ¨è§‚æœ›æƒ…ç»ªä¸Šå‡ã€‚`,
        "æç¤ºï¼šç”¨æ›´æ¸…æ™°çš„æˆ˜ç•¥è§£é‡Šã€åˆç†è¡¥å¿ã€ä¸å…³é”®äººæ‰æ²Ÿé€šï¼Œå¯é™ä½åç»­å†²å‡»ã€‚"
      ]));
    }
    for(const k of Object.keys(state.love)){
      const rel=state.love[k];
      if(rel && (rel.a===p.id||rel.b===p.id)){ delLove(rel.a,rel.b); log("warn",`ã€æ‹çˆ±ã€‘è£å‘˜å¯¼è‡´ ${rel.aName} ä¸ ${rel.bName} çš„å…³ç³»ç»“æŸã€‚`); }
    }
    save(); render();
  };

  // Org assignment
  const assignSub=(leaderId, subId)=>{
    if(leaderId===subId) return;
    const isCycle=(a,b)=>{
      const dfs=(x)=>{
        const subs=getSubs(x);
        if(subs.includes(a)) return true;
        for(const s of subs) if(dfs(s)) return true;
        return false;
      };
      return dfs(b);
    };
    if(isCycle(leaderId, subId)){log("bad","æ— æ³•è®¾ç½®ï¼šä¼šå½¢æˆå¾ªç¯æ±‡æŠ¥å…³ç³»ã€‚");return;}
    for(const lid of Object.keys(state.relations)){
      state.relations[lid]=state.relations[lid].filter(x=>x!==subId);
      if(state.relations[lid].length===0) delete state.relations[lid];
    }
    const arr=getSubs(leaderId);
    if(!arr.includes(subId)) arr.push(subId);
    setSubs(leaderId, arr);
    if(getBond(leaderId,subId)===0) setBond(leaderId,subId,0.5);
    const leaderName=leaderId==="player"?state.player.name:(findPerson(leaderId)?.name||leaderId);
    log("good",`ã€ç»„ç»‡ã€‘å·²è®¾ç½®ï¼š${leaderName} â†’ ${findPerson(subId)?.name}ï¼ˆç›´å±ï¼‰ã€‚`);
    save(); render();
  };
  const unassignSub=(leaderId, subId)=>{
    const arr=getSubs(leaderId).filter(x=>x!==subId);
    if(arr.length) setSubs(leaderId,arr); else delete state.relations[leaderId];
    log("warn","ã€ç»„ç»‡ã€‘å·²å–æ¶ˆç›´å±å…³ç³»ã€‚");
    save(); render();
  };

  // Portrait upload
  const compressImageToDataURL=(file,maxSize=256,quality=0.82)=>new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload=()=>{
      const img=new Image();
      img.onload=()=>{
        const canvas=document.createElement("canvas");
        const scale=Math.min(maxSize/img.width,maxSize/img.height,1);
        const w=Math.round(img.width*scale), h=Math.round(img.height*scale);
        canvas.width=w; canvas.height=h;
        const ctx=canvas.getContext("2d");
        ctx.drawImage(img,0,0,w,h);
        resolve(canvas.toDataURL("image/jpeg",quality));
      };
      img.onerror=reject; img.src=reader.result;
    };
    reader.onerror=reject; reader.readAsDataURL(file);
  });
  const attachPortrait=async(personId,file)=>{
    const p=(personId==="player")?state.player:findPerson(personId);
    if(!p) return;
    try{
      p.portrait=await compressImageToDataURL(file,256,0.82);
      log("good",`ã€è‚–åƒã€‘å·²æ›´æ–° ${p.name} çš„ç…§ç‰‡è‚–åƒã€‚`);
      save(); render();
    }catch(e){
      log("bad","ã€è‚–åƒã€‘å›¾ç‰‡å¤„ç†å¤±è´¥ï¼ˆè¯·æ¢ä¸€å¼ æˆ–æ›´å°çš„å›¾ç‰‡ï¼‰ã€‚");
      save(); render();
    }
  };

  // è½¬è¡Œç³»ç»Ÿ
  const gameOver=(reason)=>{
    state.company.gameOver=true;
    state.company.gameOverReason=reason;
    log("bad",`ã€æ¸¸æˆå¤±è´¥ã€‘${reason}`);
  };

  const switchIndustry=(toKey)=>{
    const fromKey=state.company.industry;
    if(toKey===fromKey) return;
    const inDebt = state.company.assets < 0;
    const baseLoss = 60000 + companySize()*9000;
    const extraLoss = Math.max(0, Math.round(Math.abs(state.company.assets)*0.08));
    let loss = Math.round(baseLoss + extraLoss);
    const lucky = Math.random() < 0.08;
    if(lucky){
      const offset=Math.round(loss*rnd(0.35,0.85));
      loss=Math.max(0,loss-offset);
      log("good", story("good", "è½¬è¡Œå¥‡é‡ï¼šå…³é”®èµ„æºä»å¤©è€Œé™", [
      "ä½ é‡åˆ°äº†ä¸€æ¬¡æ„å¤–çš„è´µäºº/æ¸ é“/è®¢å•æ”¯æŒã€‚",
      `è½¬è¡ŒæŸå¤±å‡å°‘ï¼š${fmtMoney(offset)}ï¼ˆå¤§å¹…ç¼“å†²å†²å‡»ï¼‰`
    ]));
    }
    state.company.assets -= loss;
    state.company.industry = toKey;

    if(inDebt){
      state.company.rescueBuffMonths = 24;
      state.company.negativeSwitchCount += 1;
      log("warn", story("warn", "è´Ÿèµ„äº§è½¬è¡Œï¼šèƒŒæ°´ä¸€æˆ˜çš„æ•‘åŠ©æœŸ", [
      `è§¦å‘ 2 å¹´æ•‘åŠ©Buffï¼šè¥æ”¶+10%ã€ç¦»èŒ-15%ï¼ˆå‰©ä½™ ${state.company.rescueBuffMonths} ä¸ªæœˆï¼‰`,
      `è´Ÿèµ„äº§è½¬è¡Œæ¬¡æ•°ï¼š${state.company.negativeSwitchCount}/2ï¼ˆè¶…è¿‡2æ¬¡ç›´æ¥å¤±è´¥ï¼‰`,
      "å™äº‹ï¼šä½ ç”¨æœ€åçš„ç­¹ç æ¢æ¥äº†å–˜æ¯ç©ºé—´â€”â€”ä½†å¿…é¡»åœ¨æ•‘åŠ©æœŸå†…é‡å»ºç°é‡‘æµã€‚"
    ]));
      if(state.company.negativeSwitchCount>2){
        gameOver(`è´Ÿèµ„äº§æƒ…å†µä¸‹è½¬è¡Œè¶…è¿‡ä¸¤æ¬¡ï¼ˆ${state.company.negativeSwitchCount} æ¬¡ï¼‰ã€‚`);
      }
    }

    log("warn", story("warn", "æˆ˜ç•¥è½¬å‘ï¼šå…¬å¸æ›´æ¢èµ›é“", [
      `ä»ï¼š${industryMeta(fromKey).name} â†’ åˆ°ï¼š${industryMeta(toKey).name}`,
      `ä¸€æ¬¡æ€§è½¬è¡ŒæŸå¤±ï¼š-${fmtMoney(loss)}ï¼ˆåŒ…å«æœºä¼šæˆæœ¬ä¸é‡å»ºæˆæœ¬ï¼‰`,
      "æç¤ºï¼šè½¬è¡Œåå»ºè®®å°½å¿«è°ƒæ•´ç»„ç»‡æ¶æ„ä¸å²—ä½é…ç½®ï¼Œé¿å…â€œæ—§æ‰“æ³•â€æ‹–ç´¯æ–°èµ›é“ã€‚"
    ]));
    save(); render();
  };

  // æ‹çˆ±ç³»ç»Ÿ
  const loveMonthly=()=>{
    const ctx=computeContext();
    const emps=[...activeEmployees(), ...activePartners()];
    if(emps.length<2) return;

    for(const key of Object.keys(state.love)){
      const rel=state.love[key];
      if(!rel) continue;
      const a=findPerson(rel.a), b=findPerson(rel.b);
      if(!a||!b||a.dead||b.dead||!a.active||!b.active){ delLove(rel.a,rel.b); continue; }
      rel.months += 1;

      const avgEQ=(a.abilities.eq+b.abilities.eq)/2;
      const basePos=0.55 + (avgEQ-5)*0.05 + ctx.loveLuck;
      const posProb=clamp(basePos,0.15,0.85);

      let conflictBias=0;
      if(a.skill?.key==="conflict"||b.skill?.key==="conflict") conflictBias += 0.12;
      if(a.skill?.key==="fragile_heart"||b.skill?.key==="fragile_heart") conflictBias += 0.08;

      const eventChance=0.18;
      if(Math.random()<eventChance){
        const isPos = Math.random() < clamp(posProb - conflictBias, 0.05, 0.90);
        if(isPos){
          const [k1,cn1]=pick(ABILS), [k2,cn2]=pick(ABILS);
          a.abilities[k1]=roundHalf(clamp(a.abilities[k1]+0.5,1,10));
          b.abilities[k2]=roundHalf(clamp(b.abilities[k2]+0.5,1,10));
          rel.stage="dating";
          log("good", story("good", "æ‹çˆ±å¥½äº‹ï¼šå…³ç³»å‡æ¸©", [
          pickLine(loveGoodFlavors),
          `${a.name} è·å¾—ï¼š${cn1}+0.5ï¼›${b.name} è·å¾—ï¼š${cn2}+0.5`
        ]));
        }else{
          rel.stage = (Math.random()<0.55) ? "conflict" : "breakup";
          const drop=roundHalf(rnd(0.5,1.5));
          const [k,cn]=pick(ABILS);
          const extra = (a.skill?.key==="fragile_heart"||b.skill?.key==="fragile_heart"||Math.random()<ctx.loveFragile) ? 0.5 : 0;
          const totalDrop=roundHalf(drop+extra);
          (Math.random()<0.5?a:b).abilities[k]=roundHalf(clamp((Math.random()<0.5?a:b).abilities[k]-totalDrop,1,10));
          if(rel.stage==="breakup"){
            log("bad", story("bad", "æ‹çˆ±åˆ†æ‰‹ï¼šå…³ç³»ç ´è£‚", [
            pickLine(loveBadFlavors),
            `æƒ…ç»ªå½±å“ï¼š${cn}-${totalDrop}ï¼ˆå…¶ä¸­åŒ…å«è„†å¼±åŠ æˆå¯èƒ½æ›´é‡ï¼‰`,
            "æç¤ºï¼šå…³é”®å²—ä½å‘ç”Ÿåˆ†æ‰‹åï¼Œç¦»èŒé£é™©ä¼šå‡é«˜ã€‚"
          ]));
            delLove(rel.a,rel.b);
          }else{
            log("warn", story("warn", "æ‹çˆ±å†²çªï¼šå†·æˆ˜ä¸è¯¯ä¼š", [
            pickLine(loveBadFlavors),
            `èƒ½åŠ›æ³¢åŠ¨ï¼š${cn}-${totalDrop}ï¼ˆå…³ç³»è¿›å…¥å†²çªæœŸï¼‰`,
            "æç¤ºï¼šå†²çªæœŸè¶Šä¹…ï¼Œåç»­ç¦»èŒ/åˆ†æ‰‹æ¦‚ç‡è¶Šé«˜ã€‚"
          ]));
          }
        }
      }

      if(rel.stage==="conflict" && rel.months>=6 && Math.random()<0.12){
        const who=Math.random()<0.5?a:b;
        if(who.kind==="employee"){
          who.active=false; who.resigned=true; removeFromRelations(who.id);
          log("bad", story("bad", "æ‹çˆ±åæœï¼šé•¿æœŸå†²çªå¼•å‘ç¦»èŒ", [
          `${who.name} åœ¨å‹åŠ›ä¸‹é€‰æ‹©ç¦»èŒï¼ˆå…¬å¸å¤±å»ä¸€åæˆå‘˜ï¼‰ã€‚`,
          "å»ºè®®ï¼šå»ºç«‹æ›´æ¸…æ™°çš„å·¥ä½œè¾¹ç•Œä¸æ²Ÿé€šæœºåˆ¶ï¼Œé™ä½â€œå…³ç³»å¤–æº¢â€é£é™©ã€‚"
        ]));
          delLove(rel.a,rel.b);
        }
      }
    }

    const single=emps.filter(p=>{
      for(const k of Object.keys(state.love)){ const rel=state.love[k]; if(rel && (rel.a===p.id||rel.b===p.id)) return false; }
      return true;
    });
    if(single.length<2) return;

    const baseChance = clamp(0.02 + single.length*0.002, 0.02, 0.10);
    if(Math.random()<baseChance){
      const a=pick(single);
      const candidates=single.filter(x=>x.id!==a.id && Math.abs(x.age-a.age)<=5);
      const b=candidates.length?pick(candidates):pick(single.filter(x=>x.id!==a.id));
      const avgEQ=(a.abilities.eq+b.abilities.eq)/2;
      let okProb=clamp(0.35 + (avgEQ-5)*0.08 + computeContext().loveLuck, 0.10, 0.80);
      if(a.skill?.key==="conflict"||b.skill?.key==="conflict") okProb=clamp(okProb-0.15,0.05,0.80);
      if(Math.random()<okProb){
        setLove(a.id,b.id,{a:a.id,b:b.id,aName:a.name,bName:b.name,stage:"dating",months:0});
        log("warn", story("warn", "åŠå…¬å®¤æ‹æƒ…ï¼šä¸€æ®µå…³ç³»å¼€å§‹äº†", [
        `${a.name} ä¸ ${b.name} å› é¢‘ç¹åä½œäº§ç”Ÿå¥½æ„Ÿï¼ˆå¹´é¾„ç›¸è¿‘ï¼‰ã€‚`,
        "å½±å“ï¼šæ‹çˆ±ä¸­æ•´ä½“å¯¹è¥æ”¶æœ‰è½»å¾®åŠ æˆï¼Œä½†ä¹Ÿå¯èƒ½å¼•å‘åç»­äº‹ä»¶ã€‚"
      ]));
      }else{
        if(Math.random()<0.45){
          const [k,cn]=pick(ABILS);
          a.abilities[k]=roundHalf(clamp(a.abilities[k]-0.5,1,10));
          log("warn", story("warn", "åŠå…¬å®¤å…«å¦ï¼šæš§æ˜§ä¼ é—»æ‰©æ•£", [
          "æµè¨€è®©å›¢é˜Ÿæ²Ÿé€šå˜å¾—æ›´è°¨æ…ã€‚",
          `${a.name} æƒ…ç»ªå—å½±å“ï¼š${cn}-0.5`
        ]));
        }
      }
    }
  };

  const updateNegativeStreak=()=>{
    if(state.company.assets<0) state.company.negativeStreak += 1;
    else state.company.negativeStreak = 0;
    if(state.company.negativeStreak>=3){
      gameOver(`æ€»èµ„äº§è¿ç»­ ${state.company.negativeStreak} ä¸ªæœˆä¸ºè´Ÿï¼ˆç¬¬${state.company.year}å¹´${state.company.month}æœˆï¼‰ã€‚`);
    }
  };

  const advanceMonth=()=>{
    unlockRivalIfNeeded();
    if(state.company.gameOver) return;

    const bd=revenueBreakdown();
    state.company.revenueLast=bd.revenue;
    state.company.assets += bd.revenue;

    const pay=totalPayroll();
    state.company.assets -= pay.total;

    for(const p of state.people) if(p.active && !p.dead) p.tenureM++;

    if(state.company.rescueBuffMonths>0) state.company.rescueBuffMonths--;
    if(state.company.moraleBuffMonths>0) state.company.moraleBuffMonths--;

    monthlyPlayerOpsEvent();
    worldMarketNews();
    // V2.7 å†³ç­–äº‹ä»¶ï¼šæ¯æœˆæœ‰ä¸€å®šæ¦‚ç‡è§¦å‘ï¼ˆå«è¡Œä¸šä¸“å±äº‹ä»¶ï¼‰
    if(!state.ui.pendingDecision && Math.random()<0.65){
      const ev=pickDecisionEvent();
      if(ev){ openDecision(ev); state.ui.decisionOverlayOpen=false; }
    }
    runCrisisIfDue();
    loveMonthly();
    applyMonthlyResignations();

    if(state.company.layoffsLast6M===0 && industryMarket(state.company.industry)>=0.85){
      for(const lid of Object.keys(state.relations)){
        const leader=(lid==="player")?state.player:findPerson(lid);
        if(!leader||!leader.active||leader.dead) continue;
        for(const sid of getSubs(lid)){
          const sub=findPerson(sid);
          if(!sub||!sub.active||sub.dead) continue;
          if(Math.random()<0.55){
            const b=getBond(lid,sid);
            const add=Math.random()<0.6?0.5:1.0;
            const nb=roundHalf(clamp(b+add*computeContext().bondMult,0,10));
            setBond(lid,sid,nb);
            log("good",`ã€ç¾ç»Šã€‘${leader.name} â†” ${sub.name} ç¾ç»Š +${add}ï¼ˆLv ${b}â†’${nb}ï¼‰`);
          }
        }
      }
    }

    state.company.layoffsLast6M = Math.max(0, state.company.layoffsLast6M - 0.5);

    updateNegativeStreak();

    state.company.month++;
    if(state.company.month>12){
      state.company.month=1; state.company.year++;
      state.company.layoffsThisYear=0;
      scheduleYearCrises();
      log("warn",`ã€æ–°å¹´åº¦ã€‘è¿›å…¥ç¬¬ ${state.company.year} å¹´ï¼šå·²é‡ç½®å¹´åº¦å˜æ•…è®¡åˆ’ï¼ˆ2æ¬¡/å¹´ï¼‰ã€‚`);
    }

    save(); if(state.company.rivalDebuff && state.company.rivalDebuff.months>0){state.company.rivalDebuff.months--; if(state.company.rivalDebuff.months<=0) state.company.rivalDebuff=null;}
    rivalAttack();
    render();
  };

  // å…¼å®¹ï¼šæ—§æŒ‰é’®/æ—§é“¾æ¥è°ƒç”¨
  const nextMonth=()=>advanceMonth();


  // Modal detail
  let modalEl=null;
  const closeModal=()=>{if(modalEl){modalEl.remove();modalEl=null;}}
  const openPersonDetail=(pid)=>{
    const p=(pid==="player")?state.player:findPerson(pid);
    if(!p) return;
    const bd=revenueBreakdown();
    const table=contributionTable();
    const me=table.find(x=>x.id===pid);
    const estMoney=Math.round((bd.revenue||0)*(me?.share||0));

    const base= (p.kind==="employee") ? calcBaseSalary(p.position,p.abilities) : 0;
    const salaryHint=p.kind==="partner"
      ? "åˆä¼™äººè–ªé…¬æŒ‰è¥æ”¶è‡ªåŠ¨å˜åŒ–ï¼ˆæ­¤å¤„å±•ç¤ºè‚¡æƒä¸ä¼°ç®—ï¼‰ã€‚"
      : (p.id==="player" ? "ä¸»è§’æ˜¯å…¬å¸æ‰€æœ‰äººï¼šæ°¸ä¸ç¦»èŒï¼Œè–ªèµ„ä¸º 0ï¼ˆæ”¶ç›Šä½“ç°åœ¨å…¬å¸èµ„äº§ï¼‰ã€‚" : `åŒèƒ½åŠ›åŒèŒä½â€œåˆç†è–ªèµ„â€çº¦ ${fmtMoney(Math.round(base))}/æœˆï¼ˆå½“å‰ ${fmtMoney(p.salary)}/æœˆï¼‰ã€‚`);
    const risk=(p.kind==="employee" && p.active && !p.dead) ? Math.round(resignProbability(p)*100) : 0;

    const relList=[];
    for(const k of Object.keys(state.love)){
      const rel=state.love[k];
      if(rel && (rel.a===pid||rel.b===pid)){
        const other = rel.a===pid ? rel.bName : rel.aName;
        relList.push(`${other}ï¼ˆ${loveStageText(rel.stage)}Â·${rel.months}æœˆï¼‰`);
      }
    }

    const skillTag=p.skill?.type==="neg"?el("span",{class:"tag bad"},["è´Ÿé¢ç‰¹æ€§"]):el("span",{class:"tag good"},["æ­£é¢ç‰¹æ€§"]);

    const info=el("div",{class:"card"},[
      el("h3",{},[
        el("span",{},[`æˆå‘˜è¯¦æƒ… Â· ${p.name}`]),
        el("span",{class:"btnrow"},[
          el("button",{class:"btn small secondary", onclick:(e)=>{e.stopPropagation(); closeModal();}},["å…³é—­"])
        ])
      ]),
      el("div",{class:"hint"},[
        `æ€§åˆ«ï¼š${p.gender} Â· å¹´é¾„ï¼š${p.age}
`+
        `èº«ä»½ï¼š${p.kind==="partner"?"åˆä¼™äºº":(p.id==="player"?"ä¸»è§’":"å‘˜å·¥")} Â· å²—ä½ï¼š${p.role} Â· èŒä½ï¼š${positionName(p.position)}
`+
        (p.kind==="partner"?`è‚¡æƒï¼š${p.equity}%
`:(p.id==="player"?"":`æœˆè–ªï¼š${fmtMoney(p.salary)}
`))+
        `ä»»æœŸï¼š${p.tenureM} ä¸ªæœˆ
`+
        ((p.kind==="employee" && p.active && !p.dead)?`ç¦»èŒé£é™©ï¼ˆä¼°ç®—ï¼‰ï¼š${risk}%
`:"")+
        (relList.length?`æ‹çˆ±å…³ç³»ï¼š${relList.join("ï¼›")}
`:"")+
        `
æŠ€èƒ½ï¼š${p.skill?.name||"æ— "}
${p.skill?.desc||""}

${salaryHint}

`+
        `ä¸ªäººè´¡çŒ® PCSï¼š${me?.pcs ?? calcPCS(p)}
`+
        `è´¡çŒ®ç³»æ•°ï¼šx${me?.mult ?? pcsToMult(calcPCS(p))}
`+
        `é¢„ä¼°æœ¬æœˆè´¡çŒ®ï¼š${fmtMoney(estMoney)}ï¼ˆæŒ‰è´¡çŒ®æƒé‡ä¼°ç®—ï¼‰`
      ]),
      el("div",{class:"ptags"},[skillTag, el("span",{class:"tag"},[p.skill?.name||"æ— "])]),
    ]);

    const bars=el("div",{class:"bars"}, ABILS.map(([k,cn])=>el("div",{class:"bar"},[
      el("div",{},[`${cn} ${p.abilities[k].toFixed(1)}`]),
      meter(p.abilities[k])
    ])));

    const actions=el("div",{class:"card"},[
      el("h3",{},["æ“ä½œï¼ˆå¤´åƒ/ä»»å‘½/åŠ è–ª/è£å‘˜ï¼‰"]),
      renderPortraitActions(pid),
      (pid!=="player" && p.kind==="employee" && p.active && !p.dead)? renderManageActions(p) : el("div",{class:"hint"},["ï¼ˆä¸»è§’ä¸å¯ç¦»èŒ/ä¸å¯è£å‘˜ï¼›åˆä¼™äºº/ç¦»èŒ/æ­»äº¡è§’è‰²ä¸å¯è¿›è¡Œæ­¤å¤„ç®¡ç†æ“ä½œï¼‰"])
    ]);

    const wrap=el("div",{style:"position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,.55);z-index:9999;display:flex;align-items:flex-end;justify-content:center;padding:12px;", onclick:closeModal},[
      el("div",{style:"width:min(820px,100%);max-height:86vh;overflow:auto;border-radius:18px;", onclick:(e)=>e.stopPropagation()},[
        info,
        el("div",{class:"card"},[el("h3",{},["èƒ½åŠ›é¢æ¿"]),bars]),
        actions
      ])
    ]);
    closeModal(); modalEl=wrap; document.body.appendChild(modalEl);
  };

  const openAvatarGallery=(p)=>{
    const modal = el("div",{class:"modal"},[
      el("div",{class:"card"},[
        el("div",{class:"h"},["å¤´åƒå›¾åº“"]),
        el("div",{class:"mini"},["ç‚¹å‡»å¤´åƒå³å¯åº”ç”¨åˆ°è¯¥è§’è‰²ï¼ˆä¸ä¸Šä¼ ä¹Ÿèƒ½ç”¨ï¼‰ã€‚"]),
        el("div",{class:"gallery"},[
          ...AVATAR_LIBRARY.map(entry=>{
            const node = entry.type==="svg" ? (()=>{const d=document.createElement("div"); d.innerHTML=entry.data; d.firstElementChild.classList.add("svg"); return d.firstElementChild;})()
                       : entry.type==="text" ? el("div",{style:"font-size:44px"},[entry.data])
                       : el("div",{},["ğŸ™‚"]);
            return el("div",{class:"avItem",onclick:()=>{
              p.avatar = {type: entry.type, data: entry.data};
              closeModal();
              render();
            }},[node]);
          })
        ]),
        el("div",{class:"row",style:"margin-top:12px;justify-content:flex-end"},[
          el("button",{class:"btn",onclick:closeModal},["å…³é—­"])
        ])
      ])
    ]);
    openModal(modal);
  };

  const renderPortraitActions=(pid)=>{
    const p=(pid==="player")?state.player:findPerson(pid);
    const row=el("div",{class:"btnrow"},[]);
    const input=el("input",{type:"file",accept:"image/*",style:"display:none"});
    input.addEventListener("change",async()=>{
      const file=input.files && input.files[0];
      if(file) await attachPortrait(pid,file);
    });
    row.appendChild(el("button",{class:"btn small secondary", onclick:()=>input.click()},["ä¸Šä¼ ç…§ç‰‡è‚–åƒ"]));
    row.appendChild(input);
    row.appendChild(el("button",{class:"btn small secondary", onclick:()=>{
      p.portrait=randomPortrait();
      log("good",`ã€è‚–åƒã€‘å·²ä¸º ${p.name} ç”Ÿæˆé»˜è®¤AIé£å¤´åƒã€‚`);
      save(); render();
    }},["éšæœºAIå¤´åƒ"]));
    if(p?.portrait){
      row.appendChild(el("button",{class:"btn small danger", onclick:()=>{
        p.portrait=null; log("warn",`ã€è‚–åƒã€‘å·²ç§»é™¤ ${p.name} çš„è‚–åƒã€‚`); save(); render();
      }},["ç§»é™¤è‚–åƒ"]));
    }
    return row;
  };

  const renderManageActions=(p)=>{
    const grid=el("div",{class:"formgrid"},[
      el("div",{},[
        el("label",{},["ä»»å‘½/æ™‹å‡"]),
        (()=>{const sel=el("select",{});for(const pos of POSITIONS){ if(pos.key==="owner") continue; sel.appendChild(el("option",{value:pos.key},[`${pos.name}ï¼ˆè§„æ¨¡â‰¥${pos.minSize} ç®¡ç†â‰¥${pos.minManage}ï¼‰`]))}sel.value=p.position;
          const btn=el("button",{class:"btn small good", onclick:()=>{promote(p.id, sel.value); openPersonDetail(p.id);}},["ç¡®å®šä»»å‘½"]);
          return el("div",{},[sel, el("div",{style:"height:8px"}), btn]);
        })()
      ]),
      el("div",{},[
        el("label",{},["åŠ è–ª"]),
        (()=>{const inp=el("input",{type:"number",value:"300",min:"100",step:"100"});
          const btn=el("button",{class:"btn small good", onclick:()=>{raise(p.id, Number(inp.value)); openPersonDetail(p.id);}},["åŠ è–ª"]);
          return el("div",{},[inp, el("div",{style:"height:8px"}), btn]);
        })()
      ])
    ]);
    const fireBtn=el("button",{class:"btn small danger", onclick:()=>{fire(p.id); closeModal();}},["è£å‘˜/è§£é›‡"]);
    return el("div",{},[grid, el("div",{style:"height:10px"}), fireBtn]);
  };

  const TABS=[
    {key:"dashboard",name:"è¿è¥é¢æ¿"},
    {key:"gacha",name:"æŠ½å¡æ‹›äºº"},
    {key:"team",name:"æˆå‘˜ç®¡ç†"},
    {key:"org",name:"ç»„ç»‡ç»“æ„"},
    {key:"world",name:"ä¸–ç•Œè¡Œæƒ…/è½¬è¡Œ"},
    {key:"rival",name:"ç«äº‰å¯¹æ‰‹"},
    {key:"settings",name:"è®¾ç½®/æ–°æ¡£"},
  ];

  const topStats=()=>{
    const bd=revenueBreakdown();
    const pay=totalPayroll();
    const n=staffCount();
    const lvl=scaleLevel();
    const score=computeScore();
    return [
      `ç¬¬${state.company.year}å¹´${state.company.month}æœˆ`,
      `äººå‘˜ ${n} äººï¼ˆ${scaleName(lvl)}è§„æ¨¡ï¼‰`,
      `è¯„åˆ† ${score}`,
      `èµ„äº§ ${fmtMoney(state.company.assets)}`,
      `è´Ÿèµ„äº§è¿ç»­ ${state.company.negativeStreak} æœˆ`,
      `æœ¬æœˆè¥æ”¶ ${fmtMoney(bd.revenue)}ï¼ˆ${bd.industry}ï¼‰`,
      `å·¥èµ„ ${fmtMoney(pay.total)}`,
      upcomingFlowMini(),
      `å½“å‰è¡Œä¸šè¡Œæƒ… ${industryMarket(state.company.industry).toFixed(2)}(${marketLabel(industryMarket(state.company.industry))})`
    ];
  };

  const personCard=(p)=>{
    const tags=[];
    tags.push(el("span",{class:"tag"},[p.role]));
    if(p.id!=="player") tags.push(el("span",{class:`tag ${rarityMeta(p.rarity).cls}`},[p.rarity]));
    if(p.id==="player") tags.push(el("span",{class:"tag player"},["ä¸»è§’"]));
    if(p.id==="player") tags.push(el("span",{class:"tag good"},["æ‰€æœ‰äºº"]));
    if(p.kind==="partner") tags.push(el("span",{class:"tag warn"},[`åˆä¼™äºº ${p.equity}%`]));
    if(!p.active && p.resigned) tags.push(el("span",{class:"tag warn"},["ç¦»èŒ"]));
    if(p.dead) tags.push(el("span",{class:"tag bad"},["æ­»äº¡"]));
    const skillTag = p.skill?.type==="neg" ? el("span",{class:"tag bad"},["è´Ÿé¢"]) : el("span",{class:"tag good"},["æ­£é¢"]);
    tags.push(skillTag);
    tags.push(el("span",{class:"tag"},[p.skill?.name||"æ— "]));

    let loveTag=null;
    for(const k of Object.keys(state.love)){
      const rel=state.love[k];
      if(rel && (rel.a===p.id||rel.b===p.id)){ loveTag=el("span",{class:"tag warn"},[loveStageText(rel.stage)]); break; }
    }
    if(loveTag) tags.push(loveTag);

    return el("div",{class:"person", onclick:()=>openPersonDetail(p.id)},[
      el("div",{class:"avatarFrame"},[
        el("div",{class:"spark"}),
        el("div",{class:"avatar"},[
          p.portrait?el("img",{src:p.portrait}):el("div",{},["ğŸ™‚"])
        ])
      ]),
      el("div",{},[
        el("div",{class:"phead"},[
          el("div",{class:"pname"},[p.name+" Â· "+positionName(p.position)]),
          el("div",{class:"ptags"},tags)
        ]),
        el("div",{class:"hint"},[
          `${p.gender} Â· ${p.age}å²  |  PCS ${calcPCS(p)}  |  è´¡çŒ®ç³»æ•° x${pcsToMult(calcPCS(p))}
`+
          (p.id==="player" ? "ä¸»è§’ï¼šå…¬å¸æ‰€æœ‰äººï¼ˆä¸ä¼šç¦»èŒï¼‰" :
            (p.kind==="employee"?`è–ªèµ„ï¼š${fmtMoney(p.salary)}/æœˆ  | ç¦»èŒé£é™©ï¼š${Math.round(resignProbability(p)*100)}%`:"åˆä¼™äººè–ªé…¬éšè¥æ”¶è‡ªåŠ¨å˜åŒ–"))
        ]),
      ])
    ]);
  };

  const viewDashboard=()=>{
    const bd=revenueBreakdown();
    const pay=totalPayroll();
    const top=contributionTable().slice(0,5);
    const rescue = state.company.rescueBuffMonths>0
      ? `æ•‘åŠ©Buffå‰©ä½™ï¼š${state.company.rescueBuffMonths}ä¸ªæœˆï¼ˆè¥æ”¶+10% ç¦»èŒ-15%ï¼‰`
      : "æ•‘åŠ©Buffï¼šæ— ";

    const revenueCard=el("div",{class:"card"},[
      el("h3",{},["è¥æ”¶æ˜ç»†ï¼ˆé€æ˜æ‹†åˆ†ï¼‰"]),
      el("div",{class:"kpi"},[
        el("div",{class:"k"},[el("div",{class:"t"},["å½“å‰è¡Œä¸š"]), el("div",{class:"v"},[bd.industry])]),
        el("div",{class:"k"},[el("div",{class:"t"},["è¡Œä¸šåŸºç¡€è¥æ”¶"]), el("div",{class:"v"},[fmtMoney(bd.base)])]),
        el("div",{class:"k"},[el("div",{class:"t"},["æœ¬æœˆè¥æ”¶"]), el("div",{class:"v"},[fmtMoney(bd.revenue)])]),
        el("div",{class:"k"},[el("div",{class:"t"},["è¡Œä¸šè¡Œæƒ…"]), el("div",{class:"v"},[bd.market.toFixed(2)+"ï¼ˆ"+marketLabel(bd.market)+"ï¼‰"])]),
        el("div",{class:"k"},[el("div",{class:"t"},["å¸‚åœºå‚ä¸ï¼ˆ50%ï¼‰"]), el("div",{class:"v"},["x"+bd.marketPart.toFixed(2)])]),
        el("div",{class:"k"},[el("div",{class:"t"},["å›¢é˜Ÿ/ç»„ç»‡/æ‹çˆ±ä¹˜æ•°"]), el("div",{class:"v"},["x"+bd.teamMult.toFixed(3)])]),
        el("div",{class:"k"},[el("div",{class:"t"},["æŠ€èƒ½/æ•‘åŠ©ä¿®æ­£"]), el("div",{class:"v"},["x"+bd.skillMult.toFixed(3)])]),
        el("div",{class:"k"},[el("div",{class:"t"},["å·¥èµ„æ€»æ”¯å‡º"]), el("div",{class:"v"},[fmtMoney(pay.total)])]),
      ]),
      el("div",{class:"hr"}),
      el("div",{class:"hint"},[`è´Ÿèµ„äº§è¿ç»­ï¼š${state.company.negativeStreak} æœˆï¼ˆâ‰¥3 å¤±è´¥ï¼‰
${rescue}`]),
      el("div",{class:"hr"}),
      el("div",{class:"hint"},["Topè´¡çŒ®æˆå‘˜ï¼ˆä¼°ç®—ï¼‰"]),
      el("div",{class:"list"}, top.map(it=>{
        const money=Math.round((bd.revenue||0)*it.share);
        return el("div",{class:"logitem"},[
          `${it.name}ï¼ˆ${it.rarity}Â·${it.role}ï¼‰ è´¡çŒ®ç³»æ•° x${it.mult}  Â· é¢„ä¼°è´¡çŒ® ${fmtMoney(money)}`
        ]);
      }))
    ]);

    const actions=el("div",{class:"card"},[
      el("h3",{},["æœ¬æœˆæ“ä½œ"]),
      el("div",{class:"btnrow"},[
        el("button",{class:"btn good", onclick:advanceMonth},["æ¨è¿›ä¸€ä¸ªæœˆ"]),
        el("button",{class:"btn secondary", onclick:doTeamActivity},[`å›¢å»ºï¼ˆ${fmtMoney(teamActivityCost())}ï¼‰`]),
        el("button",{class:"btn warn", onclick:()=>doAnnualMeeting("cash")},["å¹´ä¼šï¼š+10%èµ„é‡‘ï¼ˆå¹´1æ¬¡ï¼‰"]),
        el("button",{class:"btn warn", onclick:()=>doAnnualMeeting("buff")},["å¹´ä¼šï¼šå…¨å‘˜+0.5ï¼ˆå¹´1æ¬¡ï¼‰"]),
      ]),
      el("div",{class:"hr"}),
      el("div",{class:"hint"},[
        `æç¤ºï¼š
1ï¼‰ç‚¹æˆå‘˜å¡ç‰‡å¯æŸ¥çœ‹ã€æˆå‘˜è¯¦æƒ…é¡µã€ï¼šè´¡çŒ®/æŠ€èƒ½/ç¦»èŒé£é™©/ä¸Šä¼ ç…§ç‰‡è‚–åƒ/éšæœºAIå¤´åƒã€‚
2ï¼‰ã€ä¸–ç•Œè¡Œæƒ…/è½¬è¡Œã€é‡Œå¯éšæ—¶è½¬è¡Œï¼šæŸå¤±å¾ˆå¤§ï¼Œä½†æœ‰å°æ¦‚ç‡å¹¸è¿äº‹ä»¶ï¼›è´Ÿèµ„äº§è½¬è¡Œå¯è§¦å‘2å¹´æ•‘åŠ©Buffã€‚
3ï¼‰æ‹çˆ±ç³»ç»Ÿï¼šå‘˜å·¥å¹´é¾„ç›¸è¿‘å¯èƒ½æ‹çˆ±ï¼›ä¼šè§¦å‘å¥½/åäº‹ä»¶å¹¶å½±å“å…¬å¸è¡¨ç°ã€‚`
      ])
    ]);

    const logBox=el("div",{class:"card"},[
      el("h3",{},["æ—¥å¿—"]),
      el("div",{class:"log"}, state.log.map(x=>el("div",{class:`logitem ${x.type}`},[
        el("div",{class:"hint"},[x.t]),
        x.text
      ])))
    ]);

    return el("div",{class:"grid"},[
      (SafeStore.ok?null:el("div",{class:"card",style:"border-color:rgba(255,209,102,.35);background:rgba(255,209,102,.08)"},[
        el("div",{class:"h"},["æç¤ºï¼šå½“å‰æµè§ˆå™¨ç¦ç”¨äº†æœ¬åœ°å­˜æ¡£"]),
        el("div",{class:"mini"},["ä½ ä»ç„¶å¯ä»¥æ¸¸ç©ï¼Œä½†â€œè‡ªåŠ¨ä¿å­˜/è¯»å–â€å¯èƒ½ä¸å¯ç”¨ã€‚å»ºè®®ç”¨ Safari æˆ–æŠŠæ–‡ä»¶æ”¾åˆ°æ”¯æŒæœ¬åœ°å­˜å‚¨çš„æµè§ˆå™¨ä¸­æ‰“å¼€ã€‚"])
      ])),\nel("div",{},[revenueCard, el("div",{style:"height:12px"}), actions]),
      logBox
    ]);
  };

  const viewGacha=()=>{
    if(!state.company.upRole){ state.company.upRole=pick(ROLES); }
    const upEnds = (()=>{let m=state.company.month+1,y=state.company.year;if(m>12){m-=12;y++;}return {m,y};})();
    state.company.upEnds=state.company.upEnds||upEnds;

    const end=state.company.upEnds;
    if(state.company.year>end.y || (state.company.year===end.y && state.company.month>end.m)){
      state.company.upRole=pick(ROLES);
      let m=state.company.month+1,y=state.company.year;if(m>12){m-=12;y++;}
      state.company.upEnds={m,y};
      log("warn",`ã€å¡æ± è½®æ¢ã€‘æœ¬æœŸUPï¼š${state.company.upRole}ï¼ˆè‡³ ç¬¬${y}å¹´${m}æœˆï¼‰`);
    }

    const card=el("div",{class:"card"},[
      el("h3",{},["æŠ½å¡æ‹›äºº"]),
      el("div",{class:"hint"},[
        `æœ¬æœŸUPï¼š${state.company.upRole}ï¼ˆè‡³ ç¬¬${state.company.upEnds.y}å¹´${state.company.upEnds.m}æœˆï¼‰
`+
        `å•æŠ½è´¹ç”¨ï¼š${fmtMoney(5000)}  |  SSRä¿åº•ï¼š40æŠ½ï¼ˆè½¯ä¿åº•ï¼š20æŠ½åæ¦‚ç‡æå‡ï¼‰
`+
        `æŠ€èƒ½ï¼š70%æ­£é¢ / 30%è´Ÿé¢`
      ]),
      el("div",{class:"btnrow"},[
        el("button",{class:"btn good", onclick:()=>pullOne(true)},["å•æŠ½"]),
        el("button",{class:"btn warn", onclick:()=>{for(let i=0;i<10;i++) pullOne(true);}},["åè¿"]),
      ]),
      el("div",{class:"hr"}),
      el("div",{class:"hint"},[`å·²æŠ½ï¼š${state.gacha.pulls}  | è·ç¦»SSRç¡¬ä¿åº•ï¼š${Math.max(0,40-state.gacha.pitySSR)} æŠ½
å½“å‰èµ„äº§ï¼š${fmtMoney(state.company.assets)}ï¼ˆå…è®¸ä¸ºè´Ÿï¼‰`]),
    ]);

    const recent=state.people.slice(-12).reverse();
    const list=el("div",{class:"card"},[
      el("h3",{},["æœ€è¿‘è·å¾—"]),
      el("div",{class:"list"}, recent.map(personCard))
    ]);

    return el("div",{class:"grid"},[
      el("div",{},[card]),
      el("div",{},[list])
    ]);
  };

  const viewTeam=()=>{
    enforceSalaryOrder();
    const all=[state.player, ...state.people.slice().sort((a,b)=>{
      const aliveA=(a.dead?1:0), aliveB=(b.dead?1:0);
      if(aliveA!==aliveB) return aliveA-aliveB;
      const actA=(a.active?0:1), actB=(b.active?0:1);
      if(actA!==actB) return actA-actB;
      return rankOf(b.position)-rankOf(a.position);
    })];

    return el("div",{class:"card"},[
      el("h3",{},["æˆå‘˜ç®¡ç†ï¼ˆç‚¹å¡ç‰‡çœ‹è¯¦æƒ…ï¼‰"]),
      el("div",{class:"hint"},[
        `è§„åˆ™æé†’ï¼š
â€¢ ä¸»è§’=å…¬å¸æ‰€æœ‰äººï¼ˆä¸å¯ç¦»èŒ/ä¸å¯è£å‘˜ï¼‰ã€‚
â€¢ é«˜èŒä½è–ªèµ„å¿…é¡»é«˜äºä½èŒä½ï¼ˆç³»ç»Ÿè‡ªåŠ¨æ ¡æ­£ï¼‰ã€‚
â€¢ æƒ…å•†ä½/ä½è–ª/ä»»æœŸä¹…/è£å‘˜é¢‘ç¹/æ‹çˆ±å†²çª ä¼šæé«˜ç¦»èŒæ¦‚ç‡ã€‚
â€¢ åˆä¼™äººï¼šæœ‰è‚¡æƒï¼Œè–ªé…¬éšè¥æ”¶è‡ªåŠ¨å˜åŒ–ã€‚`
      ]),
      el("div",{class:"hr"}),
      el("div",{class:"list"}, all.map(personCard))
    ]);
  };

  const viewOrg=()=>{
    const activeIds=["player", ...state.people.filter(p=>p.active&&!p.dead).map(p=>p.id)];
    const activePeople=activeIds.map(id=>id==="player"?state.player:findPerson(id)).filter(Boolean);

    const leaderSel=el("select",{});
    for(const p of activePeople) leaderSel.appendChild(el("option",{value:p.id},[`${p.name}ï¼ˆ${p.role}Â·${positionName(p.position)}ï¼‰`]));

    const subSel=el("select",{});
    for(const p of activePeople){ if(p.id==="player") continue; subSel.appendChild(el("option",{value:p.id},[`${p.name}ï¼ˆ${p.role}Â·${positionName(p.position)}ï¼‰`])); }

    const panel=el("div",{class:"card"},[
      el("h3",{},["ç»„ç»‡ç»“æ„ï¼ˆé¢†å¯¼-ä¸‹å±ï¼‰"]),
      el("div",{class:"formgrid"},[
        el("div",{},[el("label",{},["é¢†å¯¼"]), leaderSel]),
        el("div",{},[el("label",{},["ä¸‹å±"]), subSel]),
      ]),
      el("div",{style:"height:8px"}),
      el("div",{class:"btnrow"},[
        el("button",{class:"btn good", onclick:()=>assignSub(leaderSel.value, subSel.value)},["è®¾ä¸ºç›´å±"]),
      ]),
      el("div",{class:"hr"}),
      el("div",{class:"hint"},[
        `è¯´æ˜ï¼š
â€¢ å»ºç«‹ç›´å±å…³ç³»ä¼šå¸¦æ¥ç»„ç»‡åŠ æˆä¸ç¾ç»Šå¢é•¿ã€‚
â€¢ ä½†ä»»æœŸè¶Šä¹…ç¦»èŒæ¦‚ç‡ä¼šæé«˜ï¼Œå»ºè®®æ™‹å‡/åŠ è–ªç¨³å®šå›¢é˜Ÿã€‚`
      ])
    ]);

    const tree=el("div",{class:"card"},[
      el("h3",{},["å½“å‰ç»„ç»‡ç»“æ„"]),
      ...Object.keys(state.relations).length?[]:[el("div",{class:"hint"},["æš‚æ— ç»„ç»‡ç»“æ„ã€‚"])],
      el("div",{class:"list"}, Object.keys(state.relations).map(lid=>{
        const leader=(lid==="player")?state.player:findPerson(lid);
        if(!leader||!leader.active||leader.dead) return null;
        const subs=getSubs(lid).map(id=>findPerson(id)).filter(x=>x&&x.active&&!x.dead);
        return el("div",{class:"card"},[
          el("h3",{},[`${leader.name}ï¼ˆ${leader.role}Â·${positionName(leader.position)}ï¼‰`]),
          subs.length? el("div",{class:"list"}, subs.map(s=>{
            const b=getBond(lid,s.id);
            return el("div",{class:"logitem"},[
              `${s.name}ï¼ˆ${s.role}Â·${positionName(s.position)}ï¼‰ ç¾ç»Š Lv ${b.toFixed(1)}`,
              el("div",{style:"height:8px"}),
              el("div",{class:"btnrow"},[
                el("button",{class:"btn small secondary", onclick:()=>{openPersonDetail(s.id)}},["æŸ¥çœ‹"]),
                el("button",{class:"btn small danger", onclick:()=>unassignSub(lid,s.id)},["å–æ¶ˆç›´å±"]),
              ])
            ]);
          })) : el("div",{class:"hint"},["æš‚æ— ç›´å±ä¸‹å±ã€‚"])
        ]);
      }).filter(Boolean))
    ]);

    return el("div",{class:"grid"},[
      el("div",{},[panel]),
      el("div",{},[tree])
    ]);
  };

  const viewWorld=()=>{
    const rows=INDUSTRIES.slice().sort((a,b)=>industryMarket(b.key)-industryMarket(a.key));
    const cur=state.company.industry;

    const industrySel=el("select",{});
    for(const ind of INDUSTRIES){
      industrySel.appendChild(el("option",{value:ind.key},[`${ind.name}ï¼ˆè¡Œæƒ… ${industryMarket(ind.key).toFixed(2)}ï¼‰`]));
    }
    industrySel.value=cur;

    return el("div",{class:"card"},[
      el("h3",{},["ä¸–ç•Œè¡Œæƒ…ï¼ˆå„è¡Œä¸šå®æ—¶å˜åŒ–ï¼‰"]),
      el("div",{class:"hint"},[
        `è¯´æ˜ï¼š
â€¢ æ¯æ¨è¿›ä¸€ä¸ªæœˆï¼Œæ‰€æœ‰è¡Œä¸šè¡Œæƒ…éƒ½ä¼šç‹¬ç«‹æ³¢åŠ¨ã€‚
â€¢ ä½ å¯ä»¥éšæ—¶è½¬è¡Œï¼ˆæˆæœ¬å¾ˆå¤§ï¼‰ã€‚
â€¢ è´Ÿèµ„äº§è½¬è¡Œå¯è·å¾— 2 å¹´æ•‘åŠ©Buffï¼Œä½†è´Ÿèµ„äº§è½¬è¡Œè¶…è¿‡ 2 æ¬¡å°†ç›´æ¥å¤±è´¥ã€‚`
      ]),
      el("div",{class:"hr"}),
      el("div",{class:"formgrid"},[
        el("div",{},[el("label",{},["é€‰æ‹©è¦è½¬å…¥çš„è¡Œä¸š"]), industrySel]),
        el("div",{},[
          el("label",{},["å½“å‰çŠ¶æ€"]),
          el("div",{class:"hint"},[
            `å½“å‰è¡Œä¸šï¼š${industryMeta(cur).name}
`+
            `å½“å‰èµ„äº§ï¼š${fmtMoney(state.company.assets)}
`+
            `è´Ÿèµ„äº§è½¬è¡Œæ¬¡æ•°ï¼š${state.company.negativeSwitchCount}/2
`+
            `æ•‘åŠ©Buffå‰©ä½™ï¼š${state.company.rescueBuffMonths}æœˆ`
          ])
        ])
      ]),
      el("div",{style:"height:8px"}),
      el("div",{class:"btnrow"},[
        el("button",{class:"btn warn", onclick:()=>switchIndustry(industrySel.value)},["è½¬è¡Œï¼ˆé«˜æŸå¤±ï¼‰"]),
      ]),
      el("div",{class:"hr"}),
      el("div",{class:"list"}, rows.map(ind=>{
        const m=industryMarket(ind.key);
        const tagClass = ind.key===cur ? "good" : (m>=1.05?"good":m<=0.85?"bad":"warn");
        return el("div",{class:"logitem"},[
          `${ind.name}  | è¡Œæƒ… ${m.toFixed(2)}ï¼ˆ${marketLabel(m)}ï¼‰`,
          el("div",{style:"height:6px"}),
          el("div",{class:"btnrow"},[
            ind.key!==cur ? el("button",{class:"btn small secondary", onclick:()=>switchIndustry(ind.key)},["å¿«é€Ÿè½¬è¡Œ"]) : el("span",{class:`tag ${tagClass}`},["å½“å‰è¡Œä¸š"])
          ])
        ]);
      }))
    ]);
  };

  const viewRival=()=>{
    ensureRival();
    const r=state.company.rivals;
    const unlocked = r.unlocked;
    const lvl=scaleLevel();
    const badge = unlocked ? el("span",{class:"rivalBadge"},["ğŸ†š ç«äº‰å¯¹æ‰‹å·²è§£é”"]) : el("span",{class:"tag"},["æœªè§£é”"]);
    const deb = state.company.rivalDebuff;
    return el("div",{class:"grid"},[
      el("div",{class:"card rivalCard"},[
        el("div",{class:"h"},["ç«äº‰å¯¹æ‰‹"]),
        el("div",{class:"row"},[
          el("div",{},[badge]),
          el("div",{class:"mini"},[ unlocked ? `å¯¹æ‰‹ï¼š${r.name}ï¼ˆè¡Œä¸šï¼š${industryMeta(r.industry).name}ï¼‰ï½œçƒ­åº¦ ${Math.round(r.heat||0)}/100` : "å…¬å¸è¾¾åˆ°â€œä¸­å‹è§„æ¨¡â€(â‰¥7äºº)åå°†å‡ºç°ç«äº‰å¯¹æ‰‹ã€‚"])
        ]),
        unlocked ? el("div",{class:"mini",style:"margin-top:8px"},[
          "å¯¹æ‰‹ä¼šéšæœºå‘åŠ¨ï¼šä»·æ ¼æˆ˜/æŒ–äºº/èˆ†è®ºæˆ˜/æ¸ é“å°é”ã€‚ä½ å¯ä»¥ç”¨â€œé˜²æŠ¤é¢„ç®—â€é™ä½è§¦å‘æ¦‚ç‡ã€‚"
        ]) : null,
        unlocked ? el("div",{class:"row",style:"margin-top:10px"},[
          el("button",{class:"btn",onclick:()=>{
            const cost = 8000 + lvl*4000;
            if(state.company.assets < cost){ toast("èµ„é‡‘ä¸è¶³"); return; }
            state.company.assets -= cost;
            r.shields = Math.min(5, (r.shields||0)+1);
            log("good", story("good", "å¯¹æ‰‹é˜²æŠ¤ï¼šåŠ å›ºæŠ¤åŸæ²³", [
              `æŠ•å…¥ï¼š${fmtMoney(cost)}ï¼ˆéšè§„æ¨¡å¢åŠ ï¼‰`,
              `æŠ¤åŸæ²³ç­‰çº§ï¼š${r.shields}/5ï¼ˆé™ä½å¯¹æ‰‹æ”»å‡»è§¦å‘æ¦‚ç‡ï¼‰`
            ]));
            render();
          }},["ğŸ›¡ï¸ é˜²æŠ¤é¢„ç®—"]),
          el("button",{class:"btn",onclick:()=>{
            // reset rival industry
            r.industry = pick(INDUSTRIES.filter(x=>x.key!=="generic")).key;
            log("warn", story("warn", "æƒ…æŠ¥æ›´æ–°ï¼šå¯¹æ‰‹æ¢çº¿", [
              `${r.name} çš„é‡ç‚¹è½¬å‘ï¼š${industryMeta(r.industry).name}`
            ]));
            render();
          }},["ğŸ›°ï¸ æƒ…æŠ¥åˆ·æ–°"])
        ]) : null,
        unlocked && deb ? el("div",{class:"mini",style:"margin-top:10px"},[
          `å½“å‰å¹²æ‰°ï¼šå‰©ä½™${deb.months}æœˆï½œè¥æ”¶Ã—${(deb.rev||1).toFixed(2)}ï½œç¦»èŒÃ—${(deb.resign||1).toFixed(2)}`
        ]) : null
      ])
    ]);
  };

  const viewSettings=()=>{
    const indSel=el("select",{});
    for(const ind of INDUSTRIES) indSel.appendChild(el("option",{value:ind.key},[ind.name]));
    indSel.value=state.company.industry;

    const companyName=el("input",{value:state.company.name});
    const playerName=el("input",{value:state.player.name});
    const playerGender=el("select",{}); for(const g of GENDERS) playerGender.appendChild(el("option",{value:g},[g])); playerGender.value=state.player.gender;
    const playerAge=el("input",{type:"number",min:"18",max:"80",value:state.player.age});
    const playerRole=el("select",{}); for(const r of ROLES) playerRole.appendChild(el("option",{value:r},[r])); playerRole.value=state.player.role;

    const abilityInputs={};
    const abGrid=el("div",{class:"formgrid"}, ABILS.map(([k,cn])=>{
      const inp=el("input",{type:"number",step:"0.5",min:"1",max:"10",value:state.player.abilities[k]});
      abilityInputs[k]=inp;
      return el("div",{},[el("label",{},[cn]), inp]);
    }));

    const initEmp=el("select",{}); ["0","1","2"].forEach(x=>initEmp.appendChild(el("option",{value:x},[x]))); initEmp.value="2";
    const initPartner=el("select",{}); ["0","1","2"].forEach(x=>initPartner.appendChild(el("option",{value:x},[x]))); initPartner.value="1";

    const randomizePlayer=()=>{
      const p=mkPerson({kind:"player",rarity:"SR",name:"åˆ›ä¸šè€…",role:pick(ROLES), useAiPortrait:true});
      p.id="player"; p.position="owner"; p.salary=0;
      state.player=p;
      save(); render();
    };

    const applySettings=()=>{
      state.company.name=companyName.value.trim()||"æœªå‘½åå…¬å¸";
      state.player.name=playerName.value.trim()||"åˆ›ä¸šè€…";
      state.player.gender=playerGender.value;
      state.player.age=clamp(parseInt(playerAge.value||"28",10),18,80);
      state.player.role=playerRole.value;
      for(const [k] of ABILS) state.player.abilities[k]=roundHalf(clamp(Number(abilityInputs[k].value||5),1,10));
      log("good","ã€è®¾ç½®ã€‘å·²ä¿å­˜å…¬å¸ä¸ä¸»è§’è®¾ç½®ã€‚");
      save(); render();
    };

    const newGame=()=>{
      const st=defaultState();
      st.company.name=companyName.value.trim()||"æœªå‘½åå…¬å¸";
      st.company.industry=indSel.value;
      st.company.worldMarkets=defaultWorldMarkets();
      st.player=mkPerson({kind:"player",rarity:"SR",name:playerName.value.trim()||"åˆ›ä¸šè€…",role:playerRole.value, useAiPortrait:true});
      st.player.id="player"; st.player.position="owner"; st.player.salary=0;
      st.player.gender=playerGender.value;
      st.player.age=clamp(parseInt(playerAge.value||"28",10),18,80);
      for(const [k] of ABILS) st.player.abilities[k]=roundHalf(clamp(Number(abilityInputs[k].value||5),1,10));

      const empN=parseInt(initEmp.value,10);
      const parN=parseInt(initPartner.value,10);
      for(let i=0;i<parN;i++) st.people.push(mkPerson({kind:"partner",rarity:Math.random()<0.5?"SR":"R", name:genName(), useAiPortrait:true}));
      for(let i=0;i<empN;i++) st.people.push(mkPerson({kind:"employee",rarity:Math.random()<0.55?"R":"SR", name:genName(), useAiPortrait:true}));

      state=st;
      scheduleYearCrises();
      log("good","ã€æ–°æ¡£ã€‘å·²åˆ›å»ºæ–°å­˜æ¡£ï¼ˆä¸–ç•Œè¡Œæƒ…å„è¡Œä¸šéšæœºï¼›ä¸»è§’=å…¬å¸æ‰€æœ‰äººï¼‰ã€‚");
      save(); render();
    };

    return el("div",{class:"grid"},[
      el("div",{},[
        el("div",{class:"card"},[
          el("h3",{},["å…¬å¸è®¾ç½®"]),
          el("div",{class:"formgrid"},[
            el("div",{},[el("label",{},["å…¬å¸å"]), companyName]),
            el("div",{},[el("label",{},["æ–°æ¡£åˆå§‹è¡Œä¸š"]), indSel]),
            el("div",{},[el("label",{},["åˆå§‹å¿ å®å‘˜å·¥æ•°"]), initEmp]),
            el("div",{},[el("label",{},["åˆå§‹åˆä¼™äººæ•°"]), initPartner]),
          ]),
          el("div",{class:"hr"}),
          el("div",{class:"btnrow"},[
            el("button",{class:"btn good", onclick:applySettings},["ä¿å­˜ä¸»è§’è®¾ç½®ï¼ˆå½“å‰æ¡£ï¼‰"]),
            el("button",{class:"btn warn", onclick:newGame},["åˆ›å»ºæ–°æ¡£ï¼ˆè¦†ç›–å½“å‰ï¼‰"]),
          ]),
        ])
      ]),
      el("div",{},[
        el("div",{class:"card"},[
          el("h3",{},["ä¸»è§’è®¾ç½®ï¼ˆå…¬å¸æ‰€æœ‰äººï¼‰"]),
          el("div",{class:"hint"},["ä¸»è§’æ˜¯ç‹¬ç«‹è§’è‰²ï¼šèŒä½=å…¬å¸æ‰€æœ‰äººï¼Œæ°¸ä¸ç¦»èŒï¼Œè–ªèµ„ä¸º0ã€‚"]),
          el("div",{class:"formgrid"},[
            el("div",{},[el("label",{},["åå­—"]), playerName]),
            el("div",{},[el("label",{},["æ€§åˆ«"]), playerGender]),
            el("div",{},[el("label",{},["å¹´é¾„"]), playerAge]),
            el("div",{},[el("label",{},["å²—ä½"]), playerRole]),
          ]),
          el("div",{class:"hr"}),
          el("h3",{},["ä¸»è§’èƒ½åŠ›ï¼ˆ1~10ï¼Œ0.5æ¡£ï¼‰"]),
          abGrid,
          el("div",{class:"hr"}),
          el("div",{class:"btnrow"},[
            el("button",{class:"btn secondary", onclick:randomizePlayer},["éšæœºä¸»è§’"]),
            el("button",{class:"btn secondary", onclick:()=>{state.player.portrait=randomPortrait(); log("good","ã€è‚–åƒã€‘å·²ä¸ºä¸»è§’ç”ŸæˆéšæœºAIå¤´åƒã€‚"); save(); render();}},["ä¸»è§’éšæœºAIå¤´åƒ"]),
          ])
        ])
      ])
    ]);
  };


  const openOverlayBox=(title, bodyNodes, buttons=[])=>{
    const ov = el("div",{class:"overlay"},[
      el("div",{class:"overbox"},[
        el("div",{style:"display:flex;justify-content:space-between;align-items:center;gap:10px"},[
          el("h3",{style:"margin:6px 0"},[title]),
          el("button",{class:"btn ghost",onclick:()=>ov.remove()},["âœ•"])
        ]),
        ...bodyNodes,
        buttons.length? el("div",{class:"btnrow"},buttons): el("div",{})
      ])
    ]);
    document.body.appendChild(ov);
    return ov;
  };

  const openChangelog=()=>{
    const lines=[
      "V2.7 æ›´æ–°ï¼š",
      "â€¢ äº‹ä»¶å¤šé€‰é¡¹ï¼ˆA/B/Cï¼‰ï¼šä¸åŒæˆæœ¬/æ¦‚ç‡/åæœï¼ˆå«è¡Œä¸šä¸“å±äº‹ä»¶åŒ…ï¼‰",
      "â€¢ äº‹ä»¶å›¾é‰´/æ–°é—»æ¡£æ¡ˆï¼šå¯å›çœ‹ï¼ˆæœ€å¤š800æ¡ï¼‰",
      "â€¢ UI æ›´ç®€æ´ï¼šä¸»é¡µé¢ç¼©çŸ­æè¿°ï¼Œæ–°å¢å¿«æ·æŒ‰é’®ï¼ˆå›¾æ ‡ï¼‰",
      "",
      "æç¤ºï¼šå¦‚æœä½ æƒ³è¦æ›´å¤æ‚çš„å†³ç­–ï¼ˆå»¶è¿Ÿç”Ÿæ•ˆ/è¿é”äº‹ä»¶/å¤šå›åˆè°ˆåˆ¤ï¼‰ï¼Œå‘Šè¯‰æˆ‘æˆ‘ç»§ç»­åŠ ã€‚"
    ].join("\n");
    openOverlayBox("ç‰ˆæœ¬ä¸æ›´æ–°è¯´æ˜",[
      el("div",{class:"hint"},[lines])
    ]);
  };

  const openArchive=()=>{
    const wrap=el("div",{},[]);
    const filterRow=el("div",{class:"field"},[]);
    const input=el("input",{class:"input",placeholder:"æœç´¢å…³é”®è¯ï¼ˆæ ‡é¢˜/å†…å®¹ï¼‰"},[]);
    const sel=el("select",{class:"input",style:"max-width:180px"},[
      el("option",{value:"all"},["å…¨éƒ¨ç±»å‹"]),
      el("option",{value:"good"},["æ­£å‘"]),
      el("option",{value:"warn"},["æé†’/ä¸­æ€§"]),
      el("option",{value:"bad"},["è´Ÿå‘"]),
    ]);
    filterRow.appendChild(sel); filterRow.appendChild(input);
    const list=el("div",{class:"list"},[]);
    const renderList=()=>{
      const q=(input.value||"").trim();
      const tp=sel.value;
      list.innerHTML="";
      const items=(state.archive||[]).filter(it=>{
        if(tp!=="all" && it.type!==tp) return false;
        if(!q) return true;
        return (it.text||"").includes(q);
      }).slice(0,200);
      if(!items.length){
        list.appendChild(el("div",{class:"hint"},["æš‚æ— è®°å½•ï¼ˆæˆ–ç­›é€‰æ— ç»“æœï¼‰"]));
        return;
      }
      for(const it of items){
        const meta=`Y${it.year} M${it.month} Â· ${industryMeta(it.industry).name} Â· ${it.type}`;
        list.appendChild(el("div",{class:"item"},[
          el("div",{class:"meta"},[el("div",{},[meta]), el("div",{},[it.t])]),
          el("pre",{},[it.text])
        ]));
      }
    };
    input.oninput=renderList; sel.onchange=renderList;
    renderList();
    wrap.appendChild(filterRow);
    wrap.appendChild(el("div",{class:"hr"}));
    wrap.appendChild(list);
    openOverlayBox("äº‹ä»¶å›¾é‰´ / æ–°é—»æ¡£æ¡ˆ",[
      wrap
    ],[
      el("button",{class:"btn ghost",onclick:()=>{if(confirm("æ¸…ç©ºæ¡£æ¡ˆï¼Ÿ")){state.archive=[];save();toast("å·²æ¸…ç©º"); openArchive();}}},["æ¸…ç©ºæ¡£æ¡ˆ"]),
      el("button",{class:"btn",onclick:()=>{}},["å…³é—­"])
    ]);
  };

  const loadFromPrompt=()=>{
    try{
      const raw=prompt("ç²˜è´´å­˜æ¡£JSONï¼ˆä»â€œè®¾ç½®/æ–°æ¡£â€é‡Œå¯¼å‡ºæˆ–ä½ è‡ªå·±å¤‡ä»½çš„ï¼‰");
      if(!raw) return;
      const st=JSON.parse(raw);
      if(!st||!st.company){alert("å­˜æ¡£æ ¼å¼ä¸æ­£ç¡®"); return;}
      SafeStore.set(SAVE_KEY, raw);
      location.reload();
    }catch(e){alert("è§£æå¤±è´¥ï¼š"+e.message);}
  };


  // Shell render
  const tabsEl=document.getElementById("tabs");
  const viewEl=document.getElementById("view");
  const statsEl=document.getElementById("topStats");

  const quickEl=document.getElementById("quickActions");
  const renderQuick=()=>{
    if(!quickEl) return;
    quickEl.innerHTML="";
    const mk=(ic,txt,fn)=>el("button",{class:"qbtn",onclick:fn},[el("span",{class:"ic"},[ic]), txt]);
    quickEl.appendChild(mk("â­ï¸","ä¸‹ä¸€æœˆ",()=>nextMonth()));
    quickEl.appendChild(mk("ğŸ´","æŠ½å¡",()=>{state.ui.tab="gacha";save();render();}));
    quickEl.appendChild(mk("ğŸ‘¥","å›¢é˜Ÿ",()=>{state.ui.tab="team";save();render();}));
    quickEl.appendChild(mk("ğŸŒ","è¡Œæƒ…",()=>{state.ui.tab="world";save();render();}));
    quickEl.appendChild(mk("ğŸ†š","å¯¹æ‰‹",()=>{state.ui.tab="rival";save();render();}));
    quickEl.appendChild(mk("ğŸ—ï¸","æ¡£æ¡ˆ",()=>{openArchive();}));
    quickEl.appendChild(mk("â„¹ï¸","ç‰ˆæœ¬",()=>{openChangelog();}));
    quickEl.appendChild(mk("ğŸ’¾","ä¿å­˜",()=>{save();toast("å·²ä¿å­˜åˆ°æœ¬æœº");}));
    quickEl.appendChild(mk("ğŸ“‚","è¯»å–",()=>{loadFromPrompt();}));
  };


  const renderTabs=()=>{
    tabsEl.innerHTML="";
    for(const t of TABS){
      tabsEl.appendChild(el("div",{class:`tab ${state.ui.tab===t.key?"active":""}`, onclick:()=>{state.ui.tab=t.key;save();render();}},[t.name]));
    }
  };
  const renderStats=()=>{
    statsEl.innerHTML="";
    for(const s of topStats()) statsEl.appendChild(el("div",{class:"pill"},[s]));
  };

  const renderGameOver=()=>{
    const old=document.getElementById("gameOverOverlay");
    if(old) old.remove();
    if(!state.company.gameOver) return;
    const ov=el("div",{class:"overlay",id:"gameOverOverlay"},[
      el("div",{class:"overbox"},[
        el("h3",{},["æ¸¸æˆå¤±è´¥"]),
        el("div",{class:"hint"},[
          `åŸå› ï¼š${state.company.gameOverReason}

`+
          "ä½ å¯ä»¥å»ã€è®¾ç½®/æ–°æ¡£ã€åˆ›å»ºæ–°æ¡£é‡å¼€ã€‚"
        ]),
        el("div",{class:"hr"}),
        el("div",{class:"btnrow"},[
          el("button",{class:"btn secondary", onclick:()=>{state.ui.tab="settings"; save(); render();}},["å»è®¾ç½®/æ–°æ¡£"]),
        ])
      ])
    ]);
    document.body.appendChild(ov);
  };

  const render=()=>{
    renderTabs();
    renderQuick();
    renderStats();
    viewEl.innerHTML="";

    if(state.ui.pendingDecision && !state.ui.decisionOverlayOpen){
      state.ui.decisionOverlayOpen=true;
      const ev=state.ui.pendingDecision;

      const body=el("div",{},[
        el("div",{class:"hint"},[story("warn", ev.title, ev.desc||[])]),
        el("div",{class:"hr"}),
        el("div",{class:"hint"},["è¯·é€‰æ‹©ä¸€é¡¹ï¼šä¸åŒæˆæœ¬/æ¦‚ç‡/åæœã€‚ï¼ˆæ­¤äº‹ä»¶å¿…é¡»å¤„ç†ï¼‰"])
      ]);

      const btns = (ev.options||[]).map(o=>{
        const pct=Math.round(o.p*100);
        const label=`${o.key}. ${o.label}`;
        const sub=`æˆæœ¬ ${fmtMoney(o.cost||0)}ï½œæˆåŠŸç‡ ${pct}%`;
        return el("button",{class:"btn",onclick:()=>resolveDecision(o.key)},[
          el("div",{},[label]),
          el("div",{style:"font-size:12px;color:var(--muted);font-weight:700"},[sub])
        ]);
      });

      const ov = el("div",{class:"overlay", id:"decisionOverlay"},[
        el("div",{class:"overbox"},[
          el("h3",{style:"margin:6px 0"},["å†³ç­–äº‹ä»¶"]),
          body,
          el("div",{class:"btnrow"},btns)
        ])
      ]);
      document.body.appendChild(ov);
      save();
    }

    if(state.ui.tab==="dashboard") viewEl.appendChild(viewDashboard());
    else if(state.ui.tab==="gacha") viewEl.appendChild(viewGacha());
    else if(state.ui.tab==="team") viewEl.appendChild(viewTeam());
    else if(state.ui.tab==="org") viewEl.appendChild(viewOrg());
    else if(state.ui.tab==="world") viewEl.appendChild(viewWorld());
    else if(state.ui.tab==="rival") viewEl.appendChild(viewRival());
    else if(state.ui.tab==="settings") viewEl.appendChild(viewSettings());
    else viewEl.appendChild(viewDashboard());
    renderGameOver();
  };

  render();

})();
</script>

  <div id="ceremonyModal" class="modalFull">
    <div class="ceremony">
      <div id="burst" class="burst"></div>
      <div id="confetti" class="confetti"></div>
      <div class="top">
        <div>
          <div class="name" id="cerName">æ‹›å‹ŸæˆåŠŸ</div>
          <div class="mini" id="cerSub"> </div>
        </div>
        <button class="btn" id="cerClose">å…³é—­</button>
      </div>
      <div class="body">
        <div class="bigAvatar" id="cerAvatar"></div>
        <div id="cerText" class="mini"></div>
      </div>
    </div>
  </div>

</body>
</html>

  // V2.7ï¼šå†…ç½®å¤´åƒå›¾åº“ï¼ˆ24ä¸ªAIé£SVG + 6ä¸ªå›¾æ ‡é£ï¼‰
  const AVATAR_LIBRARY = (() => {
    const colors = [
      ["#5bc0ff","#1b2a6b"],["#ffd166","#3b2a0b"],["#58e3a5","#0b3b2a"],["#ff6b6b","#3b0b0b"],
      ["#b388ff","#2b0b3b"],["#7aa2ff","#0b1a3b"],["#ff9f1c","#3b1e0b"],["#00d4ff","#0b2c3b"],
    ];
    const mkSvg = (seed) => {
      const c = colors[seed % colors.length];
      const a = (seed*37)%100, b=(seed*91)%100;
      return `<svg class="svg" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="g${seed}" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="${c[0]}" stop-opacity=".95"/>
            <stop offset="1" stop-color="${c[1]}" stop-opacity=".95"/>
          </linearGradient>
          <filter id="f${seed}" x="-20%" y="-20%" width="140%" height="140%">
            <feGaussianBlur stdDeviation="1.6"/>
          </filter>
        </defs>
        <rect width="120" height="120" rx="22" fill="url(#g${seed})"/>
        <circle cx="${30+a*0.6}" cy="${34+b*0.4}" r="24" fill="rgba(255,255,255,.22)" filter="url(#f${seed})"/>
        <circle cx="${78-b*0.4}" cy="${76+a*0.3}" r="28" fill="rgba(255,255,255,.18)" filter="url(#f${seed})"/>
        <path d="M30 92c8-18 52-18 60 0" stroke="rgba(255,255,255,.65)" stroke-width="8" stroke-linecap="round" fill="none"/>
        <circle cx="46" cy="56" r="6" fill="rgba(255,255,255,.8)"/>
        <circle cx="74" cy="56" r="6" fill="rgba(255,255,255,.8)"/>
      </svg>`;
    };
    const ai = Array.from({length:24}, (_,i)=>({id:`ai_${i}`, type:"svg", data:mkSvg(i)}));
    const icons = ["ğŸ¢","ğŸ§ ","ğŸ¦Š","ğŸ¼","ğŸ¦","ğŸ¯"].map((t,i)=>({id:`ic_${i}`, type:"text", data:t}));
    return [...ai, ...icons];
  })();

  const renderAvatarFromLib = (entry)=>{
    if(!entry) return el("div",{},["ğŸ™‚"]);
    if(entry.type==="text") return el("div",{style:"font-size:46px"},[entry.data]);
    // svg string
    const box=document.createElement("div");
    box.innerHTML=entry.data;
    return box.firstElementChild;
  };

  const pickAvatarLib = ()=> pick(AVATAR_LIBRARY);
